var os=Object.create;var Ge=Object.defineProperty,is=Object.defineProperties,as=Object.getOwnPropertyDescriptor,ls=Object.getOwnPropertyDescriptors,us=Object.getOwnPropertyNames,fr=Object.getOwnPropertySymbols,cs=Object.getPrototypeOf,br=Object.prototype.hasOwnProperty,ps=Object.prototype.propertyIsEnumerable;var yr=(t,e,r)=>e in t?Ge(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,oe=(t,e)=>{for(var r in e||(e={}))br.call(e,r)&&yr(t,r,e[r]);if(fr)for(var r of fr(e))ps.call(e,r)&&yr(t,r,e[r]);return t},ie=(t,e)=>is(t,ls(e));var Tr=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),G=(t,e)=>{for(var r in e)Ge(t,r,{get:e[r],enumerable:!0})},ms=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of us(e))!br.call(t,s)&&s!==r&&Ge(t,s,{get:()=>e[s],enumerable:!(n=as(e,s))||n.enumerable});return t};var ze=(t,e,r)=>(r=t!=null?os(cs(t)):{},ms(e||!t||!t.__esModule?Ge(r,"default",{value:t,enumerable:!0}):r,t));var Pt=Tr((Rr,tt)=>{(function(t,e){typeof tt=="object"&&tt.exports?tt.exports=e():t.nearley=e()})(Rr,function(){function t(i,a,c){return this.id=++t.highestId,this.name=i,this.symbols=a,this.postprocess=c,this}t.highestId=0,t.prototype.toString=function(i){var a=typeof i=="undefined"?this.symbols.map(u).join(" "):this.symbols.slice(0,i).map(u).join(" ")+" \u25CF "+this.symbols.slice(i).map(u).join(" ");return this.name+" \u2192 "+a};function e(i,a,c,m){this.rule=i,this.dot=a,this.reference=c,this.data=[],this.wantedBy=m,this.isComplete=this.dot===i.symbols.length}e.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},e.prototype.nextState=function(i){var a=new e(this.rule,this.dot+1,this.reference,this.wantedBy);return a.left=this,a.right=i,a.isComplete&&(a.data=a.build(),a.right=void 0),a},e.prototype.build=function(){var i=[],a=this;do i.push(a.right.data),a=a.left;while(a.left);return i.reverse(),i},e.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,o.fail))};function r(i,a){this.grammar=i,this.index=a,this.states=[],this.wants={},this.scannable=[],this.completed={}}r.prototype.process=function(i){for(var a=this.states,c=this.wants,m=this.completed,g=0;g<a.length;g++){var d=a[g];if(d.isComplete){if(d.finish(),d.data!==o.fail){for(var f=d.wantedBy,y=f.length;y--;){var v=f[y];this.complete(v,d)}if(d.reference===this.index){var x=d.rule.name;(this.completed[x]=this.completed[x]||[]).push(d)}}}else{var x=d.rule.symbols[d.dot];if(typeof x!="string"){this.scannable.push(d);continue}if(c[x]){if(c[x].push(d),m.hasOwnProperty(x))for(var R=m[x],y=0;y<R.length;y++){var C=R[y];this.complete(d,C)}}else c[x]=[d],this.predict(x)}}},r.prototype.predict=function(i){for(var a=this.grammar.byName[i]||[],c=0;c<a.length;c++){var m=a[c],g=this.wants[i],d=new e(m,0,this.index,g);this.states.push(d)}},r.prototype.complete=function(i,a){var c=i.nextState(a);this.states.push(c)};function n(i,a){this.rules=i,this.start=a||this.rules[0].name;var c=this.byName={};this.rules.forEach(function(m){c.hasOwnProperty(m.name)||(c[m.name]=[]),c[m.name].push(m)})}n.fromCompiled=function(m,a){var c=m.Lexer;m.ParserStart&&(a=m.ParserStart,m=m.ParserRules);var m=m.map(function(d){return new t(d.name,d.symbols,d.postprocess)}),g=new n(m,a);return g.lexer=c,g};function s(){this.reset("")}s.prototype.reset=function(i,a){this.buffer=i,this.index=0,this.line=a?a.line:1,this.lastLineBreak=a?-a.col:0},s.prototype.next=function(){if(this.index<this.buffer.length){var i=this.buffer[this.index++];return i===`
`&&(this.line+=1,this.lastLineBreak=this.index),{value:i}}},s.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},s.prototype.formatError=function(i,a){var c=this.buffer;if(typeof c=="string"){var m=c.split(`
`).slice(Math.max(0,this.line-5),this.line),g=c.indexOf(`
`,this.index);g===-1&&(g=c.length);var d=this.index-this.lastLineBreak,f=String(this.line).length;return a+=" at line "+this.line+" col "+d+`:

`,a+=m.map(function(v,x){return y(this.line-m.length+x+1,f)+" "+v},this).join(`
`),a+=`
`+y("",f+d)+`^
`,a}else return a+" at index "+(this.index-1);function y(v,x){var R=String(v);return Array(x-R.length+1).join(" ")+R}};function o(i,a,c){if(i instanceof n)var m=i,c=a;else var m=n.fromCompiled(i,a);this.grammar=m,this.options={keepHistory:!1,lexer:m.lexer||new s};for(var g in c||{})this.options[g]=c[g];this.lexer=this.options.lexer,this.lexerState=void 0;var d=new r(m,0),f=this.table=[d];d.wants[m.start]=[],d.predict(m.start),d.process(),this.current=0}o.fail={},o.prototype.feed=function(i){var a=this.lexer;a.reset(i,this.lexerState);for(var c;;){try{if(c=a.next(),!c)break}catch(D){var f=new r(this.grammar,this.current+1);this.table.push(f);var m=new Error(this.reportLexerError(D));throw m.offset=this.current,m.token=D.token,m}var g=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var d=this.current+1,f=new r(this.grammar,d);this.table.push(f);for(var y=c.text!==void 0?c.text:c.value,v=a.constructor===s?c.value:c,x=g.scannable,R=x.length;R--;){var C=x[R],I=C.rule.symbols[C.dot];if(I.test?I.test(v):I.type?I.type===c.type:I.literal===y){var O=C.nextState({data:v,token:c,isToken:!0,reference:d-1});f.states.push(O)}}if(f.process(),f.states.length===0){var m=new Error(this.reportError(c));throw m.offset=this.current,m.token=c,m}this.options.keepHistory&&(g.lexerState=a.save()),this.current++}return g&&(this.lexerState=a.save()),this.results=this.finish(),this},o.prototype.reportLexerError=function(i){var a,c,m=i.token;return m?(a="input "+JSON.stringify(m.text[0])+" (lexer error)",c=this.lexer.formatError(m,"Syntax error")):(a="input (lexer error)",c=i.message),this.reportErrorCommon(c,a)},o.prototype.reportError=function(i){var a=(i.type?i.type+" token: ":"")+JSON.stringify(i.value!==void 0?i.value:i),c=this.lexer.formatError(i,"Syntax error");return this.reportErrorCommon(c,a)},o.prototype.reportErrorCommon=function(i,a){var c=[];c.push(i);var m=this.table.length-2,g=this.table[m],d=g.states.filter(function(y){var v=y.rule.symbols[y.dot];return v&&typeof v!="string"});if(d.length===0)c.push("Unexpected "+a+`. I did not expect any more input. Here is the state of my parse table:
`),this.displayStateStack(g.states,c);else{c.push("Unexpected "+a+`. Instead, I was expecting to see one of the following:
`);var f=d.map(function(y){return this.buildFirstStateStack(y,[])||[y]},this);f.forEach(function(y){var v=y[0],x=v.rule.symbols[v.dot],R=this.getSymbolDisplay(x);c.push("A "+R+" based on:"),this.displayStateStack(y,c)},this)}return c.push(""),c.join(`
`)},o.prototype.displayStateStack=function(i,a){for(var c,m=0,g=0;g<i.length;g++){var d=i[g],f=d.rule.toString(d.dot);f===c?m++:(m>0&&a.push("    ^ "+m+" more lines identical to this"),m=0,a.push("    "+f)),c=f}},o.prototype.getSymbolDisplay=function(i){return l(i)},o.prototype.buildFirstStateStack=function(i,a){if(a.indexOf(i)!==-1)return null;if(i.wantedBy.length===0)return[i];var c=i.wantedBy[0],m=[i].concat(a),g=this.buildFirstStateStack(c,m);return g===null?null:[i].concat(g)},o.prototype.save=function(){var i=this.table[this.current];return i.lexerState=this.lexerState,i},o.prototype.restore=function(i){var a=i.index;this.current=a,this.table[a]=i,this.table.splice(a+1),this.lexerState=i.lexerState,this.results=this.finish()},o.prototype.rewind=function(i){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[i])},o.prototype.finish=function(){var i=[],a=this.grammar.start,c=this.table[this.table.length-1];return c.states.forEach(function(m){m.rule.name===a&&m.dot===m.rule.symbols.length&&m.reference===0&&m.data!==o.fail&&i.push(m)}),i.map(function(m){return m.data})};function l(i){var a=typeof i;if(a==="string")return i;if(a==="object"){if(i.literal)return JSON.stringify(i.literal);if(i instanceof RegExp)return"character matching "+i;if(i.type)return i.type+" token";if(i.test)return"token matching "+String(i.test);throw new Error("Unknown symbol type: "+i)}}function u(i){var a=typeof i;if(a==="string")return i;if(a==="object"){if(i.literal)return JSON.stringify(i.literal);if(i instanceof RegExp)return i.toString();if(i.type)return"%"+i.type;if(i.test)return"<"+String(i.test)+">";throw new Error("Unknown symbol type: "+i)}}return{Parser:o,Grammar:n,Rule:t}})});var Lt=Tr((Ir,rt)=>{(function(t,e){typeof define=="function"&&define.amd?define([],e):typeof rt=="object"&&rt.exports?rt.exports=e():t.moo=e()})(Ir,function(){"use strict";var t=Object.prototype.hasOwnProperty,e=Object.prototype.toString,r=typeof new RegExp().sticky=="boolean";function n(p){return p&&e.call(p)==="[object RegExp]"}function s(p){return p&&typeof p=="object"&&!n(p)&&!Array.isArray(p)}function o(p){return p.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function l(p){var h=new RegExp("|"+p);return h.exec("").length-1}function u(p){return"("+p+")"}function i(p){if(!p.length)return"(?!)";var h=p.map(function(b){return"(?:"+b+")"}).join("|");return"(?:"+h+")"}function a(p){if(typeof p=="string")return"(?:"+o(p)+")";if(n(p)){if(p.ignoreCase)throw new Error("RegExp /i flag not allowed");if(p.global)throw new Error("RegExp /g flag is implied");if(p.sticky)throw new Error("RegExp /y flag is implied");if(p.multiline)throw new Error("RegExp /m flag is implied");return p.source}else throw new Error("Not a pattern: "+p)}function c(p,h){return p.length>h?p:Array(h-p.length+1).join(" ")+p}function m(p,h){for(var b=p.length,T=0;;){var A=p.lastIndexOf(`
`,b-1);if(A===-1||(T++,b=A,T===h)||b===0)break}var k=T<h?0:b+1;return p.substring(k).split(`
`)}function g(p){for(var h=Object.getOwnPropertyNames(p),b=[],T=0;T<h.length;T++){var A=h[T],k=p[A],F=[].concat(k);if(A==="include"){for(var B=0;B<F.length;B++)b.push({include:F[B]});continue}var w=[];F.forEach(function(S){s(S)?(w.length&&b.push(f(A,w)),b.push(f(A,S)),w=[]):w.push(S)}),w.length&&b.push(f(A,w))}return b}function d(p){for(var h=[],b=0;b<p.length;b++){var T=p[b];if(T.include){for(var A=[].concat(T.include),k=0;k<A.length;k++)h.push({include:A[k]});continue}if(!T.type)throw new Error("Rule has no type: "+JSON.stringify(T));h.push(f(T.type,T))}return h}function f(p,h){if(s(h)||(h={match:h}),h.include)throw new Error("Matching rules cannot also include states");var b={defaultType:p,lineBreaks:!!h.error||!!h.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var T in h)t.call(h,T)&&(b[T]=h[T]);if(typeof b.type=="string"&&p!==b.type)throw new Error("Type transform cannot be a string (type '"+b.type+"' for token '"+p+"')");var A=b.match;return b.match=Array.isArray(A)?A:A?[A]:[],b.match.sort(function(k,F){return n(k)&&n(F)?0:n(F)?-1:n(k)?1:F.length-k.length}),b}function y(p){return Array.isArray(p)?d(p):g(p)}var v=f("error",{lineBreaks:!0,shouldThrow:!0});function x(p,h){for(var b=null,T=Object.create(null),A=!0,k=null,F=[],B=[],w=0;w<p.length;w++)p[w].fallback&&(A=!1);for(var w=0;w<p.length;w++){var S=p[w];if(S.include)throw new Error("Inheritance is not allowed in stateless lexers");if(S.error||S.fallback){if(b)throw!S.fallback==!b.fallback?new Error("Multiple "+(S.fallback?"fallback":"error")+" rules not allowed (for token '"+S.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+S.defaultType+"')");b=S}var M=S.match.slice();if(A)for(;M.length&&typeof M[0]=="string"&&M[0].length===1;){var re=M.shift();T[re.charCodeAt(0)]=S}if(S.pop||S.push||S.next){if(!h)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+S.defaultType+"')");if(S.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+S.defaultType+"')")}if(M.length!==0){A=!1,F.push(S);for(var ne=0;ne<M.length;ne++){var se=M[ne];if(n(se)){if(k===null)k=se.unicode;else if(k!==se.unicode&&S.fallback===!1)throw new Error("If one rule is /u then all must be")}}var he=i(M.map(a)),V=new RegExp(he);if(V.test(""))throw new Error("RegExp matches empty string: "+V);var we=l(he);if(we>0)throw new Error("RegExp has capture groups: "+V+`
Use (?: \u2026 ) instead`);if(!S.lineBreaks&&V.test(`
`))throw new Error("Rule should declare lineBreaks: "+V);B.push(u(he))}}var fe=b&&b.fallback,Re=r&&!fe?"ym":"gm",_e=r||fe?"":"|";k===!0&&(Re+="u");var ss=new RegExp(i(B)+_e,Re);return{regexp:ss,groups:F,fast:T,error:b||v}}function R(p){var h=x(y(p));return new D({start:h},"start")}function C(p,h,b){var T=p&&(p.push||p.next);if(T&&!b[T])throw new Error("Missing state '"+T+"' (in token '"+p.defaultType+"' of state '"+h+"')");if(p&&p.pop&&+p.pop!=1)throw new Error("pop must be 1 (in token '"+p.defaultType+"' of state '"+h+"')")}function I(p,h){var b=p.$all?y(p.$all):[];delete p.$all;var T=Object.getOwnPropertyNames(p);h||(h=T[0]);for(var A=Object.create(null),k=0;k<T.length;k++){var F=T[k];A[F]=y(p[F]).concat(b)}for(var k=0;k<T.length;k++)for(var F=T[k],B=A[F],w=Object.create(null),S=0;S<B.length;S++){var M=B[S];if(M.include){var re=[S,1];if(M.include!==F&&!w[M.include]){w[M.include]=!0;var ne=A[M.include];if(!ne)throw new Error("Cannot include nonexistent state '"+M.include+"' (in state '"+F+"')");for(var se=0;se<ne.length;se++){var he=ne[se];B.indexOf(he)===-1&&re.push(he)}}B.splice.apply(B,re),S--}}for(var V=Object.create(null),k=0;k<T.length;k++){var F=T[k];V[F]=x(A[F],!0)}for(var k=0;k<T.length;k++){for(var we=T[k],fe=V[we],Re=fe.groups,S=0;S<Re.length;S++)C(Re[S],we,V);for(var _e=Object.getOwnPropertyNames(fe.fast),S=0;S<_e.length;S++)C(fe.fast[_e[S]],we,V)}return new D(V,h)}function O(p){for(var h=typeof Map!="undefined",b=h?new Map:Object.create(null),T=Object.getOwnPropertyNames(p),A=0;A<T.length;A++){var k=T[A],F=p[k],B=Array.isArray(F)?F:[F];B.forEach(function(w){if(typeof w!="string")throw new Error("keyword must be string (in keyword '"+k+"')");h?b.set(w,k):b[w]=k})}return function(w){return h?b.get(w):b[w]}}var D=function(p,h){this.startState=h,this.states=p,this.buffer="",this.stack=[],this.reset()};D.prototype.reset=function(p,h){return this.buffer=p||"",this.index=0,this.line=h?h.line:1,this.col=h?h.col:1,this.queuedToken=h?h.queuedToken:null,this.queuedText=h?h.queuedText:"",this.queuedThrow=h?h.queuedThrow:null,this.setState(h?h.state:this.startState),this.stack=h&&h.stack?h.stack.slice():[],this},D.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},D.prototype.setState=function(p){if(!(!p||this.state===p)){this.state=p;var h=this.states[p];this.groups=h.groups,this.error=h.error,this.re=h.regexp,this.fast=h.fast}},D.prototype.popState=function(){this.setState(this.stack.pop())},D.prototype.pushState=function(p){this.stack.push(this.state),this.setState(p)};var W=r?function(p,h){return p.exec(h)}:function(p,h){var b=p.exec(h);return b[0].length===0?null:b};D.prototype._getGroup=function(p){for(var h=this.groups.length,b=0;b<h;b++)if(p[b+1]!==void 0)return this.groups[b];throw new Error("Cannot find token type for matched text")};function Fe(){return this.value}if(D.prototype.next=function(){var p=this.index;if(this.queuedGroup){var h=this._token(this.queuedGroup,this.queuedText,p);return this.queuedGroup=null,this.queuedText="",h}var b=this.buffer;if(p!==b.length){var F=this.fast[b.charCodeAt(p)];if(F)return this._token(F,b.charAt(p),p);var T=this.re;T.lastIndex=p;var A=W(T,b),k=this.error;if(A==null)return this._token(k,b.slice(p,b.length),p);var F=this._getGroup(A),B=A[0];return k.fallback&&A.index!==p?(this.queuedGroup=F,this.queuedText=B,this._token(k,b.slice(p,A.index),p)):this._token(F,B,p)}},D.prototype._token=function(p,h,b){var T=0;if(p.lineBreaks){var A=/\n/g,k=1;if(h===`
`)T=1;else for(;A.exec(h);)T++,k=A.lastIndex}var F={type:typeof p.type=="function"&&p.type(h)||p.defaultType,value:typeof p.value=="function"?p.value(h):h,text:h,toString:Fe,offset:b,lineBreaks:T,line:this.line,col:this.col},B=h.length;if(this.index+=B,this.line+=T,T!==0?this.col=B-k+1:this.col+=B,p.shouldThrow){var w=new Error(this.formatError(F,"invalid syntax"));throw w}return p.pop?this.popState():p.push?this.pushState(p.push):p.next&&this.setState(p.next),F},typeof Symbol!="undefined"&&Symbol.iterator){var te=function(p){this.lexer=p};te.prototype.next=function(){var p=this.lexer.next();return{value:p,done:!p}},te.prototype[Symbol.iterator]=function(){return this},D.prototype[Symbol.iterator]=function(){return new te(this)}}return D.prototype.formatError=function(p,h){if(p==null)var b=this.buffer.slice(this.index),p={text:b,offset:this.index,lineBreaks:b.indexOf(`
`)===-1?0:1,line:this.line,col:this.col};var T=2,A=Math.max(p.line-T,1),k=p.line+T,F=String(k).length,B=m(this.buffer,this.line-p.line+T+1).slice(0,5),w=[];w.push(h+" at line "+p.line+" col "+p.col+":"),w.push("");for(var S=0;S<B.length;S++){var M=B[S],re=A+S;w.push(c(String(re),F)+"  "+M),re===p.line&&w.push(c("",F+p.col+1)+"^")}return w.join(`
`)},D.prototype.clone=function(){return new D(this.states,this.state)},D.prototype.has=function(p){return!0},{compile:R,states:I,error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:O}})});var j=class{constructor(e){this.storage=e}set(e,r){this.storage.set(e,r)}get(e,r){var n;return(n=this.storage.get(e))!=null?n:r}has(e){return this.storage.has(e)}fold(e,r,n){let s=r(this.get(e,n));return this.set(e,s),s}post(e,r,n){let s=this.get(e,n);return this.set(e,r(s)),s}lazy(e,r){var n;return(n=this.get(e,null))!=null?n:this.fold(e,r,null)}over(e,r,n){let s=this.get(e,n);return this.set(e,s),r(s)}delete(e){this.storage.delete(e)}clear(){this.storage.clear()}};var xr=(t,e)=>({ready:e,result:t,parse:!1}),ds=t=>xr(t,!0),gs=(t,e)=>xr(t,e),hs=(t,e)=>gs(t.toReprString(),e.ready),fs={ready:!1,result:[],parse:!1},ys=t=>{var e,r,n;switch(typeof t){case"string":return ds(t);case"object":return{ready:(e=t.ready)!=null?e:!0,result:(r=t.result)!=null?r:[],parse:(n=t.parse)!=null?n:!1};default:return fs}},We=class{constructor(){this.filters=new Map}register(e,r){this.filters.set(e,r)}has(e){return this.filters.has(e)}get(e){var r;return(r=this.filters.get(e))!=null?r:null}getOrDefault(e){var r;return(r=this.get(e))!=null?r:hs}unregisterFilter(e){this.filters.delete(e)}clearFilters(){this.filters.clear()}execute(e,r,n){let s=this.getOrDefault(e);return ys(s(r,n))}};var Et=t=>(t+1>>>1)-1,Ve=t=>(t<<1)+1,Ee=t=>t+1<<1,He=class{constructor(e){this._heap=[],this._comparator=e}greater(e,r){return this._comparator(this._heap[e],this._heap[r])}swap(e,r){[this._heap[e],this._heap[r]]=[this._heap[r],this._heap[e]]}siftUp(){let e=this.size()-1;for(;e>0&&this.greater(e,Et(e));)this.swap(e,Et(e)),e=Et(e)}siftDown(){let e=0;for(;Ve(e)<this.size()&&this.greater(Ve(e),e)||Ee(e)<this.size()&&this.greater(Ee(e),e);){let r=Ee(e)<this.size()&&this.greater(Ee(e),Ve(e))?Ee(e):Ve(e);this.swap(e,r),e=r}}size(){return this._heap.length}isEmpty(){return this.size()===0}peek(){return this._heap[0]}push(...e){return e.forEach(r=>{this._heap.push(r),this.siftUp()}),this.size()}pop(){let e=this.peek(),r=this.size()-1;return r>0&&this.swap(0,r),this._heap.pop(),this.siftDown(),e}*generate(){let e=this.pop();for(;e;)yield e,e=this.pop();return null}};var Ue={priority:0,persistent:!1},bs=(t,e)=>t.priority>e.priority,Ne=class{constructor(){this._deferred=new Map,this._blocked=new Set}register(e,r,n=Ue){var s,o;this._deferred.set(e,{keyword:e,procedure:r,priority:(s=n.priority)!=null?s:Ue.priority,persistent:(o=n.persistent)!=null?o:Ue.persistent})}registerIfNotExists(e,r,n=Ue){this.isRegistered(e)||this.register(e,r,n)}unregister(e){this._deferred.delete(e)}isRegistered(e){return this._deferred.has(e)}block(e){this._blocked.add(e)}unblock(e){this._blocked.delete(e)}isBlocked(e){return this._blocked.has(e)}clear(){this._deferred.clear(),this._blocked.clear()}executeEach(e){let r=new He(bs);r.push(...this._deferred.values());for(let n of r.generate())this.isBlocked(n.keyword)||n.procedure(n,e),n.persistent||this.unregister(n.keyword);this._blocked.clear()}};var qe=class{constructor(e,r){this.filters=e,this.options=r}register(e,r,n={}){this.filters.register(e,r),this.options.set(e,n)}getOptions(e){return this.options.get(e,{})}};var je=class{constructor(e,r,n,s,o,l,u,i){this.preset=e,this.filters=r,this.options=n,this.registrar=new qe(r,n),this.deferred=s,this.aftermath=o,this.cache=l,this.memory=u,this.environment=i}getBaseInternals(e){return Object.assign({},{filters:this.filters,options:this.options,registrar:this.registrar,cache:this.cache,memory:this.memory,environment:this.environment,deferred:this.deferred,aftermath:this.aftermath,preset:this.preset},e)}getAftermathInternals(e,r){return Object.assign(this.getBaseInternals(e),r)}getDeferredInternals(e,r){return Object.assign(this.getBaseInternals(e),r)}getInternals(e,r,n){return Object.assign(this.getDeferredInternals(e,r),n)}filterAccessor(e,r){return{getProcessor:n=>({execute:(s,o)=>this.filters.execute(n,s,this.getInternals(e,r,o)),getOptions:()=>this.options.get(n,{})})}}executeDeferred(e,r){let n=this.getDeferredInternals(e,r);this.deferred.executeEach(n)}executeAftermath(e,r){let n=this.getAftermathInternals(e,r);this.aftermath.executeEach(n)}switchPreset(e){this.preset=e}clear(){this.memory.clear(),this.aftermath.clear()}reset(){this.cache.clear(),this.deferred.clear()}install(...e){for(let r of e)r(this.registrar)}};var xs=t=>({status:t.parse?t.ready?2:3:t.ready?0:1,result:t.result}),vs=t=>{var r,n,s,o;let e=(r=t.optics)!=null?r:[];return{inlineOptics:(n=t.inlineOptics)!=null?n:e,blockOptics:(s=t.blockOptics)!=null?s:e,capture:(o=t.capture)!=null?o:!1}},Nt="_ankingEnvironment",vr=class t extends je{static make(e={},r=new Map){let n=Object.prototype.hasOwnProperty.call(globalThis,Nt)?globalThis[Nt]:globalThis[Nt]=new Map;return new t(e,new We,new j(new Map),new Ne,new Ne,new j(new Map),new j(r),new j(n))}makeAccessor(e,r){let n=this.filterAccessor(e,r);return s=>{let o=n.getProcessor(s);return{execute:(l,u)=>xs(o.execute(l,super.getInternals(e,r,u))),getOptions:()=>vs(o.getOptions())}}}finishIteration(e,r){this.executeDeferred(e,r)}finishRun(e,r){this.executeAftermath(e,r),this.reset()}};var Ut={};G(Ut,{BrowserTemplate:()=>pe,Parser:()=>xe,TagSelector:()=>Q,Template:()=>ve,anki:()=>ut,browser:()=>ot,optics:()=>Ye});var $=t=>t,Ke=(t,e)=>e,ye=t=>e=>t;var kr=t=>{let e=t.slice(0),r=t.length;for(;r!==0;){let n=Math.floor(Math.random()*r);r-=1;let s=e[r];e[r]=e[n],e[n]=s}return e},Xe=(t,e)=>{let r=[];for(let n of e){let s=t[n];s&&r.push(s)}if(e.length<t.length){let n=Array.from(new Array(t.length-e.length),(s,o)=>o+e.length);for(let s of n)r.push(t[s])}return r};var Ye={};G(Ye,{dictForget:()=>Ce,dictFunction:()=>Ie,mapped:()=>_,run:()=>ae,separated:()=>E,stripped:()=>Ar,strippedRegex:()=>Dt,templated:()=>Sr,templatedRegex:()=>Ct});var ae=(t,e,r)=>t.reverse().reduce((n,s)=>s(e,n),r);var ks=(t,e,r)=>n=>e(r(t(n))),Ss=t=>([e,r])=>[t(e),r],As=t=>([e,r])=>e?[e,t(r)]:[e,r],Ie={classes:[1,0,2],dimap:ks,first:Ss,right:As},Fs=(t,e)=>r=>e(t(r)),ws=(t,e,r)=>Fs(t,r),Rs=t=>([e])=>t(e),Es=t=>([e,r])=>e?t(r):[],Ce={classes:[3,1,0,2],dimap:ws,first:Rs,right:Es};var Ns=t=>{var e,r,n,s;return typeof t=="string"?{sep:t,max:1/0,trim:!1,keepEmpty:!0}:{sep:(e=t.sep)!=null?e:"::",max:(r=t.max)!=null?r:1/0,trim:(n=t.trim)!=null?n:!1,keepEmpty:(s=t.keepEmpty)!=null?s:!0}},E=t=>{let{sep:e,max:r,trim:n,keepEmpty:s}=Ns(t),o=u=>{let i=[],a=u,c=!1;for(;!c;){let m=a.indexOf(e),[g,d,f]=m<0||i.length+1===r?[a,"",!0]:[a.slice(0,m),a.slice(m+e.length),!1],y=n?g.trim():g;(s||y.length>=1)&&i.push(y),a=d,c=f}return[i]},l=([u])=>u;return(u,i)=>{let a=u.first(i);return u.dimap(o,l,a)}};var Je=t=>{var e,r;return typeof t=="string"?{before:t,after:t}:{before:(e=t.before)!=null?e:"",after:(r=t.after)!=null?r:""}};var be=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),It=t=>t instanceof RegExp?t.source:t;var Is=(t,e)=>r=>{let n=r[r.length-1]||{},s=[t[0]];return e.forEach((o,l)=>{let u=Number.isInteger(o)?r[o]:n[o];s.push(u,t[l+1])}),s.join("")},Ct=t=>{let{before:e,after:r}=Je(t),n=o=>{let l=new RegExp(`(${e})(.*?)(${r})`,"gsu"),u=[],i=[],a=0;o.replace(l,(g,d,f,y,v)=>{let x=o.substring(a,v+d.length);return u.push(x),i.push(f),a=v+g.length-y.length,""}),u.push(o.substring(a));let c=[...Array(i.length).keys()],m=Is(u,c);return[i,m]},s=([o,l])=>l(o);return(o,l)=>{let u=o.first(l);return o.dimap(n,s,u)}},Sr=({before:t,after:e})=>Ct({before:be(t),after:be(e)});var Dt=t=>{let{before:e,after:r}=Je(t),n=o=>{let l=new RegExp(`^${It(e)}(.*?)${It(r)}$`,"su"),u=o;return o.replace(l,(i,a)=>(u=a,"")),[u,null]},s=([o])=>o;return(o,l)=>{let u=o.first(l);return o.dimap(n,s,u)}},Ar=({before:t,after:e})=>Dt({before:`^${be(t)}`,after:`${be(e)}$`});var Cs=t=>e=>e.map(t),_=()=>(t,e)=>Cs(e);var Bt=(t,e)=>t&&e.isReady(),Fr=t=>t.map(e=>e.toString()).join(""),wr=t=>t.map(e=>e.toReprString()).join(""),Ds=/^(?:<br(?: ?\/)?>|\n)|(?:<br(?: ?\/)?>|\n)$/gu,Bs=t=>t.replace(Ds,""),Qe=class{constructor(e,r,n,s,o,l,u,i,a,c){this._inlineOptics=[];this._inlineGetter=$;this._blockOptics=[];this._blockGetter=$;this.fullKey=e,this.key=r,this.num=n,this.fullOccur=s,this.occur=o,this.delimiters=l,this._inlineNodes=u,this.hasInline=i,this._blockNodes=a,this.hasBlock=c}get inlineNodes(){return this._inlineNodes}get blockNodes(){return this._blockNodes}get innerNodes(){return this.hasBlock?this.blockNodes:this.inlineNodes}set internalNodes(e){this.hasBlock?this._blockNodes=e:this._inlineNodes=e}get inlineText(){return Fr(this.inlineNodes)}get blockText(){return Bs(Fr(this.blockNodes))}get text(){return this.hasBlock?this.blockText:this.inlineText}set inlineOptics(e){this._inlineOptics=e,this._inlineGetter=ae(e,Ce,$)}get inlineOptics(){return this._inlineOptics}set blockOptics(e){this._blockOptics=e,this._blockGetter=ae(e,Ce,$)}get blockOptics(){return this._blockOptics}set optics(e){this.hasBlock?this.blockOptics=e:this.inlineOptics=e}get optics(){return this.hasBlock?this.blockOptics:this.inlineOptics}get inlineGetter(){return this._inlineGetter}get blockGetter(){return this._blockGetter}get getter(){return this.hasBlock?this.blockGetter:this.inlineGetter}get inlineValues(){return this.inlineGetter(this.inlineText)}get blockValues(){return this.blockGetter(this.blockText)}get values(){return this.hasBlock?this.blockValues:this.inlineValues}inlineTraverse(e){return ae(this.inlineOptics,Ie,e)(this.inlineText)}blockTraverse(e){return ae(this.blockOptics,Ie,e)(this.blockText)}traverse(e){return this.hasBlock?this.blockTraverse(e):this.inlineTraverse(e)}wrapWithDelimiters(e,r){return`${this.delimiters.open}${e}${this.fullKey}${r?this.delimiters.sep+r:""}${this.delimiters.close}`}wrapBlock(e,r){return`${this.wrapWithDelimiters("#",r)}${e}${this.wrapWithDelimiters("/")}`}baseToString(e,r){return this.hasInline?this.hasBlock?this.wrapBlock(r(),e()):this.wrapWithDelimiters("",e()):this.hasBlock?this.wrapBlock(r()):this.wrapWithDelimiters("")}toString(){return this.baseToString(()=>this.inlineText,()=>this.blockText)}toReprString(){return this.baseToString(()=>wr(this.inlineNodes),()=>wr(this.blockNodes))}isReady(){return!1}evaluate(e,r,n,s=!1){let o=r(this.key),l=n.length-1,u=o.getOptions().capture,i=(y,v)=>y.evaluate(e,r,[...n,v]),a=!u&&!s,c=u&&!s;a&&this.innerNodes.splice(0,this.innerNodes.length,...this.innerNodes.flatMap(i));let m=this.innerNodes.reduce(Bt,!0);this.inlineOptics=o.getOptions().inlineOptics,this.blockOptics=o.getOptions().blockOptics;let g={path:n,depth:l,ready:m,isCapture:c},d=o.execute(this,g),f;switch(d.status){case 0:f=typeof d.result=="string"?[new le(d.result)]:d.result;break;case 1:f=c?this.innerNodes:[this];break;case 2:f=e.rawParse(d.result).flatMap(i);break;case 3:f=e.rawParse(d.result);break}return c?(this.internalNodes=f,this.evaluate(e,r,n,!0)):f}},De=class{isReady(){return!0}evaluate(){return[this]}toReprString(){var e;return(e=this.toString())!=null?e:""}},le=class extends De{constructor(r){super();this.text=r}toString(){return this.text}},Ze=class extends De{constructor(r){super();this.escaped=r}toString(){return this.escaped.length===1?this.escaped:this.escaped.slice(1)}toReprString(){return this.escaped}},et=class extends De{toString(){return null}};var Be=ze(Pt());var K=/^((?:[a-zA-Z_/]|%\w)+)(\d*)(?::(\d+))?$/u,Er=(t,e)=>{var n;let r=((n=t.get(e))!=null?n:-1)+1;return t.set(e,r),r},$t=class{constructor(){this.tagCounter=null;this.tagCounterFull=null;this.delimiters=null}increment(e,r){return[Er(this.tagCounterFull,e),Er(this.tagCounter,r)]}build(e,r,n,s=[],o=!1){let l=e.match(K);if(!l)throw new Error("Could not match key. This should never happen.");let u=l[1],i=l[2].length>0?Number(l[2]):null,[a,c]=this.increment(e,u);return new Qe(e,u,i,a,c,this.delimiters,r,n,s,o)}push(e,r){this.tagCounterFull=e[0],this.tagCounter=e[1],this.delimiters=r}},Te=new $t;function ue(t){return t[0]}var Ps=t=>({Lexer:t,ParserRules:[{name:"start",symbols:["content"],postprocess:ue},{name:"content$ebnf$1",symbols:[]},{name:"content$ebnf$1",symbols:["content$ebnf$1","node"],postprocess:r=>r[0].concat([r[1]])},{name:"content",symbols:["content$ebnf$1"],postprocess:ue},{name:"node",symbols:["text"],postprocess:ue},{name:"node",symbols:["inlinetag"],postprocess:ue},{name:"node",symbols:["blocktag"],postprocess:ue},{name:"text",symbols:[t.has("text")?{type:"text"}:text],postprocess:([r])=>new le(r.value)},{name:"text",symbols:[t.has("escapeseq")?{type:"escapeseq"}:escapeseq],postprocess:([r])=>new Ze(r.value)},{name:"inlinetag",symbols:[t.has("inlineopen")?{type:"inlineopen"}:inlineopen,"inline"],postprocess:([,[r,n,s]])=>Te.build(r.value,n,s)},{name:"blocktag",symbols:[t.has("blockopen")?{type:"blockopen"}:blockopen,"inline","content","blockclose"],postprocess:([,[r,n,s],o,l],u,i)=>!l||r.value===l.value?Te.build(r.value,n,s,o,!0):i},{name:"inline$ebnf$1$subexpression$1",symbols:[t.has("sep")?{type:"sep"}:sep,"content"]},{name:"inline$ebnf$1",symbols:["inline$ebnf$1$subexpression$1"],postprocess:ue},{name:"inline$ebnf$1",symbols:[],postprocess:()=>null},{name:"inline",symbols:[t.has("keyname")?{type:"keyname"}:keyname,"inline$ebnf$1",t.has("close")?{type:"close"}:close],postprocess:([r,n])=>n?[r,n[1],!0]:[r,[],!1]},{name:"blockclose$ebnf$1",symbols:[t.has("keyname")?{type:"keyname"}:keyname],postprocess:ue},{name:"blockclose$ebnf$1",symbols:[],postprocess:()=>null},{name:"blockclose",symbols:[t.has("blockclose")?{type:"blockclose"}:blockclose,"blockclose$ebnf$1",t.has("close")?{type:"close"}:close],postprocess:([,r])=>r}],ParserStart:"start"}),Ot=Ps;var Mt={open:"[[",sep:"::",close:"]]"};function*Nr(t,e){let r=!0;for(let n of t){r?r=!1:yield e;for(let s of n)yield s}}var Dr=ze(Lt()),_t=/(?:[a-zA-Z_]|%\w)+\d*/u,Cr=t=>t.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"),Gt=t=>{let e=Cr(t.open),r=Cr(t.close),n=new RegExp(`[\\s\\S]+?(?=\\\\|${e}|$)`,"u"),s=new RegExp(`[\\s\\S]+?(?=\\\\|${e}|${r})`,"u"),o=new RegExp(`\\\\(?:${e}|${r})?`,"u"),l={match:t.open,push:"inlinekey"},u={match:`${t.open}#`,push:"blockkey"},i={match:`${t.open}/`,push:"blockclose"},a={match:t.close,pop:1},c={match:t.close,next:"blockmain"},m={match:_t},g={match:n,lineBreaks:!0},d={match:s,lineBreaks:!0},f={match:o},y=v=>({match:t.sep,next:v});return(0,Dr.states)({main:{blockopen:u,inlineopen:l,escapeseq:f,text:g},blockkey:{keyname:m,sep:y("blocktag"),close:c},inlinekey:{keyname:m,sep:y("inlinetag"),close:a},blocktag:{blockopen:u,inlineopen:l,escapeseq:f,close:c,text:d},inlinetag:{blockopen:u,inlineopen:l,escapeseq:f,close:a,text:d},blockmain:{blockopen:u,blockclose:i,inlineopen:l,escapeseq:f,text:g},blockclose:{keyname:m,close:a}})};var $s=(t,e)=>{let r=new Be.Parser(e);try{return r.feed(t).results}catch(n){return[[new le(t)]]}},Br=(t,e)=>{let r=$s(t,e);return r.length>1,r[0]},Os=(t,e)=>[...Nr(t.map(r=>Br(r,e)),new et)];var xe=class{constructor(e){this.tagBuilderSettings=[new Map,new Map];this.delimiters=e!=null?e:Mt,this.lexer=Gt(this.delimiters),this.grammar=Be.Grammar.fromCompiled(Ot(this.lexer))}update(e){this.delimiters=Object.assign({},Mt,e),this.lexer=Gt(this.delimiters),this.grammar=Be.Grammar.fromCompiled(Ot(this.lexer))}parse(e){return Te.push(this.tagBuilderSettings,this.delimiters),Os(e,this.grammar)}rawParse(e){return Te.push(this.tagBuilderSettings,this.delimiters),Br(e,this.grammar)}};var Ms=50,Ls=t=>{let e=[];if(t.length===0)return e;let r="";for(let n of t){let s=n.toString();typeof s=="string"?r+=s:(e.push(r),r="")}return e.push(r),e},ve=class t{constructor(e,r,n){this.textFragments=e,this.parser=new xe(n),this.nodes=r!=null?r:this.parser.parse(e)}static make(e,r){return new t([e],null,r)}static makeFromFragments(e,r){return new t(e,null,r)}render(e,r=()=>{}){let n={template:this,parser:this.parser},s=this.nodes,o=!1;for(let u=0;u<Ms&&!o;u++){let i={iteration:u},a=e.makeAccessor(n,i);s=s.flatMap((c,m)=>c.evaluate(this.parser,a,[m])),o=s.reduce(Bt,!0),e.finishIteration(n,i)}let l=Ls(s);return r(l),e.finishRun(n,{result:l}),l}};var ot={};G(ot,{BrowserTemplate:()=>pe,cleanup:()=>Wt,interspliceChildNodes:()=>st});var Pr=(t,e,r)=>t<0?r+t+1:e+t,zt=(t,e)=>{var o;if(typeof t=="string")return t;let r=null,n=null,s=null;switch(t.nodeType){case Node.TEXT_NODE:return r=t,(o=r.textContent)!=null?o:"";case Node.ELEMENT_NODE:return n=t,e?n.outerHTML:n.innerHTML;case ce.CHILD_NODE_SPAN:return s=t,s.spanAsStrings().join("");default:return""}},$r=(t,e)=>{if(typeof t=="string")return;let r=null,n=null,s=null,o=null;switch(t.nodeType){case Node.TEXT_NODE:r=t,n=document.createElement("div"),r.parentElement&&(r.parentElement.insertBefore(n,r),r.parentElement.removeChild(r)),n.outerHTML=e;break;case Node.ELEMENT_NODE:s=t,s.innerHTML=e;break;case ce.CHILD_NODE_SPAN:o=t,o.replaceSpan(e);break}},_s={type:"index",value:0},Gs={type:"index",value:-1},nt=class nt{constructor(e,r=_s,n=Gs){this.nodeType=nt.CHILD_NODE_SPAN;var l,u,i,a;this.parentElement=e,this.childNodes=Array.from(this.parentElement.childNodes),this.max=e.childNodes.length-1;let s=this.getFromMethod(r.type),o=this.getToMethod(n.type);this._fromIndex=s.call(this,r.value,(l=r.startAtIndex)!=null?l:0,(u=r.exclusive)!=null?u:!1),this._toIndex=o.call(this,n.value,Math.max((i=n.startAtIndex)!=null?i:0,this.from),(a=n.exclusive)!=null?a:!1)}get from(){return this._fromIndex}get to(){return this._toIndex}getFromMethod(e){return e==="index"?this.fromIndex:e==="node"?this.fromNode:this.fromPredicate}getToMethod(e){return e==="index"?this.toIndex:e==="node"?this.toNode:this.toPredicate}fromSafe(e,r){return e<r||e>this.max?this.max:e}fromIndex(e,r,n){let s=Pr(e,r,this.max)+(n?1:0);return this.fromSafe(s,r)}fromNode(e,r,n){let s=this.childNodes.slice(r).findIndex(o=>o===e)+r+(n?1:0);return this.fromSafe(s,r)}fromPredicate(e,r,n){let s=this.childNodes.slice(r).findIndex(e)+r+(n?1:0);return this.fromSafe(s,r)}toSafe(e,r){return e<r||e>this.max?0:e}toIndex(e,r,n){let s=Pr(e,r,this.max)-(n?1:0);return this.toSafe(s,r)}toNode(e,r,n){let s=this.childNodes.slice(r).findIndex(o=>o===e)+r-(n?1:0);return this.toSafe(s,r)}toPredicate(e,r,n){let s=this.childNodes.slice(r).findIndex(e)+r-(n?1:0);return this.toSafe(s,r)}get valid(){return this._fromIndex<=this._toIndex}get length(){return Math.max(0,this._toIndex-this._fromIndex+1)}getRootNode(){return this.parentElement.getRootNode()}span(){return this.valid?this.childNodes.slice(this._fromIndex,this._toIndex+1):[]}spanAsStrings(){return this.span().map(e=>zt(e,!0))}replaceSpan(e){if(!this.valid)return;let r=document.createElement("div"),n=this.parentElement.childNodes.length;this.parentElement.insertBefore(r,this.parentElement.childNodes[this._fromIndex]);for(let s of this.span())s.parentElement===this.parentElement&&this.parentElement.removeChild(s);r.outerHTML=e,this.childNodes=Array.from(this.parentElement.childNodes),this.max=this.childNodes.length,this._toIndex=this._toIndex+(this.max-n)}};nt.CHILD_NODE_SPAN=3353;var ce=nt;var Or=(t,e=0)=>[{type:"predicate",value:t.value,startAtIndex:e,exclusive:!1},{type:"predicate",value:s=>!t.value(s),startAtIndex:e,exclusive:!0}],st=(t,e)=>{let r=[],n=new ce(t,...Or(e));for(;n.valid;)r.push(n),n=new ce(t,...Or(e,n.to+1));return r};var Mr=(t,e)=>{let r=document.createElement("style");return r.type="text/css",r.id=`anking-${t}`,r.textContent=e,r},Lr=(t,e)=>!!t.getElementById(`anking-${e}`),_r=(t,e)=>{Lr(document,t)||document.head.appendChild(Mr(t,e))},zs=(t,e,r)=>{let n=t.getRootNode();n instanceof Document?_r(e,r):Lr(n,e)||n.insertBefore(Mr(e,r),n.firstElementChild)},pe=class t extends ve{constructor(r,n,s,o){super(r,n,o);this.inputs=s}static makeFromNode(r,n){return t.makeFromNodes([r],n)}static makeFromNodes(r,n){return new t(r.map(s=>zt(s,!1)),null,r,n)}renderToNodes(r){super.render(r,n=>n.forEach((s,o)=>$r(this.inputs[o],s)))}appendDocumentStyle(r,n){_r(r,n)}appendStyle(r,n,s){zs(r,n,s)}appendStyleAll(r,n){for(let s of this.inputs)typeof s!="string"&&this.appendStyle(s,r,n)}},Ws="anking-delay",Wt=()=>{for(let t of Array.from(document.getElementsByClassName(Ws)))t.style.visibility="visible"};var it=ze(Pt());var Gr=ze(Lt()),N=(0,Gr.compile)({text:{match:/[a-zA-Z_]+/u},numDigits:{match:/\d+(?=:|$)/u},digits:{match:/\d+/u},slash:{match:"/"},escapeseq:{match:/%\w/u},multiplierSeq:{match:/\*n\+/u},allStar:{match:/^\*$/u},numStar:{match:/\*(?=:|$)/u},star:{match:"*"},groupOpen:{match:"{"},groupAlternative:{match:","},rangeSpecifier:{match:/-/u},numGroupClose:{match:/\}(?=:|$)/u},groupClose:{match:"}"},occurSep:{match:":"}});function P(t){return t[0]}var Vs={Lexer:N,ParserRules:[{name:"start",symbols:["allStar"],postprocess:P},{name:"start",symbols:["pattern"],postprocess:P},{name:"allStar",symbols:[N.has("allStar")?{type:"allStar"}:allStar],postprocess:()=>()=>!0},{name:"pattern",symbols:["key","num","occur"],postprocess:([t,e,r])=>(n,s,o)=>{if(typeof s=="undefined"){let l=n.match(K);if(!l)return!1;let u=l[1],i=Number(l[2]),a=Number.isNaN(i)?null:i;return t.test(u)&&e(a)&&r(o)}else return t.test(n)&&e(s)&&r(o)}},{name:"key$ebnf$1$subexpression$1",symbols:["keyComps"]},{name:"key$ebnf$1",symbols:["key$ebnf$1$subexpression$1"]},{name:"key$ebnf$1$subexpression$2",symbols:["keyComps"]},{name:"key$ebnf$1",symbols:["key$ebnf$1","key$ebnf$1$subexpression$2"],postprocess:t=>t[0].concat([t[1]])},{name:"key",symbols:["key$ebnf$1"],postprocess:([t])=>new RegExp(`^${t.join("")}$`,"u")},{name:"keyComps",symbols:["mixedText"],postprocess:P},{name:"keyComps",symbols:["escapeseq"],postprocess:P},{name:"keyComps",symbols:["keyGroup"],postprocess:P},{name:"mixedText",symbols:[N.has("text")?{type:"text"}:text],postprocess:([t])=>t.value},{name:"mixedText",symbols:[N.has("star")?{type:"star"}:star],postprocess:()=>".*"},{name:"mixedText",symbols:[N.has("slash")?{type:"slash"}:slash],postprocess:()=>"\\\\"},{name:"escapeseq",symbols:[N.has("escapeseq")?{type:"escapeseq"}:escapeseq],postprocess:([t])=>t.value},{name:"keyGroup",symbols:[N.has("groupOpen")?{type:"groupOpen"}:groupOpen,"keyGroupInner",N.has("groupClose")?{type:"groupClose"}:groupClose],postprocess:([,t])=>t.join("")},{name:"keyGroupInner$ebnf$1",symbols:[]},{name:"keyGroupInner$ebnf$1$subexpression$1",symbols:[N.has("groupAlternative")?{type:"groupAlternative"}:groupAlternative,"keyGroupItem"]},{name:"keyGroupInner$ebnf$1",symbols:["keyGroupInner$ebnf$1","keyGroupInner$ebnf$1$subexpression$1"],postprocess:t=>t[0].concat([t[1]])},{name:"keyGroupInner",symbols:["keyGroupItem","keyGroupInner$ebnf$1"],postprocess:([t,e])=>[t,...e.map(r=>r.value)]},{name:"keyGroupItem$ebnf$1",symbols:[]},{name:"keyGroupItem$ebnf$1$subexpression$1",symbols:["mixedText"]},{name:"keyGroupItem$ebnf$1",symbols:["keyGroupItem$ebnf$1","keyGroupItem$ebnf$1$subexpression$1"],postprocess:t=>t[0].concat([t[1]])},{name:"keyGroupItem",symbols:["keyGroupItem$ebnf$1"],postprocess:([t])=>t.join("")},{name:"num$ebnf$1$subexpression$1",symbols:["numPredicate"]},{name:"num$ebnf$1",symbols:["num$ebnf$1$subexpression$1"],postprocess:P},{name:"num$ebnf$1",symbols:[],postprocess:()=>null},{name:"num",symbols:["num$ebnf$1"],postprocess:([t])=>t?t[0]:e=>e===null},{name:"numPredicate",symbols:["numDigits"],postprocess:P},{name:"numPredicate",symbols:["numStar"],postprocess:P},{name:"numPredicate",symbols:["numGroup"],postprocess:P},{name:"numDigits",symbols:[N.has("numDigits")?{type:"numDigits"}:numDigits],postprocess:([t])=>e=>e===Number(t.value)},{name:"numStar",symbols:[N.has("numStar")?{type:"numStar"}:numStar],postprocess:()=>t=>!0},{name:"numGroup",symbols:[N.has("groupOpen")?{type:"groupOpen"}:groupOpen,"numGroupInner",N.has("numGroupClose")?{type:"numGroupClose"}:numGroupClose],postprocess:([,t])=>e=>t.reduce((r,n)=>r||n(e),!1)},{name:"numGroupInner$ebnf$1",symbols:[]},{name:"numGroupInner$ebnf$1$subexpression$1",symbols:[N.has("groupAlternative")?{type:"groupAlternative"}:groupAlternative,"numGroupItem"]},{name:"numGroupInner$ebnf$1",symbols:["numGroupInner$ebnf$1","numGroupInner$ebnf$1$subexpression$1"],postprocess:t=>t[0].concat([t[1]])},{name:"numGroupInner",symbols:["numGroupItem","numGroupInner$ebnf$1"],postprocess:([t,e])=>[t,...e.map(([,r])=>r)]},{name:"numGroupItem$ebnf$1$subexpression$1",symbols:["numGroupPredicate"]},{name:"numGroupItem$ebnf$1",symbols:["numGroupItem$ebnf$1$subexpression$1"],postprocess:P},{name:"numGroupItem$ebnf$1",symbols:[],postprocess:()=>null},{name:"numGroupItem",symbols:["numGroupItem$ebnf$1"],postprocess:([t])=>t?t[0]:e=>e===null},{name:"numGroupPredicate",symbols:["digits"],postprocess:P},{name:"numGroupPredicate",symbols:["range"],postprocess:P},{name:"numGroupPredicate",symbols:["multiple"],postprocess:P},{name:"digits",symbols:[N.has("digits")?{type:"digits"}:digits],postprocess:([t])=>e=>e===Number(t.value)},{name:"range",symbols:["bounded"],postprocess:P},{name:"range",symbols:["leftBounded"],postprocess:P},{name:"range",symbols:["rightBounded"],postprocess:P},{name:"bounded",symbols:[N.has("digits")?{type:"digits"}:digits,N.has("rangeSpecifier")?{type:"rangeSpecifier"}:rangeSpecifier,N.has("digits")?{type:"digits"}:digits],postprocess:([t,,e])=>r=>typeof r=="number"&&Number(t.value)<=r&&r<=Number(e.value)},{name:"leftBounded",symbols:[N.has("digits")?{type:"digits"}:digits,N.has("rangeSpecifier")?{type:"rangeSpecifier"}:rangeSpecifier],postprocess:([t])=>e=>typeof e=="number"&&Number(t.value)<=e},{name:"rightBounded",symbols:[N.has("rangeSpecifier")?{type:"rangeSpecifier"}:rangeSpecifier,N.has("digits")?{type:"digits"}:digits],postprocess:([,t])=>e=>typeof e=="number"&&e<=Number(t.value)},{name:"multiple",symbols:[N.has("digits")?{type:"digits"}:digits,N.has("multiplierSeq")?{type:"multiplierSeq"}:multiplierSeq,N.has("digits")?{type:"digits"}:digits],postprocess:([t,,e])=>r=>(r-e)%t===0},{name:"occur$ebnf$1$subexpression$1",symbols:[N.has("occurSep")?{type:"occurSep"}:occurSep,"occurPredicate"]},{name:"occur$ebnf$1",symbols:["occur$ebnf$1$subexpression$1"],postprocess:P},{name:"occur$ebnf$1",symbols:[],postprocess:()=>null},{name:"occur",symbols:["occur$ebnf$1"],postprocess:([t])=>t?e=>e===null?!0:t[1](e):()=>!0},{name:"occurPredicate",symbols:["numDigits"],postprocess:P},{name:"occurPredicate",symbols:["numStar"],postprocess:P},{name:"occurPredicate",symbols:["occurGroup"],postprocess:P},{name:"occurGroup",symbols:[N.has("groupOpen")?{type:"groupOpen"}:groupOpen,"occurGroupInner",N.has("groupClose")?{type:"groupClose"}:groupClose],postprocess:([,t])=>e=>t.reduce((r,n)=>n||r(e),!1)},{name:"occurGroupInner$ebnf$1",symbols:[]},{name:"occurGroupInner$ebnf$1$subexpression$1",symbols:[N.has("groupAlternative")?{type:"groupAlternative"}:groupAlternative,"numGroupPredicate"]},{name:"occurGroupInner$ebnf$1",symbols:["occurGroupInner$ebnf$1","occurGroupInner$ebnf$1$subexpression$1"],postprocess:t=>t[0].concat([t[1]])},{name:"occurGroupInner",symbols:["numGroupPredicate","occurGroupInner$ebnf$1"],postprocess:([t,e])=>[t,...e.map(([,r])=>r)]}],ParserStart:"start"},zr=Vs;var Hs=it.Grammar.fromCompiled(zr),Us=t=>{let e=new it.Parser(Hs);try{let r=e.feed(t).results;return r.length>1,r[0]}catch(r){return()=>!1}},Q=class t{constructor(e){this.predicate=Us(e)}static make(e){return new t(e)}check(e,r,n=null){return this.predicate(e,r,n)}checkFullKey(e,r=null){return this.predicate(e,void 0,r)}checkTagIdentifier(e){let r=e.match(K);if(!r)return!1;let n=r[1],s=r[2].length>0?Number(r[2]):null,o=r[3]?Number(r[3]):null;return this.predicate(n,s,o)}};var ut={};G(ut,{ankiLog:()=>H,getQaChildNodes:()=>Ur,init:()=>Ht,initialize:()=>Hr});var H=(...t)=>{if(!globalThis.closetDebug)return!1;let e=Object.assign(document.createElement("div"),{className:"anking-log",innerText:t.map(String).join(`
`)}),r=document.getElementById("qa");return r?(r.appendChild(e),!0):!1};var U="github.com/AnKing-VIP/anking_notes_addon",Vt=class{constructor(){this._isAvailable=!1;try{typeof globalThis.sessionStorage=="object"&&(this._isAvailable=!0)}catch(e){}}clear(){for(let e=0;e<sessionStorage.length;e++){let r=sessionStorage.key(e);r&&r.indexOf(U)===0&&(sessionStorage.removeItem(r),e--)}}setItem(e,r){sessionStorage.setItem(U+e,JSON.stringify(r))}getItem(e){var n;let r=(n=sessionStorage.getItem(U+e))!=null?n:"null";return JSON.parse(r)}removeItem(e){sessionStorage.removeItem(U+e)}isAvailable(){return this._isAvailable}},lt=class{constructor(e){this._isAvailable=!1;this.obj=globalThis[e],typeof this.obj=="object"&&(this._isAvailable=!0,this.obj[U]===void 0&&this.clear())}clear(){this.obj[U]={}}setItem(e,r){this.obj[U][e]=r}getItem(e){return this.obj[U][e]==null?null:this.obj[U][e]}removeItem(e){delete this.obj[U][e]}isAvailable(){return this._isAvailable}},qs=()=>{let t;if(t=new Vt,t.isAvailable())return H("Used Persistence sessionStorage implementation"),t;if(t=new lt("py"),t.isAvailable())return H("Used Persistence windowKey py implementation"),t;let e=location.toString().indexOf("title"),r=location.toString().indexOf("main",e);return e>0&&r>0&&r-e<10?(H("Used Persistence windowKey qt implementation"),new lt("qt")):(H("Defaulted to Persistence windowKey implementation"),t)},js=t=>{let e=0,r,n;for(r=0;r<t.length;r++)n=t.charCodeAt(r),e=(e<<5)-e+n,e|=0;return e},at=qs(),Wr=(t,e)=>r=>{var i;let n=(i=globalThis.closetCardHash)!=null?i:null,o=(()=>{if(!at.isAvailable())return new Map;if(t==="front"){let c=js(e);if(c!==n)return globalThis.closetCardHash=c,new Map}let a=at.getItem(r);return new Map(a)})();return{key:r,map:o,writeBack:()=>{if(at.isAvailable()){let a=Array.from(o.entries());at.setItem(r,a)}}}};var Ks=t=>{switch(t){case 1:return"You have set the variable globalThis.closetImmediately.";case 2:return"AnKing Closet executes while MathJax is still rendering. You are on AnkiDesktop. The action will be pushed onto onShownHook.";case 3:return"AnKing Closet executes while MathJax is still rendering. You are on AnkiMobile. The action will be enqueued on MathJax.Hub.Queue.";case 4:return"AnKing Closet executes after MathJax finished rendering. The action will be executed immediatley.";case 5:return"You are on AnkiWeb, which does not have MathJax. Alternatively, you are on platform with MathJax 3. The action will be executed immediatley.";default:return"No Description found. This should never happen."}},Pe={raw:t=>t(),viaShownHook:t=>globalThis.onShownHook.push(t),viaMathJaxQueue:t=>globalThis.MathJax.Hub.Queue(t)},Xs=()=>globalThis.MathJax.Hub.queue,Js=()=>{let t=Xs(),e=Object.assign({},t);return e.queue=e.queue.map(String),e},Ys=()=>{if(globalThis.closetImmediately)return[Pe.raw,1,[]];try{let t=globalThis._updatingQA,e=Js();if(t){let r=globalThis.onShownHook;return r?[Pe.viaShownHook,2,[JSON.stringify(r.map(String)),JSON.stringify(e)]]:[Pe.viaMathJaxQueue,3,[JSON.stringify(e)]]}else return[Pe.raw,4,[JSON.stringify(e)]]}catch(t){return[Pe.raw,5,[t]]}},Vr=t=>{let[e,r,n]=Ys();H(`Init mode ${r}`,Ks(r),...n),e(t)};var Qs=t=>Number(t.match(/[0-9]*$/)),Zs=(t,e,r)=>({card:t,cardNumber:Qs(t),tagsFull:e,tags:e.length===0?[]:e.split(" "),side:r}),eo=(t,e,r,n)=>{let s=window.performance.now();return pe.makeFromNodes(t,n==null?void 0:n.delimiters).renderToNodes(r),e.writeBack(),window.performance.now()-s},Ht=(t,e,r,n,s)=>{var u,i;let o=Zs(r,n,s),l=Wr(s,(i=(u=document.getElementById("qa"))==null?void 0:u.innerHTML)!=null?i:"");return e(t,o,l).map(a=>eo(...a))},to=(t,e,r,n,s)=>{try{`${Ht(t,e,r,n,s).map(l=>l.toFixed(3))}`}catch(o){H("An error occured while executing AnKing Closet",o)}finally{Wt()}},Hr=(t,e,r,n,s)=>(Vr(()=>to(t,e,r,n,s)),t);var ro=t=>t.nodeType===Node.ELEMENT_NODE,no=t=>t.tagName==="STYLE",so=t=>t.tagName==="SCRIPT",oo=t=>so(t)&&(t.type.length===0||t.type.endsWith("javascript")),io=t=>t.id==="anki-am",ao=t=>ro(t)&&(no(t)||oo(t)||io(t)),Ur=()=>{if(!globalThis.document)return null;let t=globalThis.document.getElementById("qa");return t?st(t,{type:"predicate",value:e=>!ao(e)}):null};var er={};G(er,{activate:()=>Kr,apply:()=>on,constantGet:()=>me,deactivate:()=>Xr,debug:()=>gn,define:()=>hn,delimiter:()=>fn,generateInteger:()=>mn,generateReal:()=>dn,order:()=>cn,pick:()=>rn,pickCardNumber:()=>sn,pickIndex:()=>nn,process:()=>an,setList:()=>Yr,setNumber:()=>qr,shuffle:()=>un,style:()=>ln});var $e=E({sep:";"}),Oe=E({sep:"=",trim:!0,max:2}),ke=class{constructor(e){this.defaultValue=e,this.selectors=[]}set(e,r){this.selectors.unshift([Q.make(e),r])}get(e,r,n){let s=this.selectors.find(([o])=>o.check(e,r,n));return s?s[1]:this.defaultValue}},ct=t=>(e,r,n)=>(s,{cache:o})=>(s.values.forEach(u=>{o.over(e,n(...u),new t(r))}),{ready:!0});var qt=class extends ke{setNumber(e,r){this.set(e,Number.isNaN(r)?0:r)}},lo=ct(qt),qr=({tagname:t="set",storeId:e="numerical",separator:r=$e,assignmentSeparator:n=Oe}={})=>s=>s.register(t,lo(e,0,(o,l)=>u=>u.setNumber(o,Number(l))),{optics:[r,_(),n]});var jt=class extends ke{on(e){this.set(e,!0)}off(e){this.set(e,!1)}},jr=ct(jt),Kr=({tagname:t="on",storeId:e="active",optic:r=$e}={})=>n=>n.register(t,jr(e,!1,s=>o=>{o.on(s)}),{separators:[r,_(),Oe]}),Xr=({tagname:t="off",storeId:e="active",optic:r=$e}={})=>n=>n.register(t,jr(e,!1,s=>o=>o.off(s)),{separators:[r,_(),Oe]});var me=t=>({get:()=>t});var pt=class extends j{},Jr=t=>(e,r)=>(n,s)=>{var l;return{ready:!0,result:(l=s.cache.over(e,r(n,s),new t(new Map)))!=null?l:""}};var Kt=class extends pt{setList(e,r){this.set(e,r)}overwriteList(e,r,n=0){let s=this.getList(e);for(let o=0;o<r.length;o++)s[n+o]=r[o];this.setList(e,s)}getList(e){return this.get(e,[])}},mt=Jr(Kt);var uo=(t,e)=>(r,n)=>"",co=(t,e)=>(r,n)=>s=>{let[o,l]=r.values.length===2?r.values:[["default"],r.values[0]],u=o[0],i=s.getList(u),a=t(s,u,l)(r,n);return e(a,i)(r,n)},po=t=>({tagname:e="setl",storeId:r="lists",postprocess:n=uo,optics:s=[E({sep:"::"}),_(),E({sep:"||"})]}={})=>o=>o.register(e,mt(r,co(t,n)),{optics:s}),mo=(t,e,r)=>(n,s)=>(n.num===null?t.setList(e,r):t.overwriteList(e,r,n.num),""),Yr=po(mo);var dt=function*(t,e,r=[],n=()=>!1){let s=[],o=0;for(;!n(r)&&o<1e3;){let l=t();!r.includes(l)&&!s.includes(l)&&(e&&s.push(l),yield l),o++}return s},gt=(t,e)=>()=>t+Math.floor(Math.random()*(e-t)),Qr=(t,e)=>String(t*e),Zr=(t,e)=>r=>r.length>=e-t,en=(t,e)=>()=>t+Math.random()*(e-t),tn=(t,e)=>t.toFixed(e);var go=(t,e)=>(r,n)=>t,ho=(t,e)=>(r,n)=>s=>{let o=r.values||"default",l=s.getList(o),u=t(l,o)(r,n);return e(u,l)(r,n)},Xt=t=>({tagname:e="pick",storeId:r="lists",postprocess:n=go}={})=>s=>s.register(e,mt(r,ho(t,n))),fo=(t,e)=>(r,{memory:n})=>{let s=`pick:picked:${r.fullKey}:${r.occur}`,o=n.lazy(s,()=>{let l=gt(0,t.length),u=Zr(0,t.length),i=!!r.num,a=`pick:uniqList:${r.fullKey}`,c=i?n.over(a,y=>(Object.prototype.hasOwnProperty.call(y,e)||(y[e]=[]),y),{})[e]:[],m=Array.from(t).reduce((y,v,x)=>(v===void 0&&y.push(x),y),[]),g=c.concat(m),f=dt(l,i,g,u).next();if(!f.done)return c.push(f.value),f.value});return Number.isInteger(o)?t[o]:""},yo=(t,e)=>(r,n)=>t[Number(r.num)||0],bo=(t,e)=>(r,n)=>{var l;let s=t[n.preset.cardNumber];return(l=s!=null?s:t[0])!=null?l:""},rn=Xt(fo),nn=Xt(yo),sn=Xt(bo);var L=class t{constructor(e,r,n){this.separator=e,this.mapper=r,this.processor=n}static make({separator:e="",mapper:r=$,processor:n=$}={}){return new t(e,r,n)}toStylizer({separator:e=this.separator,mapper:r=this.mapper,processor:n=this.processor}={}){return new t(e,r,n)}stylize(e,...r){return this.processor(e.flatMap((n,s,o)=>this.mapper(n,s,...r.map(l=>l[s]),o)).join(this.separator))}stylizeFull(e,r=[],n=[]){return this.processor(e.flatMap((s,o,l)=>this.mapper(s,o,...r.map(u=>u[o]),l)).join(this.separator),...n)}};var Me=t=>({tagname:e="s"}={})=>r=>{r.register(e,t)},Jt=t=>e=>t(e.values),on=({tagname:t="s",apply:e=Jt($),optics:r=[]}={})=>n=>{n.register(t,e,{optics:r})},an=({tagname:t="s",processor:e=$,optics:r=[]}={})=>n=>{n.register(t,Jt(e),{optics:r})},ln=({tagname:t="s",stylizer:e=L.make(),optics:r=[E("::")]}={})=>n=>{n.register(t,Jt(e.stylize.bind(e)),{optics:r})};var Qt={};G(Qt,{acrossCustom:()=>Eo,acrossNumberedCustom:()=>No,acrossNumberedTag:()=>Yt,acrossTag:()=>Le,withinCustom:()=>Ro,withinTag:()=>wo});var To=(t,e,r,n)=>(s,o)=>{let l=`${t}:apply`,u=`${t}:length`,i=`${e}:waitingSet`,a=`${e}:shuffle`;if(o.cache.get(l,!1)){if(o.cache.get(i,new Set).size>0)return;let g=[],d=o.cache.get(a,[]),f=o.cache.get(u,0);for(let y=0;y<f;y++){let v=d.shift();v&&g.push(v)}return g}if(!o.ready){o.cache.over(i,m=>m.add(t),new Set);return}let c=n(s,o);if(c.length===0)return c;o.cache.fold(a,m=>m.concat(c),[]),o.cache.set(u,c.length),o.deferred.registerIfNotExists(l,()=>{o.cache.set(l,!0),o.cache.over(i,m=>m.delete(t),new Set)},{priority:65}),o.deferred.registerIfNotExists(a,()=>{o.cache.over(i,m=>m.size>0,new Set)||o.cache.fold(a,m=>{let g=o.memory.fold(a,d=>r(d,o.cache.get(a,[]).length),[]);return Xe(m,g)},[])})},Se=t=>(e,r)=>(n,s)=>{let o="sequences",[l,u]=t(n,s);return s.cache.over(o,i=>{i.includes(u)||i.push(u)},[]),To(l,u,r,e)(n,s)},xo=({fullKey:t,fullOccur:e},r)=>[`${t}:${e}`,`${t}:${e}`],vo=({fullKey:t,fullOccur:e},r)=>[`${t}:${e}`,t],ko=({fullKey:t,fullOccur:e,num:r},n)=>[`${t}:${e}`,r?t:`${t}:${e}`],So=t=>({fullKey:e,fullOccur:r,num:n},s)=>[`${e}:${r}`,`${t}${n}:${r}`],Ao=t=>({fullKey:e,fullOccur:r,num:n},s)=>[`${e}:${r}`,`${t}${n}`],Fo=t=>({fullKey:e,fullOccur:r,num:n},s)=>{let o=`${t}${n}`;return[`${e}:${r}`,n?o:`${o}:${r}`]},wo=Se(xo),Le=Se(vo),Yt=Se(ko),Ro=t=>Se(So(t)),Eo=t=>Se(Ao(t)),No=t=>Se(Fo(t));var Zt={};G(Zt,{mixIn:()=>Io,topUp:()=>X});var X=(t,e)=>{if(t.length>=e)return t;let r=kr(Array.from(new Array(e-t.length),(s,o)=>o+t.length));return[...t,...r]},Io=(t,e)=>{if(t.length>=e)return t;let r=Array.from(new Array(e-t.length),(s,o)=>o+t.length),n=[...t];return r.forEach(s=>n.splice(Math.floor(Math.random()*(n.length+1)),0,s)),n};var Co=L.make({processor:t=>`<span class="anking-shuffle">${t}</span>`,mapper:t=>`<span class="anking-shuffle__item">${t}</span>`,separator:'<span class="anking-shuffle__separator"></span>'}),Do=(t,e)=>()=>t.stylize(e),Bo=[E({sep:"||"})],un=({tagname:t="mix",stylizer:e=Co,evaluate:r=Do,sortInStrategy:n=X,sequencer:s=Yt,optics:o=Bo}={})=>l=>{let u=(i,a)=>{let g=s(({values:d})=>d!=null?d:[],n)(i,a);if(g)return r(e,g)(i,a)};l.register(t,u,{optics:o})};var Po={priority:35,persistent:!0},$o=[E("::"),_(),E(",")],cn=({tagname:t="ord",optics:e=$o,sortInStrategy:r=X}={})=>n=>{let s=(o,{deferred:l,cache:u,memory:i})=>{let a="sequences",c=new Set(u.get(a,[]));for(let[m,g]of o.values.entries()){let d=g.map(Q.make),f=`${o.key}:${o.fullOccur}:ord:${m}`,y=()=>{let x=Array.from(c).filter(C=>d.some(I=>I.checkTagIdentifier(C))?(c.delete(C),!0):!1),R=x.map(C=>`${C}:shuffle`);for(let[C,I]of x.entries()){let O=R[C],D=`${I}:waitingSet`;if(l.block(O),u.get(D,new Set).size!==0)continue;let Fe=R.reduce((h,b)=>{let T=i.get(b,[]);return h.length<T.length?T:h},[]),te=u.get(O,[]),p=r(u.get(f,Fe),te.length);u.fold(O,h=>Xe(h,p),[]),u.set(f,p),i.set(O,p)}c.size===0&&l.unregister(f)};l.register(f,y,Po)}return{ready:!0}};n.register(t,s,{optics:e})};var Oo=[E({sep:","})],pn=(t,e,r)=>({tagname:n="gen",uniqueConstraintId:s="uniq",optics:o=Oo}={})=>l=>{let u=`gen:${s}`,i=({values:a,fullOccur:c,num:m},{memory:g})=>{let[d=1,f=100,y=r]=a.length===1?[1,Number(a[0]),r]:a.map(Number),v=Number.isInteger(m)?`${u}:${m}`:u,x=`gen:${n}:${c}`;return{ready:!0,result:g.lazy(x,()=>{let I=dt(t(d,f),!0,Number.isInteger(m)?g.get(v,[]):[]).next();return I.done?"":e(I.value,y)})}};l.register(n,i,{optics:o})},mn=pn(gt,Qr,1),dn=pn(en,tn,2);var gn=()=>t=>{let e=(r,{path:n})=>n.join(":");t.register("tagpath",e),t.register("never",()=>{}),t.register("empty",()=>""),t.register("key",({key:r})=>r),t.register("stopIteration",({values:r},{filters:n})=>{let s=Number(r),o=n.getOrDefault("base");return n.register("base",(l,u)=>{var i;return u.iteration>=s?(i=l.text)!=null?i:"":o(l,u)}),{ready:!0}}),t.register("memorytest",(r,{memory:n})=>{let s="base:memorytest";return String(n.fold(s,o=>++o,0))})};var Mo=/%(.)/gu,Lo={optics:[E({sep:"::",max:2})],capture:!0},_o=t=>(e,r)=>{var s;let n=null;switch(r){case"%":return r;case"n":return typeof t.num=="number"?String(t.num):"";case"k":return t.key;case"f":return t.fullKey;default:return n=Number(r),Number.isNaN(n)?e:(s=t.values[n])!=null?s:""}},hn=(t={})=>e=>{let{tagname:r="def"}=t,n={optics:[E({sep:"::"})]},s=o=>{let[l,u]=o.values,i=a=>({result:u.replace(Mo,_o(a)),parse:!0});return e.register(l,i,n),{ready:!0}};e.register(r,s,Lo)};var Go={inlineOptics:[E({sep:"::",max:2})],capture:!0},fn=(t={})=>e=>{let{tagname:r="delim"}=t,n=(s,{template:o,isCapture:l})=>{if(l){let[u,i]=s.inlineValues;return o.parser.update({open:u,close:i}),{result:s.blockText,parse:!0}}return o.parser.update(),{result:s.innerNodes}};e.register(r,n,Go)};var lr={};G(lr,{behaviors:()=>sr,deciders:()=>ht,recipes:()=>hi});var ht={};G(ht,{isActive:()=>zo,isActiveAll:()=>tr,isActiveGetRange:()=>bn,isActiveOverwritten:()=>Tn,isActiveWithinRange:()=>yn,isBack:()=>xn,isBackAll:()=>rr});var yn=(t,e,r,n)=>t-r<=e&&e<=t+n,zo=({num:t},{preset:e})=>{switch(t){case null:return!1;case 0:return!0;default:return Object.prototype.hasOwnProperty.call(e,"cardNumber")?t===e.cardNumber:!1}},bn=({key:t,num:e,fullOccur:r},{preset:n,cache:s})=>{let o="flashcardActiveBottom",l="flashcardActiveTop",u=me(0),i=null,a=null;switch(e){case null:return!1;case 0:return!0;default:return typeof n.cardNumber!="number"?!1:(i=s.get(o,u).get(t,n.cardNumber,r),a=s.get(l,u).get(t,n.cardNumber,r),yn(n.cardNumber,e,i,a))}},Tn=(t,e)=>{let r="flashcardActive";return e.cache.get(r,me(!1)).get(t.key,t.num,t.fullOccur)},tr=(t,e)=>Tn(t,e)||bn(t,e),xn=(t,{preset:e})=>e.side==="back",rr=xn;var J=t=>Object.prototype.hasOwnProperty.call(t,"tagname")?[t.tagname]:[],Y=(t,e)=>ie(oe({},t),{tagname:e[0]}),vn="wrapped",nr=t=>(e,{wrapId:r,getTagnames:n,setTagnames:s}={wrapId:vn,getTagnames:J,setTagnames:Y})=>(o={})=>l=>{let u=n(o),i=g=>`${g}:${r}:internal`,a=new Map,c=u.map(g=>{let d=i(g);return a.set(g,d),d});e(s(o,c))(l);let m=(g,d)=>{let f=a.get(g.key);return t(Object.assign({},g,{keyInternal:f}),d),d.filters.getOrDefault(f)(g,d)};for(let g of u)l.register(g,m,l.getOptions(i(g)))},kn=t=>(e,r,n={},s={wrapId:vn,getTagnames:J,setTagnames:Y})=>nr((o,l)=>{t(l).registerIfNotExists(o.keyInternal,r,n)})(e,s),Sn=kn(t=>t.deferred),An=kn(t=>t.aftermath);var ft=(t,e,r,{wrapId:n,setTagnames:s}={wrapId:"sum",getTagnames:J,setTagnames:Y})=>({tagname:o="sum",optionsFalse:l={},optionsTrue:u={}}={})=>i=>{let a=`${o}:${n}:false`,c=`${o}:${n}:true`;t(s(l,[a]))(i),e(s(u,[c]))(i);let m=(g,d)=>r(g,d)?d.filters.getOrDefault(c)(g,d):d.filters.getOrDefault(a)(g,d);i.register(o,m,i.getOptions(c))},yt=(t,e,r,n,s,o,{wrapId:l,setTagnames:u}={wrapId:"sumFour",getTagnames:J,setTagnames:Y})=>({tagname:i="sum",optionsZero:a={},optionsOne:c={},optionsTwo:m={},optionsThree:g={}}={})=>d=>{let f=`${i}:${l}:zero`,y=`${i}:${l}:two`;ft(t,e,s)({tagname:f,optionsFalse:u(a,[f]),optionsTrue:u(c,[f])})(d),ft(r,n,s)({tagname:y,optionsFalse:u(m,[y]),optionsTrue:u(g,[y])})(d);let v=(x,R)=>o(x,R)?R.filters.getOrDefault(y)(x,R):R.filters.getOrDefault(f)(x,R);d.register(i,v)};var bt=t=>e=>r=>{let n=e!=null?e:{};for(let[s,o={}]of t){let{setTagnames:l=Y,getTagnames:u=J}=o;s(l(n,u(n)))(r)}};var Fn=me(!1),Tt=me(0),Wo=t=>(e,r)=>(n,s)=>t(e,r)(n,s),Vo=t=>e=>(r,n)=>(s,o)=>{let l="flashcardShow",u="flashcardHide";return o.cache.get(l,Fn).get(s.key,s.num,s.fullOccur)?r(s,o):o.cache.get(u,Fn).get(s.key,s.num,s.fullOccur)?n(s,o):t(e)(r,n)(s,o)},Ho=t=>e=>(r,n)=>(s,o)=>{if(!Object.prototype.hasOwnProperty.call(o.preset,"cardNumber"))return t(e)(r,n)(s,o);let[l,u,i,a]=Uo(s,o),c=o.preset.cardNumber;return!c||!s.num?e(r,n)(s,o):c-l<=s.num&&s.num<=c+u?r(s,o):c-i<=s.num&&s.num<=c+a?n(s,o):t(e)(r,n)(s,o)},Uo=(t,{cache:e,preset:r})=>{let n="flashcardShowBottom",s="flashcardShowTop";if(!r.cardNumber)return[0,0,0,0];let o=e.get(n,Tt).get(t.key,r.cardNumber,t.fullOccur),l=e.get(s,Tt).get(t.key,r.cardNumber,t.fullOccur),u="flashcardHideBottom",i="flashcardHideTop",a=e.get(u,Tt).get(t.key,r.cardNumber,t.fullOccur),c=e.get(i,Tt).get(t.key,r.cardNumber,t.fullOccur);return[o,l,a,c]},wn=Vo(Ho(Wo));var q=(t=tr,e=rr,r=wn)=>(n,s)=>(o,l,u,i,a,c={})=>m=>{let g=`${o}:internal`;yt(Me(r(n)(i,a)),Me(l),Me(r(s)(i,a)),Me(u),t,e)({tagname:g})(m);let f=(y,v)=>v.filters.getOrDefault(g)(y,v);m.register(o,f,c)},dc=ye("[...]"),sr=(n=>(n.Show="show",n.Hide="hide",n.Reveal="reveal",n))(sr||{}),z=t=>{let e=t($,$),r=t(Ke,Ke),n=t(Ke,$),[s,o,l]=[["show","s"],["hide","h"],["reveal","r"]].map(([i,a])=>({getTagnames:c=>{var m,g;return[((m=c.defaultBehavior)!=null?m:"show")===i?c.tagname:(g=c.tagnameShow)!=null?g:`${c.tagname}${a}`]}})),u=bt([[r,o],[e,s],[n,l]]);return u.show=e,u.hide=r,u.reveal=n,u};var Rn=t=>Array.isArray(t[0])?t[0].map((e,r)=>t.map(n=>n[r])):[t],Z=(t,e)=>(r,n)=>n.ready?t.stylize(...Rn(e(r,n))):{ready:!1},ee=(t,e)=>(r,n)=>{if(!n.ready)return{ready:!1};let s=e(r,n);return s?t.stylize(...Rn(s)):{ready:!1}};var qo=ye('<span class="anking-cloze is-inactive"><span class="anking-cloze__ellipsis"></span></span>'),En=t=>e=>`<span class="anking-cloze is-active is-${t}">${e}</span>`,jo=L.make({processor:En("front")}),Ko=L.make({processor:En("back")}),Xo=(t,e)=>{var r;return[`<span class="anking-cloze__hint">${(r=t.values[1])!=null?r:""}</span>`]},Nn=t=>`<span class="anking-cloze__answer">${t.values[0]}</span>`,Jo=(t,{ready:e})=>({ready:e,result:`<span  class="anking-cloze is-inactive">${Nn(t)}</span>`}),Yo=t=>[Nn(t)],Qo=(t,e)=>(r={})=>{let{tagname:n="c",inactiveEllipser:s=qo,frontStylizer:o=jo,frontEllipser:l=Xo,backStylizer:u=Ko,backEllipser:i=Yo,optics:a=[E({sep:"::",max:2})],flashcardTemplate:c=q()}=r,m=Z(o,l),g=Z(u,i),d={optics:a};return c(t,e)(n,m,g,Jo,s,d)},In=z(Qo);var Zo=ye('<span class="anking-multiple-choice is-inactive"><span class="anking-multiple-choice__ellipsis"></span></span>'),ei=t=>t.values?t.values.flatMap((e,r)=>e.map(n=>[n,r])):[],ti=t=>t.values[0],or='<span class="anking-multiple-choice__separator"></span>',ri=L.make({processor:t=>`<span class="anking-multiple-choice is-inactive">${t}</span>`,mapper:t=>`<span class="anking-multiple-choice__item">${t}</span>`,separator:or}),Cn=t=>e=>`<span class="anking-multiple-choice is-active is-${t}">${e}</span>`,ni=L.make({processor:Cn("front"),mapper:t=>`<span class="anking-multiple-choice__item anking-multiple-choice__option">${t}</span>`,separator:or}),si=L.make({processor:Cn("back"),mapper:(t,e,r)=>`<span class="anking-multiple-choice__item anking-multiple-choice__${r===0?"correct":"wrong"}">${t}</span>`,separator:or}),oi=[E({sep:"::"}),_(),E({sep:"||",keepEmpty:!1})],ii=(t,e)=>(r={})=>{let{tagname:n="mc",frontStylizer:s=ni,backStylizer:o=si,inactiveStylizer:l=ri,contexter:u=ti,ellipser:i=Zo,getValues:a=ei,sequence:c=Le,sortInStrategy:m=X,optics:g=oi,flashcardTemplate:d=q()}=r,f=c(a,m),y=ee(s,f),v=ee(o,f),x=d(t,e),R=Z(l,u);return x(n,y,v,R,i,{optics:g})},Dn=z(ii);var ir=t=>({result:t.values,parse:!0}),ai=()=>"",li=(t,e)=>(r={})=>{let{tagname:n="spec",flashcardTemplate:s=q()}=r,o={capture:!0};return s(t,e)(n,ir,ir,ir,ai,o)},Bn=z(li);var ui=(t,e)=>t.values,Pn=t=>e=>`<span class="anking-${t}__item">${e}</span>`,$n=t=>`<span class="anking-${t}__separator"></span>`,ci=t=>()=>`<span class="anking-${t} is-inactive"><span class="anking-${t}__ellipsis"></span></span>`,pi=t=>L.make({processor:e=>`<span class="anking-${t} is-inactive">${e}</span>`,mapper:Pn(t),separator:$n(t)}),mi=t=>L.make({processor:e=>`<span class="anking-${t} is-active">${e}</span>`,mapper:Pn(t),separator:$n(t)}),di=t=>t.values?t.values:[],On=(t,e)=>Z(t,ui),gi=[E({sep:"::"})],ar=(t,e,r)=>(n,s)=>(o={})=>{let{tagname:l="shuf",activeStylizer:u=mi(t),inactiveStylizer:i=pi(t),contexter:a=di,ellipser:c=ci(t),sequence:m=Le,sortInStrategy:g=X,optics:d=gi,flashcardTemplate:f=q()}=o,y={optics:d},v=m(a,g),x=e(u,v),R=r(u,v),C=Z(i,a);return f(n,s)(l,x,R,C,c,y)},Mn=z(ar("mingle",ee,ee)),Ln=z(ar("sort",ee,On)),_n=z(ar("jumble",On,ee));var hi={cloze:In,multipleChoice:Dn,specification:Bn,mingle:Mn,sort:Ln,jumble:_n};var gr={};G(gr,{recipes:()=>zi});var ur={};G(ur,{key:()=>_t,keySeparation:()=>K,unicodeAlphanumericPattern:()=>bi,unicodeLetterPattern:()=>fi,unicodeNumberPattern:()=>yi});var Gn="A-Za-z\\xAA\\xB5\\xBA\\xC0-\\xD6\\xD8-\\xF6\\xF8-\\u02C1\\u02C6-\\u02D1\\u02E0-\\u02E4\\u02EC\\u02EE\\u0370-\\u0374\\u0376\\u0377\\u037A-\\u037D\\u037F\\u0386\\u0388-\\u038A\\u038C\\u038E-\\u03A1\\u03A3-\\u03F5\\u03F7-\\u0481\\u048A-\\u052F\\u0531-\\u0556\\u0559\\u0561-\\u0587\\u05D0-\\u05EA\\u05F0-\\u05F2\\u0620-\\u064A\\u066E\\u066F\\u0671-\\u06D3\\u06D5\\u06E5\\u06E6\\u06EE\\u06EF\\u06FA-\\u06FC\\u06FF\\u0710\\u0712-\\u072F\\u074D-\\u07A5\\u07B1\\u07CA-\\u07EA\\u07F4\\u07F5\\u07FA\\u0800-\\u0815\\u081A\\u0824\\u0828\\u0840-\\u0858\\u08A0-\\u08B4\\u08B6-\\u08BD\\u0904-\\u0939\\u093D\\u0950\\u0958-\\u0961\\u0971-\\u0980\\u0985-\\u098C\\u098F\\u0990\\u0993-\\u09A8\\u09AA-\\u09B0\\u09B2\\u09B6-\\u09B9\\u09BD\\u09CE\\u09DC\\u09DD\\u09DF-\\u09E1\\u09F0\\u09F1\\u0A05-\\u0A0A\\u0A0F\\u0A10\\u0A13-\\u0A28\\u0A2A-\\u0A30\\u0A32\\u0A33\\u0A35\\u0A36\\u0A38\\u0A39\\u0A59-\\u0A5C\\u0A5E\\u0A72-\\u0A74\\u0A85-\\u0A8D\\u0A8F-\\u0A91\\u0A93-\\u0AA8\\u0AAA-\\u0AB0\\u0AB2\\u0AB3\\u0AB5-\\u0AB9\\u0ABD\\u0AD0\\u0AE0\\u0AE1\\u0AF9\\u0B05-\\u0B0C\\u0B0F\\u0B10\\u0B13-\\u0B28\\u0B2A-\\u0B30\\u0B32\\u0B33\\u0B35-\\u0B39\\u0B3D\\u0B5C\\u0B5D\\u0B5F-\\u0B61\\u0B71\\u0B83\\u0B85-\\u0B8A\\u0B8E-\\u0B90\\u0B92-\\u0B95\\u0B99\\u0B9A\\u0B9C\\u0B9E\\u0B9F\\u0BA3\\u0BA4\\u0BA8-\\u0BAA\\u0BAE-\\u0BB9\\u0BD0\\u0C05-\\u0C0C\\u0C0E-\\u0C10\\u0C12-\\u0C28\\u0C2A-\\u0C39\\u0C3D\\u0C58-\\u0C5A\\u0C60\\u0C61\\u0C80\\u0C85-\\u0C8C\\u0C8E-\\u0C90\\u0C92-\\u0CA8\\u0CAA-\\u0CB3\\u0CB5-\\u0CB9\\u0CBD\\u0CDE\\u0CE0\\u0CE1\\u0CF1\\u0CF2\\u0D05-\\u0D0C\\u0D0E-\\u0D10\\u0D12-\\u0D3A\\u0D3D\\u0D4E\\u0D54-\\u0D56\\u0D5F-\\u0D61\\u0D7A-\\u0D7F\\u0D85-\\u0D96\\u0D9A-\\u0DB1\\u0DB3-\\u0DBB\\u0DBD\\u0DC0-\\u0DC6\\u0E01-\\u0E30\\u0E32\\u0E33\\u0E40-\\u0E46\\u0E81\\u0E82\\u0E84\\u0E87\\u0E88\\u0E8A\\u0E8D\\u0E94-\\u0E97\\u0E99-\\u0E9F\\u0EA1-\\u0EA3\\u0EA5\\u0EA7\\u0EAA\\u0EAB\\u0EAD-\\u0EB0\\u0EB2\\u0EB3\\u0EBD\\u0EC0-\\u0EC4\\u0EC6\\u0EDC-\\u0EDF\\u0F00\\u0F40-\\u0F47\\u0F49-\\u0F6C\\u0F88-\\u0F8C\\u1000-\\u102A\\u103F\\u1050-\\u1055\\u105A-\\u105D\\u1061\\u1065\\u1066\\u106E-\\u1070\\u1075-\\u1081\\u108E\\u10A0-\\u10C5\\u10C7\\u10CD\\u10D0-\\u10FA\\u10FC-\\u1248\\u124A-\\u124D\\u1250-\\u1256\\u1258\\u125A-\\u125D\\u1260-\\u1288\\u128A-\\u128D\\u1290-\\u12B0\\u12B2-\\u12B5\\u12B8-\\u12BE\\u12C0\\u12C2-\\u12C5\\u12C8-\\u12D6\\u12D8-\\u1310\\u1312-\\u1315\\u1318-\\u135A\\u1380-\\u138F\\u13A0-\\u13F5\\u13F8-\\u13FD\\u1401-\\u166C\\u166F-\\u167F\\u1681-\\u169A\\u16A0-\\u16EA\\u16F1-\\u16F8\\u1700-\\u170C\\u170E-\\u1711\\u1720-\\u1731\\u1740-\\u1751\\u1760-\\u176C\\u176E-\\u1770\\u1780-\\u17B3\\u17D7\\u17DC\\u1820-\\u1877\\u1880-\\u1884\\u1887-\\u18A8\\u18AA\\u18B0-\\u18F5\\u1900-\\u191E\\u1950-\\u196D\\u1970-\\u1974\\u1980-\\u19AB\\u19B0-\\u19C9\\u1A00-\\u1A16\\u1A20-\\u1A54\\u1AA7\\u1B05-\\u1B33\\u1B45-\\u1B4B\\u1B83-\\u1BA0\\u1BAE\\u1BAF\\u1BBA-\\u1BE5\\u1C00-\\u1C23\\u1C4D-\\u1C4F\\u1C5A-\\u1C7D\\u1C80-\\u1C88\\u1CE9-\\u1CEC\\u1CEE-\\u1CF1\\u1CF5\\u1CF6\\u1D00-\\u1DBF\\u1E00-\\u1F15\\u1F18-\\u1F1D\\u1F20-\\u1F45\\u1F48-\\u1F4D\\u1F50-\\u1F57\\u1F59\\u1F5B\\u1F5D\\u1F5F-\\u1F7D\\u1F80-\\u1FB4\\u1FB6-\\u1FBC\\u1FBE\\u1FC2-\\u1FC4\\u1FC6-\\u1FCC\\u1FD0-\\u1FD3\\u1FD6-\\u1FDB\\u1FE0-\\u1FEC\\u1FF2-\\u1FF4\\u1FF6-\\u1FFC\\u2071\\u207F\\u2090-\\u209C\\u2102\\u2107\\u210A-\\u2113\\u2115\\u2119-\\u211D\\u2124\\u2126\\u2128\\u212A-\\u212D\\u212F-\\u2139\\u213C-\\u213F\\u2145-\\u2149\\u214E\\u2183\\u2184\\u2C00-\\u2C2E\\u2C30-\\u2C5E\\u2C60-\\u2CE4\\u2CEB-\\u2CEE\\u2CF2\\u2CF3\\u2D00-\\u2D25\\u2D27\\u2D2D\\u2D30-\\u2D67\\u2D6F\\u2D80-\\u2D96\\u2DA0-\\u2DA6\\u2DA8-\\u2DAE\\u2DB0-\\u2DB6\\u2DB8-\\u2DBE\\u2DC0-\\u2DC6\\u2DC8-\\u2DCE\\u2DD0-\\u2DD6\\u2DD8-\\u2DDE\\u2E2F\\u3005\\u3006\\u3031-\\u3035\\u303B\\u303C\\u3041-\\u3096\\u309D-\\u309F\\u30A1-\\u30FA\\u30FC-\\u30FF\\u3105-\\u312D\\u3131-\\u318E\\u31A0-\\u31BA\\u31F0-\\u31FF\\u3400-\\u4DB5\\u4E00-\\u9FD5\\uA000-\\uA48C\\uA4D0-\\uA4FD\\uA500-\\uA60C\\uA610-\\uA61F\\uA62A\\uA62B\\uA640-\\uA66E\\uA67F-\\uA69D\\uA6A0-\\uA6E5\\uA717-\\uA71F\\uA722-\\uA788\\uA78B-\\uA7AE\\uA7B0-\\uA7B7\\uA7F7-\\uA801\\uA803-\\uA805\\uA807-\\uA80A\\uA80C-\\uA822\\uA840-\\uA873\\uA882-\\uA8B3\\uA8F2-\\uA8F7\\uA8FB\\uA8FD\\uA90A-\\uA925\\uA930-\\uA946\\uA960-\\uA97C\\uA984-\\uA9B2\\uA9CF\\uA9E0-\\uA9E4\\uA9E6-\\uA9EF\\uA9FA-\\uA9FE\\uAA00-\\uAA28\\uAA40-\\uAA42\\uAA44-\\uAA4B\\uAA60-\\uAA76\\uAA7A\\uAA7E-\\uAAAF\\uAAB1\\uAAB5\\uAAB6\\uAAB9-\\uAABD\\uAAC0\\uAAC2\\uAADB-\\uAADD\\uAAE0-\\uAAEA\\uAAF2-\\uAAF4\\uAB01-\\uAB06\\uAB09-\\uAB0E\\uAB11-\\uAB16\\uAB20-\\uAB26\\uAB28-\\uAB2E\\uAB30-\\uAB5A\\uAB5C-\\uAB65\\uAB70-\\uABE2\\uAC00-\\uD7A3\\uD7B0-\\uD7C6\\uD7CB-\\uD7FB\\uF900-\\uFA6D\\uFA70-\\uFAD9\\uFB00-\\uFB06\\uFB13-\\uFB17\\uFB1D\\uFB1F-\\uFB28\\uFB2A-\\uFB36\\uFB38-\\uFB3C\\uFB3E\\uFB40\\uFB41\\uFB43\\uFB44\\uFB46-\\uFBB1\\uFBD3-\\uFD3D\\uFD50-\\uFD8F\\uFD92-\\uFDC7\\uFDF0-\\uFDFB\\uFE70-\\uFE74\\uFE76-\\uFEFC\\uFF21-\\uFF3A\\uFF41-\\uFF5A\\uFF66-\\uFFBE\\uFFC2-\\uFFC7\\uFFCA-\\uFFCF\\uFFD2-\\uFFD7\\uFFDA-\\uFFDC",zn="0-9\\xB2\\xB3\\xB9\\xBC-\\xBE\\u0660-\\u0669\\u06F0-\\u06F9\\u07C0-\\u07C9\\u0966-\\u096F\\u09E6-\\u09EF\\u09F4-\\u09F9\\u0A66-\\u0A6F\\u0AE6-\\u0AEF\\u0B66-\\u0B6F\\u0B72-\\u0B77\\u0BE6-\\u0BF2\\u0C66-\\u0C6F\\u0C78-\\u0C7E\\u0CE6-\\u0CEF\\u0D58-\\u0D5E\\u0D66-\\u0D78\\u0DE6-\\u0DEF\\u0E50-\\u0E59\\u0ED0-\\u0ED9\\u0F20-\\u0F33\\u1040-\\u1049\\u1090-\\u1099\\u1369-\\u137C\\u16EE-\\u16F0\\u17E0-\\u17E9\\u17F0-\\u17F9\\u1810-\\u1819\\u1946-\\u194F\\u19D0-\\u19DA\\u1A80-\\u1A89\\u1A90-\\u1A99\\u1B50-\\u1B59\\u1BB0-\\u1BB9\\u1C40-\\u1C49\\u1C50-\\u1C59\\u2070\\u2074-\\u2079\\u2080-\\u2089\\u2150-\\u2182\\u2185-\\u2189\\u2460-\\u249B\\u24EA-\\u24FF\\u2776-\\u2793\\u2CFD\\u3007\\u3021-\\u3029\\u3038-\\u303A\\u3192-\\u3195\\u3220-\\u3229\\u3248-\\u324F\\u3251-\\u325F\\u3280-\\u3289\\u32B1-\\u32BF\\uA620-\\uA629\\uA6E6-\\uA6EF\\uA830-\\uA835\\uA8D0-\\uA8D9\\uA900-\\uA909\\uA9D0-\\uA9D9\\uA9F0-\\uA9F9\\uAA50-\\uAA59\\uABF0-\\uABF9\\uFF10-\\uFF19",fi=new RegExp(`[${Gn}]`,"gu"),yi=new RegExp(`[${zn}]`,"gu"),bi=new RegExp(`[${Gn}${zn}]`,"gu");var Ti=/<img[^>]*?src="(.+?)"[^>]*>/g,xi=(t,e)=>{let r=[],n;do n=Ti.exec(t),n&&r.push([n[1],e]);while(n);return r},xt=t=>{let e=([r,n])=>typeof n=="string"?[]:xi(r,n.getRootNode());return t.textFragments.map((r,n)=>[r,t.inputs[n]]).flatMap(e)},de=t=>{if(navigator.userAgent.search("Chrome")>=0)return[t.offsetX,t.offsetY];{let e=t.currentTarget,r=e.getBoundingClientRect(),n=e.parentElement.getBoundingClientRect(),s=t.layerX-(n.left-r.left),o=t.layerY-(n.top-r.top);return[s,o]}},vt=(t,e,r)=>{let n=e.querySelector(t);n&&(n.complete?r({target:n}):n.addEventListener("load",r))},Wn=t=>{let e=0;for(let r of t){let n=r.match(K);if(!n)continue;let s=Number(n[2]);Number.isNaN(s)||(e=Math.max(e,s))}return e},kt="occlusionSvgCss",St=`
img {
  max-width: 100% !important;
}

.anking-occlusion-container {
  display: inline-block;
  position: relative;
}

.anking-occlusion-container > * {
  display: block;

  margin-left: auto;
  margin-right: auto;
}

.anking-occlusion-container > svg {
  position: absolute;
  top: 0;
}

.anking-shape > text {
  text-anchor: middle;
  dominant-baseline: central;
  pointer-events: none;
}`;var At="http://www.w3.org/2000/svg",Ae=class t{constructor(e,r,n){this.scaleFactorX=1;this.scaleFactorY=1;this.maxOcclusions=500;this.elements=[];this.container=e,this.image=r,this.svg=n,this.resizer=new globalThis.ResizeObserver(()=>this.resize()),this.resizer.observe(r),this.setScaleFactors()}setScaleFactors(){this.scaleFactorX=this.image.width/this.image.naturalWidth,this.scaleFactorY=this.image.height/this.image.naturalHeight}static wrapImage(e){let r=document.createElement("div");e.parentNode&&e.parentNode.replaceChild(r,e),r.appendChild(e);let n=document.createElementNS(At,"svg");n.setAttributeNS(null,"width","100%"),n.setAttributeNS(null,"height","100%");let s=window.getComputedStyle(e);return n.style.zoom=s.getPropertyValue("zoom"),n.style.transform=s.getPropertyValue("transform"),r.appendChild(n),r.classList.add("anking-occlusion-container"),new t(r,e,n)}get scaleFactors(){return[this.scaleFactorX,this.scaleFactorY]}resize(){if(this.setScaleFactors(),this.scaleFactors.includes(0)){this.resizer.disconnect();return}for(let e of this.elements)e.resize(this)}append(e){this.elements.push(e);for(let r of e.getElements())this.svg.appendChild(r)}getElements(){return this.elements}getLabels(){return this.getElements().map(e=>e.getLabel())}remove(e){this.elements.find((r,n)=>{if(r.getAnchorElement()===e.getAnchorElement()){for(let s of e.getElements())s.remove();return this.elements.splice(n,1),!0}})}setMaxOcclusions(e){this.maxOcclusions=e}getNextNum(e){let r=e.altKey?0:1,n=Math.max(1,Wn(this.getLabels())+r);return n>this.maxOcclusions?0:n}cleanup(){let e=this.container.removeChild(this.image);this.container.replaceWith(e)}},ge=class t{constructor(e,r,n,s,o){this.scaleFactorX=1;this.scaleFactorY=1;this.container=e,this.rect=r,this.label=n,this.setScaleFactors(s,o)}static make(e){let r=document.createElementNS(At,"svg"),n=document.createElementNS(At,"rect"),s=document.createElementNS(At,"text");r.appendChild(n),r.appendChild(s),r.classList.add("anking-rect"),r.classList.add("anking-shape"),r.tabIndex=-1;let[o,l]=e?e.scaleFactors:[1,1];return new t(r,n,s,o,l)}static wrap(e,r){let[n,s]=r?r.scaleFactors:[1,1];return new t(e.parentElement,e,e.nextSibling,n,s)}remove(){this.container.remove()}getElements(){return[this.container]}getAnchorElement(){return this.rect}getLabel(){return this.labelText}setScaleFactors(e,r){this.scaleFactorX=e,this.scaleFactorY=r}readjust(e){let r=e?e.scaleFactors:[1,1],n=this.scaleFactorX,s=this.scaleFactorY;return this.setScaleFactors(r[0],r[1]),[n,s]}resize(e){let r=this.pos;this.readjust(e),this.pos=r}toDefinition(){return["rect",void 0,this.labelText,this.x,this.y,this.width,this.height,{}]}toText(e){return`${e.open}${this.labelText}${e.sep}${this.x.toFixed()},${this.y.toFixed()},${this.width.toFixed()},${this.height.toFixed()}${e.close}`}fontSizeUpdate(){let[e,r]=this.readjust(),n=Math.max(.1,Math.min(32,.4*((this.width+this.height)/2-2*this.strokeWidth)));this.fontSize=n,this.setScaleFactors(e,r)}get pos(){return[this.x,this.y,this.width,this.height]}set pos([e,r,n,s]){this.width=n,this.height=s,this.x=e,this.y=r}get scaled(){return[Number(this.rect.getAttributeNS(null,"x")),Number(this.rect.getAttributeNS(null,"y")),Number(this.rect.getAttributeNS(null,"width")),Number(this.rect.getAttributeNS(null,"height"))]}get x(){return Number(this.rect.getAttributeNS(null,"x"))/this.scaleFactorX}set x(e){let r=e*this.scaleFactorX,n=(e+this.width/2)*this.scaleFactorX;this.rect.setAttributeNS(null,"x",String(r)),this.label.setAttributeNS(null,"x",String(n))}get y(){return Number(this.rect.getAttributeNS(null,"y"))/this.scaleFactorY}set y(e){let r=e*this.scaleFactorY,n=(e+this.height/2)*this.scaleFactorY;this.rect.setAttributeNS(null,"y",String(r)),this.label.setAttributeNS(null,"y",String(n))}get width(){return Number(this.rect.getAttributeNS(null,"width"))/this.scaleFactorX}set width(e){let r=String(Math.max(10,e)*this.scaleFactorX);this.rect.setAttributeNS(null,"width",r),this.label.setAttributeNS(null,"width",r),this.fontSizeUpdate()}get height(){return Number(this.rect.getAttributeNS(null,"height"))/this.scaleFactorY}set height(e){let r=String(Math.max(10,e)*this.scaleFactorY);this.rect.setAttributeNS(null,"height",r),this.label.setAttributeNS(null,"height",r),this.fontSizeUpdate()}props(e){for(let r in e){let n=r;this.prop(n,e[n])}}prop(e,r){this[e]=r}set containerClasses(e){e.split(" ").forEach(r=>this.container.classList.add(r))}get containerClasses(){return Array.from(this.container.className).join(" ")}set rx(e){this.rect.setAttributeNS(null,"rx",String(e))}get rx(){return Number(this.rect.getAttributeNS(null,"rx"))}set ry(e){this.rect.setAttributeNS(null,"ry",String(e))}get ry(){return Number(this.rect.getAttributeNS(null,"ry"))}set fill(e){this.rect.setAttributeNS(null,"fill",e)}get fill(){var e;return(e=this.rect.getAttributeNS(null,"fill"))!=null?e:""}set fillOpacity(e){this.rect.setAttributeNS(null,"fill-opacity",String(e))}get fillOpacity(){return Number(this.rect.getAttributeNS(null,"fill-opacity"))}set stroke(e){this.rect.setAttributeNS(null,"stroke",e)}get stroke(){var e;return(e=this.rect.getAttributeNS(null,"stroke"))!=null?e:""}set strokeOpacity(e){this.rect.setAttributeNS(null,"stroke-opacity",String(e))}get strokeOpacity(){return Number(this.rect.getAttributeNS(null,"stroke-opacity"))}set strokeWidth(e){this.rect.setAttributeNS(null,"stroke-width",String(e))}get strokeWidth(){return Number(this.rect.getAttributeNS(null,"stroke-width"))}set classes(e){e.split(" ").forEach(r=>this.rect.classList.add(r))}get classes(){return Array.from(this.rect.classList).join(" ")}set labelText(e){this.label.innerHTML=e}get labelText(){return this.label.innerHTML}set fontSize(e){this.label.setAttributeNS(null,"font-size",String(e))}get fontSize(){return Number(this.label.getAttributeNS(null,"font-size"))}set labelClasses(e){e.split(" ").forEach(r=>this.label.classList.add(r))}get labelClasses(){return Array.from(this.label.classList).join(" ")}};var cr=(t,e,r,n,s,o,l,u)=>i=>{let[a,c]=t(de(i));r&&a<l?(e.x=a,e.width=l-a):n&&(e.x=l,e.width=a-l),s&&c<u?(e.y=c,e.height=u-c):o&&(e.y=u,e.height=c-u)},Vn=(t,e,r,n,s,o)=>l=>{let[u,i]=t(de(l)),a=r+(u-s),c=n+(i-o);e.x=a,e.y=c},Hn=(t,e,r,n,s,o,l,u,i)=>(a,c,m)=>{let[d,f,y,v]=a.scaled,x=c-d,R=d+y-c,C=m-f,I=f+v-m;return x<=5?C<=5?t(a):I<=5?e(a):r(a):R<=5?C<=5?n(a):I<=5?s(a):o(a):C<=5?l(a):I<=5?u(a):i(a)},Un=Hn(t=>[!0,!1,!0,!1,t.x+t.width,t.y+t.height],t=>[!0,!1,!1,!0,t.x+t.width,t.y],t=>[!0,!1,!1,!1,t.x+t.width,0],t=>[!1,!0,!0,!1,t.x,t.y+t.height],t=>[!1,!0,!1,!0,t.x,t.y],t=>[!1,!0,!1,!1,t.x,0],t=>[!1,!1,!0,!1,0,t.y+t.height],t=>[!1,!1,!1,!0,0,t.y],()=>[!1,!1,!1,!1,0,0]),vi=Hn(()=>"nwse-resize",()=>"nesw-resize",()=>"ew-resize",()=>"nesw-resize",()=>"nwse-resize",()=>"ew-resize",()=>"ns-resize",()=>"ns-resize",()=>"move"),qn=(t,e)=>r=>{if(r.shiftKey)e.rect.style.cursor="no-drop";else{let[n,s]=t(de(r)),o=vi(e,n,s);e.rect.style.cursor=o}};var ki=t=>([e,r])=>{let n=t.getPropertyValue("zoom"),s=Number(n);return Number.isNaN(s)||s<=0?[e,r]:[e/s,r/s]},Ft=t=>([e,r])=>ki(t)([e,r]);var Si=t=>{let e=document.createElement("li"),r=document.createElement("a");return t.html?r.innerHTML=t.label:r.innerText=t.label,r.id=t.itemId,r.classList.add("context-menu-item"),t.clickEvent&&r.addEventListener("click",t.clickEvent),e.appendChild(r),t.sub&&t.sub.length>0&&e.appendChild(jn(t.sub)),e},jn=t=>{let e=document.createElement("ul"),r=t.map(Si);for(let n of r)e.appendChild(n);return e},Kn=(t,e)=>{let r=document.createElement("nav");return r.classList.add("context-menu"),r.id=t,r.appendChild(jn(e)),r};var Xn=`
:root {
  --cm-niceblue: #3f8cf1;
  --cm-nicegray: #444;
  --cm-backgray: #ececec;
  --cm-boxgray: #cfcfcf;
}

nav.context-menu {
  position: absolute;
  z-index: 9999;
  display: none;
}

nav.context-menu--active {
  display: block;
}

/******************** UL */

nav.context-menu ul {
  position: absolute;

  padding: 0.2rem 0;
  width: 10rem;

  white-space: nowrap;
  list-style: none;

  background-color: var(--cm-backgray);
  border: solid 1px var(--cm-boxgray);
  box-shadow: 1px 1px 2px var(--cm-boxgray);
}

/******************** LI */

nav.context-menu li {
  margin-bottom: 2px;
}

nav.context-menu li.context-menu--hover {
  background-color: var(--cm-niceblue);
}

nav.context-menu li:last-child {
  margin-bottom: 0;
}

nav.context-menu li ul {
  display: none;
  margin-left: 2rem;
}

nav.context-menu li.context-menu--hover ul {
  display: block;
}

nav.context-menu li li ul {
  display: none;
  margin-left: 4rem;
}

nav.context-menu li li.context-menu--hover ul {
  display: block;
}

/******************** A */

nav.context-menu a {
  display: block;
  padding: 0.3rem 1rem;
  user-select: none;

  color: var(--cm-nicegray);
}

nav.context-menu li.context-menu--hover a {
  color: white;
}
`,Jn=t=>()=>{t.classList.remove("context-menu--active")},Ai=(t,e,r)=>{t.style.left=`${e}px`,t.style.top=`${r}px`},Fi=t=>{t.addEventListener("click",e=>{e.stopPropagation()}),t.querySelectorAll("li").forEach(e=>{e.addEventListener("mouseenter",()=>{e.classList.add("context-menu--hover")}),e.addEventListener("mouseleave",()=>{e.classList.remove("context-menu--hover")}),e.addEventListener("click",()=>{Jn(t)()})})},pr=(t,e)=>{let r=Jn(t);e.addEventListener("contextmenu",n=>{n.preventDefault(),n.stopPropagation(),document.querySelectorAll(".context-menu--active").forEach(s=>s.classList.remove("context-menu--active")),t.classList.add("context-menu--active"),window.addEventListener("click",r,{once:!0}),Ai(t,n.pageX,n.pageY)})},mr=(t,e)=>{let r=Kn(t,e);return document.body.insertAdjacentElement("beforeend",r),Fi(r),r};var Rt="occlusionRenderRect",wi=(t,{template:e,cache:r})=>{let n=xt(e),s=r.get(t.keyword,[]),o=n[0];o&&vt(`img[src="${o[0]}"]`,o[1],l=>{e.appendStyle(l.target,kt,St);let i=Ae.wrapImage(l.target);for(let[,a,,c,m,g,d,f]of s){if(!a)continue;let y=ge.make(i);`${c}${m}${g}${d}`,y.pos=[c,m,g,d];for(let v in f){let x=v;y.prop(x,f[x])}i.append(y)}})},Ri=(t,e={})=>{let r={};return t.map(n=>n.split("=")).forEach(([n,s])=>r[n]=s),Object.assign(r,e)},wt=t=>(e,r)=>{let[n=0,s=0,o=50,l=o,...u]=e.values,i=typeof t=="function"?t(e,r):t;return r.cache.over(Rt,a=>a.push(["rect",!0,e.fullKey,Number(n),Number(s),Number(o),Number(l),Ri(u,i)]),[]),r.aftermath.registerIfNotExists(Rt,wi),{ready:!0}},dr={classes:"anking-rect__rect",labelClasses:"anking-rect__label"},Ei={classes:"anking-rect__ellipsis",labelClasses:"anking-rect__ellipsis"},Ni="is-active is-front",Ii="is-active is-back",Yn="is-inactive",Ci=(t,e)=>(r={})=>{let{tagname:n="rect",front:s=wt,back:o=wt,optics:l=[E({sep:","})],flashcardTemplate:u=q(),frontProperties:i=ie(oe({},dr),{containerClasses:Ni}),backProperties:a=ie(oe({},dr),{containerClasses:Ii}),ellipseProperties:c=ie(oe({},Ei),{containerClasses:Yn}),contextProperties:m=ie(oe({},dr),{containerClasses:Yn})}=r,g={optics:l};return u(t,e)(n,s(i),o(a),wt(c),wt(m),g)},Qn=z(Ci);var Di=(t,e)=>{let r=ge.wrap(e.target);if(e.shiftKey){t.remove(r);return}let n=Ft(window.getComputedStyle(t.image)),[s,o]=n(de(e)),l=Un(r,s,o),u=l.includes(!0)?cr(n,r,...l):Vn(n,r,r.x,r.y,s,o);t.svg.addEventListener("mousemove",u),t.svg.addEventListener("mouseup",i=>{i.preventDefault(),t.svg.removeEventListener("mousemove",u)},{once:!0})},es=(t,e)=>{let r=Ft(window.getComputedStyle(t.image));e.rect.addEventListener("mousemove",qn(r,e));let n=mr("occlusion-shape-menu",[{label:"Change Label",itemId:"change-label",clickEvent:()=>{let s=prompt("Specify the new label",e.labelText);typeof s=="string"&&(e.labelText=s)}},{label:"Close Menu",itemId:"close-occlusion-menu"}]);pr(n,e.rect),t.append(e)},ts=(t,e,r,n,s)=>{let o=ge.make();return o.pos=[t,e,r,n],o.labelText=s,o.classes="anking-rect__rect",o.labelClasses="anking-rect__label",o},Bi=(t,e)=>{let r=null,n=null,s=null,o=null,l=null,u=null,[i,,...a]=e;switch(i){case"rect":[r,n,s,o,l]=a,u=ts(n,s,o,l,r),es(t,u);break;default:}},Pi=(t,e)=>{let r=Ft(window.getComputedStyle(t.image)),[n,s]=r(de(e)),o=t.getNextNum(e),l=ts(n,s,0,0,`rect${o}`);es(t,l);let u=cr(r,l,!0,!0,!0,!0,n,s);t.svg.addEventListener("mousemove",u),t.svg.addEventListener("mouseup",()=>{t.svg.removeEventListener("mousemove",u),l.readjust(t)})},$i=(t,e)=>{e.preventDefault(),(e.target.nodeName!=="svg"?Di:Pi)(t,e)},Oi=(t,e)=>{let n=e([{label:"Accept occlusions",itemId:"occlusion-accept",clickEvent:s=>{s.preventDefault(),t.dispatchEvent(new Event("accept"))}},{label:"Close Menu",itemId:"close-occlusion-menu"}]);return mr("occlusion-menu",n)},Mi=(t,e)=>{let r=n=>{n.button===0&&$i(t,n)};t.svg.addEventListener("mousedown",r),pr(e,t.svg)},Li=(t,e)=>r=>{navigator.clipboard.writeText(r.map(n=>n.toText(e.template.parser.delimiters)).join(`
`)).catch(()=>console.log("Window needs active focus for copying to clipboard"))},_i=()=>(t,e)=>e.cleanup(),Gi=`
.anking-occlusion-container {
  outline: 3px dotted hotpink;
  outline-offset: -3px;
}`,Zn="occlusionMakerCss",rs=(t={})=>e=>{let r="makeOcclusions",n=new EventTarget,{tagname:s=r,maxOcclusions:o=500,acceptHandler:l=Li,rejectHandler:u=_i,setupOcclusionMenu:i=$,existingShapesFilter:a=()=>$,shapeKeywords:c=[Rt]}=t,m=(g,d)=>{let f=d.template,y=xt(f);return d.aftermath.registerIfNotExists(r,(v,x)=>{let R=[];for(let I of c){let O=x.cache.get(I,[]);R.push(...O),x.aftermath.block(I)}let C=I=>{let O=I.target,D=x.template;D.appendDocumentStyle(Zn,Xn),D.appendStyle(O,Zn,Gi),D.appendStyle(O,kt,St);let W=Ae.wrapImage(O);W.setMaxOcclusions(o),a(v,x)(R,W).forEach(h=>Bi(W,h));let Fe=()=>{l(v,x)(W.getElements(),W)},te=()=>{u(v,x)(W.getElements(),W)};n.addEventListener("accept",Fe),n.addEventListener("reject",te);let p=Oi(n,i);Mi(W,p)};for(let[I,O]of y)vt(`img[src="${I}"]`,O,C)},{priority:100}),{ready:!0}};return e.register(s,m),n};var zi={occlusionEditor:rs,rect:Qn};var hr={};G(hr,{aftermath:()=>An,collection:()=>bt,deferred:()=>Sn,product:()=>ns,sum:()=>ft,sumFour:()=>yt,wrap:()=>nr});var ns=(t,e,r=()=>()=>({ready:!0}),{wrapId:n,setTagnames:s}={wrapId:"product",getTagnames:J,setTagnames:Y})=>({tagname:o="prod",optionsFirst:l={},optionsSecond:u={}}={})=>i=>{let a=`${o}:${n}:fst`,c=`${o}:${n}:snd`;t(s(l,[a]))(i),e(s(u,[c]))(i);let m=(g,d)=>r(d.filters.getOrDefault(a)(g,d),d.filters.getOrDefault(c)(g,d))(g,d);i.register(o,m,i.getOptions(a))};export{vr as FilterManager,L as Stylizer,gr as browser,lr as flashcard,ur as patterns,er as recipes,Qt as sequencers,Zt as sortInStrategies,Ut as template,hr as wrappers};
