var nn=Object.create;var _e=Object.defineProperty,on=Object.defineProperties,an=Object.getOwnPropertyDescriptor,ln=Object.getOwnPropertyDescriptors,un=Object.getOwnPropertyNames,fr=Object.getOwnPropertySymbols,cn=Object.getPrototypeOf,br=Object.prototype.hasOwnProperty,pn=Object.prototype.propertyIsEnumerable;var yr=(t,e,r)=>e in t?_e(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,oe=(t,e)=>{for(var r in e||(e={}))br.call(e,r)&&yr(t,r,e[r]);if(fr)for(var r of fr(e))pn.call(e,r)&&yr(t,r,e[r]);return t},ie=(t,e)=>on(t,ln(e));var Tr=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),_=(t,e)=>{for(var r in e)_e(t,r,{get:e[r],enumerable:!0})},mn=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of un(e))!br.call(t,n)&&n!==r&&_e(t,n,{get:()=>e[n],enumerable:!(s=an(e,n))||s.enumerable});return t};var ze=(t,e,r)=>(r=t!=null?nn(cn(t)):{},mn(e||!t||!t.__esModule?_e(r,"default",{value:t,enumerable:!0}):r,t));var Pt=Tr((Rr,tt)=>{(function(t,e){typeof tt=="object"&&tt.exports?tt.exports=e():t.nearley=e()})(Rr,function(){function t(i,a,c){return this.id=++t.highestId,this.name=i,this.symbols=a,this.postprocess=c,this}t.highestId=0,t.prototype.toString=function(i){var a=typeof i=="undefined"?this.symbols.map(u).join(" "):this.symbols.slice(0,i).map(u).join(" ")+" \u25CF "+this.symbols.slice(i).map(u).join(" ");return this.name+" \u2192 "+a};function e(i,a,c,m){this.rule=i,this.dot=a,this.reference=c,this.data=[],this.wantedBy=m,this.isComplete=this.dot===i.symbols.length}e.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},e.prototype.nextState=function(i){var a=new e(this.rule,this.dot+1,this.reference,this.wantedBy);return a.left=this,a.right=i,a.isComplete&&(a.data=a.build(),a.right=void 0),a},e.prototype.build=function(){var i=[],a=this;do i.push(a.right.data),a=a.left;while(a.left);return i.reverse(),i},e.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,o.fail))};function r(i,a){this.grammar=i,this.index=a,this.states=[],this.wants={},this.scannable=[],this.completed={}}r.prototype.process=function(i){for(var a=this.states,c=this.wants,m=this.completed,h=0;h<a.length;h++){var d=a[h];if(d.isComplete){if(d.finish(),d.data!==o.fail){for(var f=d.wantedBy,y=f.length;y--;){var v=f[y];this.complete(v,d)}if(d.reference===this.index){var x=d.rule.name;(this.completed[x]=this.completed[x]||[]).push(d)}}}else{var x=d.rule.symbols[d.dot];if(typeof x!="string"){this.scannable.push(d);continue}if(c[x]){if(c[x].push(d),m.hasOwnProperty(x))for(var R=m[x],y=0;y<R.length;y++){var C=R[y];this.complete(d,C)}}else c[x]=[d],this.predict(x)}}},r.prototype.predict=function(i){for(var a=this.grammar.byName[i]||[],c=0;c<a.length;c++){var m=a[c],h=this.wants[i],d=new e(m,0,this.index,h);this.states.push(d)}},r.prototype.complete=function(i,a){var c=i.nextState(a);this.states.push(c)};function s(i,a){this.rules=i,this.start=a||this.rules[0].name;var c=this.byName={};this.rules.forEach(function(m){c.hasOwnProperty(m.name)||(c[m.name]=[]),c[m.name].push(m)})}s.fromCompiled=function(m,a){var c=m.Lexer;m.ParserStart&&(a=m.ParserStart,m=m.ParserRules);var m=m.map(function(d){return new t(d.name,d.symbols,d.postprocess)}),h=new s(m,a);return h.lexer=c,h};function n(){this.reset("")}n.prototype.reset=function(i,a){this.buffer=i,this.index=0,this.line=a?a.line:1,this.lastLineBreak=a?-a.col:0},n.prototype.next=function(){if(this.index<this.buffer.length){var i=this.buffer[this.index++];return i===`
`&&(this.line+=1,this.lastLineBreak=this.index),{value:i}}},n.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},n.prototype.formatError=function(i,a){var c=this.buffer;if(typeof c=="string"){var m=c.split(`
`).slice(Math.max(0,this.line-5),this.line),h=c.indexOf(`
`,this.index);h===-1&&(h=c.length);var d=this.index-this.lastLineBreak,f=String(this.line).length;return a+=" at line "+this.line+" col "+d+`:

`,a+=m.map(function(v,x){return y(this.line-m.length+x+1,f)+" "+v},this).join(`
`),a+=`
`+y("",f+d)+`^
`,a}else return a+" at index "+(this.index-1);function y(v,x){var R=String(v);return Array(x-R.length+1).join(" ")+R}};function o(i,a,c){if(i instanceof s)var m=i,c=a;else var m=s.fromCompiled(i,a);this.grammar=m,this.options={keepHistory:!1,lexer:m.lexer||new n};for(var h in c||{})this.options[h]=c[h];this.lexer=this.options.lexer,this.lexerState=void 0;var d=new r(m,0),f=this.table=[d];d.wants[m.start]=[],d.predict(m.start),d.process(),this.current=0}o.fail={},o.prototype.feed=function(i){var a=this.lexer;a.reset(i,this.lexerState);for(var c;;){try{if(c=a.next(),!c)break}catch(D){var f=new r(this.grammar,this.current+1);this.table.push(f);var m=new Error(this.reportLexerError(D));throw m.offset=this.current,m.token=D.token,m}var h=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var d=this.current+1,f=new r(this.grammar,d);this.table.push(f);for(var y=c.text!==void 0?c.text:c.value,v=a.constructor===n?c.value:c,x=h.scannable,R=x.length;R--;){var C=x[R],I=C.rule.symbols[C.dot];if(I.test?I.test(v):I.type?I.type===c.type:I.literal===y){var O=C.nextState({data:v,token:c,isToken:!0,reference:d-1});f.states.push(O)}}if(f.process(),f.states.length===0){var m=new Error(this.reportError(c));throw m.offset=this.current,m.token=c,m}this.options.keepHistory&&(h.lexerState=a.save()),this.current++}return h&&(this.lexerState=a.save()),this.results=this.finish(),this},o.prototype.reportLexerError=function(i){var a,c,m=i.token;return m?(a="input "+JSON.stringify(m.text[0])+" (lexer error)",c=this.lexer.formatError(m,"Syntax error")):(a="input (lexer error)",c=i.message),this.reportErrorCommon(c,a)},o.prototype.reportError=function(i){var a=(i.type?i.type+" token: ":"")+JSON.stringify(i.value!==void 0?i.value:i),c=this.lexer.formatError(i,"Syntax error");return this.reportErrorCommon(c,a)},o.prototype.reportErrorCommon=function(i,a){var c=[];c.push(i);var m=this.table.length-2,h=this.table[m],d=h.states.filter(function(y){var v=y.rule.symbols[y.dot];return v&&typeof v!="string"});if(d.length===0)c.push("Unexpected "+a+`. I did not expect any more input. Here is the state of my parse table:
`),this.displayStateStack(h.states,c);else{c.push("Unexpected "+a+`. Instead, I was expecting to see one of the following:
`);var f=d.map(function(y){return this.buildFirstStateStack(y,[])||[y]},this);f.forEach(function(y){var v=y[0],x=v.rule.symbols[v.dot],R=this.getSymbolDisplay(x);c.push("A "+R+" based on:"),this.displayStateStack(y,c)},this)}return c.push(""),c.join(`
`)},o.prototype.displayStateStack=function(i,a){for(var c,m=0,h=0;h<i.length;h++){var d=i[h],f=d.rule.toString(d.dot);f===c?m++:(m>0&&a.push("    ^ "+m+" more lines identical to this"),m=0,a.push("    "+f)),c=f}},o.prototype.getSymbolDisplay=function(i){return l(i)},o.prototype.buildFirstStateStack=function(i,a){if(a.indexOf(i)!==-1)return null;if(i.wantedBy.length===0)return[i];var c=i.wantedBy[0],m=[i].concat(a),h=this.buildFirstStateStack(c,m);return h===null?null:[i].concat(h)},o.prototype.save=function(){var i=this.table[this.current];return i.lexerState=this.lexerState,i},o.prototype.restore=function(i){var a=i.index;this.current=a,this.table[a]=i,this.table.splice(a+1),this.lexerState=i.lexerState,this.results=this.finish()},o.prototype.rewind=function(i){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[i])},o.prototype.finish=function(){var i=[],a=this.grammar.start,c=this.table[this.table.length-1];return c.states.forEach(function(m){m.rule.name===a&&m.dot===m.rule.symbols.length&&m.reference===0&&m.data!==o.fail&&i.push(m)}),i.map(function(m){return m.data})};function l(i){var a=typeof i;if(a==="string")return i;if(a==="object"){if(i.literal)return JSON.stringify(i.literal);if(i instanceof RegExp)return"character matching "+i;if(i.type)return i.type+" token";if(i.test)return"token matching "+String(i.test);throw new Error("Unknown symbol type: "+i)}}function u(i){var a=typeof i;if(a==="string")return i;if(a==="object"){if(i.literal)return JSON.stringify(i.literal);if(i instanceof RegExp)return i.toString();if(i.type)return"%"+i.type;if(i.test)return"<"+String(i.test)+">";throw new Error("Unknown symbol type: "+i)}}return{Parser:o,Grammar:s,Rule:t}})});var Lt=Tr((Ir,rt)=>{(function(t,e){typeof define=="function"&&define.amd?define([],e):typeof rt=="object"&&rt.exports?rt.exports=e():t.moo=e()})(Ir,function(){"use strict";var t=Object.prototype.hasOwnProperty,e=Object.prototype.toString,r=typeof new RegExp().sticky=="boolean";function s(p){return p&&e.call(p)==="[object RegExp]"}function n(p){return p&&typeof p=="object"&&!s(p)&&!Array.isArray(p)}function o(p){return p.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function l(p){var g=new RegExp("|"+p);return g.exec("").length-1}function u(p){return"("+p+")"}function i(p){if(!p.length)return"(?!)";var g=p.map(function(b){return"(?:"+b+")"}).join("|");return"(?:"+g+")"}function a(p){if(typeof p=="string")return"(?:"+o(p)+")";if(s(p)){if(p.ignoreCase)throw new Error("RegExp /i flag not allowed");if(p.global)throw new Error("RegExp /g flag is implied");if(p.sticky)throw new Error("RegExp /y flag is implied");if(p.multiline)throw new Error("RegExp /m flag is implied");return p.source}else throw new Error("Not a pattern: "+p)}function c(p,g){return p.length>g?p:Array(g-p.length+1).join(" ")+p}function m(p,g){for(var b=p.length,T=0;;){var A=p.lastIndexOf(`
`,b-1);if(A===-1||(T++,b=A,T===g)||b===0)break}var S=T<g?0:b+1;return p.substring(S).split(`
`)}function h(p){for(var g=Object.getOwnPropertyNames(p),b=[],T=0;T<g.length;T++){var A=g[T],S=p[A],F=[].concat(S);if(A==="include"){for(var B=0;B<F.length;B++)b.push({include:F[B]});continue}var w=[];F.forEach(function(k){n(k)?(w.length&&b.push(f(A,w)),b.push(f(A,k)),w=[]):w.push(k)}),w.length&&b.push(f(A,w))}return b}function d(p){for(var g=[],b=0;b<p.length;b++){var T=p[b];if(T.include){for(var A=[].concat(T.include),S=0;S<A.length;S++)g.push({include:A[S]});continue}if(!T.type)throw new Error("Rule has no type: "+JSON.stringify(T));g.push(f(T.type,T))}return g}function f(p,g){if(n(g)||(g={match:g}),g.include)throw new Error("Matching rules cannot also include states");var b={defaultType:p,lineBreaks:!!g.error||!!g.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var T in g)t.call(g,T)&&(b[T]=g[T]);if(typeof b.type=="string"&&p!==b.type)throw new Error("Type transform cannot be a string (type '"+b.type+"' for token '"+p+"')");var A=b.match;return b.match=Array.isArray(A)?A:A?[A]:[],b.match.sort(function(S,F){return s(S)&&s(F)?0:s(F)?-1:s(S)?1:F.length-S.length}),b}function y(p){return Array.isArray(p)?d(p):h(p)}var v=f("error",{lineBreaks:!0,shouldThrow:!0});function x(p,g){for(var b=null,T=Object.create(null),A=!0,S=null,F=[],B=[],w=0;w<p.length;w++)p[w].fallback&&(A=!1);for(var w=0;w<p.length;w++){var k=p[w];if(k.include)throw new Error("Inheritance is not allowed in stateless lexers");if(k.error||k.fallback){if(b)throw!k.fallback==!b.fallback?new Error("Multiple "+(k.fallback?"fallback":"error")+" rules not allowed (for token '"+k.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+k.defaultType+"')");b=k}var M=k.match.slice();if(A)for(;M.length&&typeof M[0]=="string"&&M[0].length===1;){var re=M.shift();T[re.charCodeAt(0)]=k}if(k.pop||k.push||k.next){if(!g)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+k.defaultType+"')");if(k.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+k.defaultType+"')")}if(M.length!==0){A=!1,F.push(k);for(var se=0;se<M.length;se++){var ne=M[se];if(s(ne)){if(S===null)S=ne.unicode;else if(S!==ne.unicode&&k.fallback===!1)throw new Error("If one rule is /u then all must be")}}var ge=i(M.map(a)),V=new RegExp(ge);if(V.test(""))throw new Error("RegExp matches empty string: "+V);var we=l(ge);if(we>0)throw new Error("RegExp has capture groups: "+V+`
Use (?: \u2026 ) instead`);if(!k.lineBreaks&&V.test(`
`))throw new Error("Rule should declare lineBreaks: "+V);B.push(u(ge))}}var fe=b&&b.fallback,Re=r&&!fe?"ym":"gm",Ge=r||fe?"":"|";S===!0&&(Re+="u");var sn=new RegExp(i(B)+Ge,Re);return{regexp:sn,groups:F,fast:T,error:b||v}}function R(p){var g=x(y(p));return new D({start:g},"start")}function C(p,g,b){var T=p&&(p.push||p.next);if(T&&!b[T])throw new Error("Missing state '"+T+"' (in token '"+p.defaultType+"' of state '"+g+"')");if(p&&p.pop&&+p.pop!=1)throw new Error("pop must be 1 (in token '"+p.defaultType+"' of state '"+g+"')")}function I(p,g){var b=p.$all?y(p.$all):[];delete p.$all;var T=Object.getOwnPropertyNames(p);g||(g=T[0]);for(var A=Object.create(null),S=0;S<T.length;S++){var F=T[S];A[F]=y(p[F]).concat(b)}for(var S=0;S<T.length;S++)for(var F=T[S],B=A[F],w=Object.create(null),k=0;k<B.length;k++){var M=B[k];if(M.include){var re=[k,1];if(M.include!==F&&!w[M.include]){w[M.include]=!0;var se=A[M.include];if(!se)throw new Error("Cannot include nonexistent state '"+M.include+"' (in state '"+F+"')");for(var ne=0;ne<se.length;ne++){var ge=se[ne];B.indexOf(ge)===-1&&re.push(ge)}}B.splice.apply(B,re),k--}}for(var V=Object.create(null),S=0;S<T.length;S++){var F=T[S];V[F]=x(A[F],!0)}for(var S=0;S<T.length;S++){for(var we=T[S],fe=V[we],Re=fe.groups,k=0;k<Re.length;k++)C(Re[k],we,V);for(var Ge=Object.getOwnPropertyNames(fe.fast),k=0;k<Ge.length;k++)C(fe.fast[Ge[k]],we,V)}return new D(V,g)}function O(p){for(var g=typeof Map!="undefined",b=g?new Map:Object.create(null),T=Object.getOwnPropertyNames(p),A=0;A<T.length;A++){var S=T[A],F=p[S],B=Array.isArray(F)?F:[F];B.forEach(function(w){if(typeof w!="string")throw new Error("keyword must be string (in keyword '"+S+"')");g?b.set(w,S):b[w]=S})}return function(w){return g?b.get(w):b[w]}}var D=function(p,g){this.startState=g,this.states=p,this.buffer="",this.stack=[],this.reset()};D.prototype.reset=function(p,g){return this.buffer=p||"",this.index=0,this.line=g?g.line:1,this.col=g?g.col:1,this.queuedToken=g?g.queuedToken:null,this.queuedText=g?g.queuedText:"",this.queuedThrow=g?g.queuedThrow:null,this.setState(g?g.state:this.startState),this.stack=g&&g.stack?g.stack.slice():[],this},D.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},D.prototype.setState=function(p){if(!(!p||this.state===p)){this.state=p;var g=this.states[p];this.groups=g.groups,this.error=g.error,this.re=g.regexp,this.fast=g.fast}},D.prototype.popState=function(){this.setState(this.stack.pop())},D.prototype.pushState=function(p){this.stack.push(this.state),this.setState(p)};var W=r?function(p,g){return p.exec(g)}:function(p,g){var b=p.exec(g);return b[0].length===0?null:b};D.prototype._getGroup=function(p){for(var g=this.groups.length,b=0;b<g;b++)if(p[b+1]!==void 0)return this.groups[b];throw new Error("Cannot find token type for matched text")};function Fe(){return this.value}if(D.prototype.next=function(){var p=this.index;if(this.queuedGroup){var g=this._token(this.queuedGroup,this.queuedText,p);return this.queuedGroup=null,this.queuedText="",g}var b=this.buffer;if(p!==b.length){var F=this.fast[b.charCodeAt(p)];if(F)return this._token(F,b.charAt(p),p);var T=this.re;T.lastIndex=p;var A=W(T,b),S=this.error;if(A==null)return this._token(S,b.slice(p,b.length),p);var F=this._getGroup(A),B=A[0];return S.fallback&&A.index!==p?(this.queuedGroup=F,this.queuedText=B,this._token(S,b.slice(p,A.index),p)):this._token(F,B,p)}},D.prototype._token=function(p,g,b){var T=0;if(p.lineBreaks){var A=/\n/g,S=1;if(g===`
`)T=1;else for(;A.exec(g);)T++,S=A.lastIndex}var F={type:typeof p.type=="function"&&p.type(g)||p.defaultType,value:typeof p.value=="function"?p.value(g):g,text:g,toString:Fe,offset:b,lineBreaks:T,line:this.line,col:this.col},B=g.length;if(this.index+=B,this.line+=T,T!==0?this.col=B-S+1:this.col+=B,p.shouldThrow){var w=new Error(this.formatError(F,"invalid syntax"));throw w}return p.pop?this.popState():p.push?this.pushState(p.push):p.next&&this.setState(p.next),F},typeof Symbol!="undefined"&&Symbol.iterator){var te=function(p){this.lexer=p};te.prototype.next=function(){var p=this.lexer.next();return{value:p,done:!p}},te.prototype[Symbol.iterator]=function(){return this},D.prototype[Symbol.iterator]=function(){return new te(this)}}return D.prototype.formatError=function(p,g){if(p==null)var b=this.buffer.slice(this.index),p={text:b,offset:this.index,lineBreaks:b.indexOf(`
`)===-1?0:1,line:this.line,col:this.col};var T=2,A=Math.max(p.line-T,1),S=p.line+T,F=String(S).length,B=m(this.buffer,this.line-p.line+T+1).slice(0,5),w=[];w.push(g+" at line "+p.line+" col "+p.col+":"),w.push("");for(var k=0;k<B.length;k++){var M=B[k],re=A+k;w.push(c(String(re),F)+"  "+M),re===p.line&&w.push(c("",F+p.col+1)+"^")}return w.join(`
`)},D.prototype.clone=function(){return new D(this.states,this.state)},D.prototype.has=function(p){return!0},{compile:R,states:I,error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:O}})});var j=class{constructor(e){this.storage=e}set(e,r){this.storage.set(e,r)}get(e,r){var s;return(s=this.storage.get(e))!=null?s:r}has(e){return this.storage.has(e)}fold(e,r,s){let n=r(this.get(e,s));return this.set(e,n),n}post(e,r,s){let n=this.get(e,s);return this.set(e,r(n)),n}lazy(e,r){var s;return(s=this.get(e,null))!=null?s:this.fold(e,r,null)}over(e,r,s){let n=this.get(e,s);return this.set(e,n),r(n)}delete(e){this.storage.delete(e)}clear(){this.storage.clear()}};var xr=(t,e)=>({ready:e,result:t,parse:!1}),dn=t=>xr(t,!0),hn=(t,e)=>xr(t,e),gn=(t,e)=>hn(t.toReprString(),e.ready),fn={ready:!1,result:[],parse:!1},yn=t=>{var e,r,s;switch(typeof t){case"string":return dn(t);case"object":return{ready:(e=t.ready)!=null?e:!0,result:(r=t.result)!=null?r:[],parse:(s=t.parse)!=null?s:!1};default:return fn}},We=class{constructor(){this.filters=new Map}register(e,r){this.filters.set(e,r)}has(e){return this.filters.has(e)}get(e){var r;return(r=this.filters.get(e))!=null?r:null}getOrDefault(e){var r;return(r=this.get(e))!=null?r:gn}unregisterFilter(e){this.filters.delete(e)}clearFilters(){this.filters.clear()}execute(e,r,s){let n=this.getOrDefault(e);return yn(n(r,s))}};var Et=t=>(t+1>>>1)-1,Ve=t=>(t<<1)+1,Ee=t=>t+1<<1,He=class{constructor(e){this._heap=[],this._comparator=e}greater(e,r){return this._comparator(this._heap[e],this._heap[r])}swap(e,r){[this._heap[e],this._heap[r]]=[this._heap[r],this._heap[e]]}siftUp(){let e=this.size()-1;for(;e>0&&this.greater(e,Et(e));)this.swap(e,Et(e)),e=Et(e)}siftDown(){let e=0;for(;Ve(e)<this.size()&&this.greater(Ve(e),e)||Ee(e)<this.size()&&this.greater(Ee(e),e);){let r=Ee(e)<this.size()&&this.greater(Ee(e),Ve(e))?Ee(e):Ve(e);this.swap(e,r),e=r}}size(){return this._heap.length}isEmpty(){return this.size()===0}peek(){return this._heap[0]}push(...e){return e.forEach(r=>{this._heap.push(r),this.siftUp()}),this.size()}pop(){let e=this.peek(),r=this.size()-1;return r>0&&this.swap(0,r),this._heap.pop(),this.siftDown(),e}*generate(){let e=this.pop();for(;e;)yield e,e=this.pop();return null}};var Ue={priority:0,persistent:!1},bn=(t,e)=>t.priority>e.priority,Ne=class{constructor(){this._deferred=new Map,this._blocked=new Set}register(e,r,s=Ue){var n,o;this._deferred.set(e,{keyword:e,procedure:r,priority:(n=s.priority)!=null?n:Ue.priority,persistent:(o=s.persistent)!=null?o:Ue.persistent})}registerIfNotExists(e,r,s=Ue){this.isRegistered(e)||this.register(e,r,s)}unregister(e){this._deferred.delete(e)}isRegistered(e){return this._deferred.has(e)}block(e){this._blocked.add(e)}unblock(e){this._blocked.delete(e)}isBlocked(e){return this._blocked.has(e)}clear(){this._deferred.clear(),this._blocked.clear()}executeEach(e){let r=new He(bn);r.push(...this._deferred.values());for(let s of r.generate())this.isBlocked(s.keyword)||s.procedure(s,e),s.persistent||this.unregister(s.keyword);this._blocked.clear()}};var qe=class{constructor(e,r){this.filters=e,this.options=r}register(e,r,s={}){this.filters.register(e,r),this.options.set(e,s)}getOptions(e){return this.options.get(e,{})}};var je=class{constructor(e,r,s,n,o,l,u,i){this.preset=e,this.filters=r,this.options=s,this.registrar=new qe(r,s),this.deferred=n,this.aftermath=o,this.cache=l,this.memory=u,this.environment=i}getBaseInternals(e){return Object.assign({},{filters:this.filters,options:this.options,registrar:this.registrar,cache:this.cache,memory:this.memory,environment:this.environment,deferred:this.deferred,aftermath:this.aftermath,preset:this.preset},e)}getAftermathInternals(e,r){return Object.assign(this.getBaseInternals(e),r)}getDeferredInternals(e,r){return Object.assign(this.getBaseInternals(e),r)}getInternals(e,r,s){return Object.assign(this.getDeferredInternals(e,r),s)}filterAccessor(e,r){return{getProcessor:s=>({execute:(n,o)=>this.filters.execute(s,n,this.getInternals(e,r,o)),getOptions:()=>this.options.get(s,{})})}}executeDeferred(e,r){let s=this.getDeferredInternals(e,r);this.deferred.executeEach(s)}executeAftermath(e,r){let s=this.getAftermathInternals(e,r);this.aftermath.executeEach(s)}switchPreset(e){this.preset=e}clear(){this.memory.clear(),this.aftermath.clear()}reset(){this.cache.clear(),this.deferred.clear()}install(...e){for(let r of e)r(this.registrar)}};var xn=t=>({status:t.parse?t.ready?2:3:t.ready?0:1,result:t.result}),vn=t=>{var r,s,n,o;let e=(r=t.optics)!=null?r:[];return{inlineOptics:(s=t.inlineOptics)!=null?s:e,blockOptics:(n=t.blockOptics)!=null?n:e,capture:(o=t.capture)!=null?o:!1}},Nt="_closetEnvironment",vr=class t extends je{static make(e={},r=new Map){let s=Object.prototype.hasOwnProperty.call(globalThis,Nt)?globalThis[Nt]:globalThis[Nt]=new Map;return new t(e,new We,new j(new Map),new Ne,new Ne,new j(new Map),new j(r),new j(s))}makeAccessor(e,r){let s=this.filterAccessor(e,r);return n=>{let o=s.getProcessor(n);return{execute:(l,u)=>xn(o.execute(l,super.getInternals(e,r,u))),getOptions:()=>vn(o.getOptions())}}}finishIteration(e,r){this.executeDeferred(e,r)}finishRun(e,r){this.executeAftermath(e,r),this.reset()}};var Ut={};_(Ut,{BrowserTemplate:()=>pe,Parser:()=>xe,TagSelector:()=>Q,Template:()=>ve,anki:()=>ut,browser:()=>ot,optics:()=>Ye});var $=t=>t,Xe=(t,e)=>e,ye=t=>e=>t;var Sr=t=>{let e=t.slice(0),r=t.length;for(;r!==0;){let s=Math.floor(Math.random()*r);r-=1;let n=e[r];e[r]=e[s],e[s]=n}return e},Ke=(t,e)=>{let r=[];for(let s of e){let n=t[s];n&&r.push(n)}if(e.length<t.length){let s=Array.from(new Array(t.length-e.length),(n,o)=>o+e.length);for(let n of s)r.push(t[n])}return r};var Ye={};_(Ye,{dictForget:()=>Ce,dictFunction:()=>Ie,mapped:()=>G,run:()=>ae,separated:()=>E,stripped:()=>Ar,strippedRegex:()=>Dt,templated:()=>kr,templatedRegex:()=>Ct});var ae=(t,e,r)=>t.reverse().reduce((s,n)=>n(e,s),r);var Sn=(t,e,r)=>s=>e(r(t(s))),kn=t=>([e,r])=>[t(e),r],An=t=>([e,r])=>e?[e,t(r)]:[e,r],Ie={classes:[1,0,2],dimap:Sn,first:kn,right:An},Fn=(t,e)=>r=>e(t(r)),wn=(t,e,r)=>Fn(t,r),Rn=t=>([e])=>t(e),En=t=>([e,r])=>e?t(r):[],Ce={classes:[3,1,0,2],dimap:wn,first:Rn,right:En};var Nn=t=>{var e,r,s,n;return typeof t=="string"?{sep:t,max:1/0,trim:!1,keepEmpty:!0}:{sep:(e=t.sep)!=null?e:"::",max:(r=t.max)!=null?r:1/0,trim:(s=t.trim)!=null?s:!1,keepEmpty:(n=t.keepEmpty)!=null?n:!0}},E=t=>{let{sep:e,max:r,trim:s,keepEmpty:n}=Nn(t),o=u=>{let i=[],a=u,c=!1;for(;!c;){let m=a.indexOf(e),[h,d,f]=m<0||i.length+1===r?[a,"",!0]:[a.slice(0,m),a.slice(m+e.length),!1],y=s?h.trim():h;(n||y.length>=1)&&i.push(y),a=d,c=f}return[i]},l=([u])=>u;return(u,i)=>{let a=u.first(i);return u.dimap(o,l,a)}};var Je=t=>{var e,r;return typeof t=="string"?{before:t,after:t}:{before:(e=t.before)!=null?e:"",after:(r=t.after)!=null?r:""}};var be=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),It=t=>t instanceof RegExp?t.source:t;var In=(t,e)=>r=>{let s=r[r.length-1]||{},n=[t[0]];return e.forEach((o,l)=>{let u=Number.isInteger(o)?r[o]:s[o];n.push(u,t[l+1])}),n.join("")},Ct=t=>{let{before:e,after:r}=Je(t),s=o=>{let l=new RegExp(`(${e})(.*?)(${r})`,"gsu"),u=[],i=[],a=0;o.replace(l,(h,d,f,y,v)=>{let x=o.substring(a,v+d.length);return u.push(x),i.push(f),a=v+h.length-y.length,""}),u.push(o.substring(a));let c=[...Array(i.length).keys()],m=In(u,c);return[i,m]},n=([o,l])=>l(o);return(o,l)=>{let u=o.first(l);return o.dimap(s,n,u)}},kr=({before:t,after:e})=>Ct({before:be(t),after:be(e)});var Dt=t=>{let{before:e,after:r}=Je(t),s=o=>{let l=new RegExp(`^${It(e)}(.*?)${It(r)}$`,"su"),u=o;return o.replace(l,(i,a)=>(u=a,"")),[u,null]},n=([o])=>o;return(o,l)=>{let u=o.first(l);return o.dimap(s,n,u)}},Ar=({before:t,after:e})=>Dt({before:`^${be(t)}`,after:`${be(e)}$`});var Cn=t=>e=>e.map(t),G=()=>(t,e)=>Cn(e);var Bt=(t,e)=>t&&e.isReady(),Fr=t=>t.map(e=>e.toString()).join(""),wr=t=>t.map(e=>e.toReprString()).join(""),Dn=/^(?:<br(?: ?\/)?>|\n)|(?:<br(?: ?\/)?>|\n)$/gu,Bn=t=>t.replace(Dn,""),Qe=class{constructor(e,r,s,n,o,l,u,i,a,c){this._inlineOptics=[];this._inlineGetter=$;this._blockOptics=[];this._blockGetter=$;this.fullKey=e,this.key=r,this.num=s,this.fullOccur=n,this.occur=o,this.delimiters=l,this._inlineNodes=u,this.hasInline=i,this._blockNodes=a,this.hasBlock=c}get inlineNodes(){return this._inlineNodes}get blockNodes(){return this._blockNodes}get innerNodes(){return this.hasBlock?this.blockNodes:this.inlineNodes}set internalNodes(e){this.hasBlock?this._blockNodes=e:this._inlineNodes=e}get inlineText(){return Fr(this.inlineNodes)}get blockText(){return Bn(Fr(this.blockNodes))}get text(){return this.hasBlock?this.blockText:this.inlineText}set inlineOptics(e){this._inlineOptics=e,this._inlineGetter=ae(e,Ce,$)}get inlineOptics(){return this._inlineOptics}set blockOptics(e){this._blockOptics=e,this._blockGetter=ae(e,Ce,$)}get blockOptics(){return this._blockOptics}set optics(e){this.hasBlock?this.blockOptics=e:this.inlineOptics=e}get optics(){return this.hasBlock?this.blockOptics:this.inlineOptics}get inlineGetter(){return this._inlineGetter}get blockGetter(){return this._blockGetter}get getter(){return this.hasBlock?this.blockGetter:this.inlineGetter}get inlineValues(){return this.inlineGetter(this.inlineText)}get blockValues(){return this.blockGetter(this.blockText)}get values(){return this.hasBlock?this.blockValues:this.inlineValues}inlineTraverse(e){return ae(this.inlineOptics,Ie,e)(this.inlineText)}blockTraverse(e){return ae(this.blockOptics,Ie,e)(this.blockText)}traverse(e){return this.hasBlock?this.blockTraverse(e):this.inlineTraverse(e)}wrapWithDelimiters(e,r){return`${this.delimiters.open}${e}${this.fullKey}${r?this.delimiters.sep+r:""}${this.delimiters.close}`}wrapBlock(e,r){return`${this.wrapWithDelimiters("#",r)}${e}${this.wrapWithDelimiters("/")}`}baseToString(e,r){return this.hasInline?this.hasBlock?this.wrapBlock(r(),e()):this.wrapWithDelimiters("",e()):this.hasBlock?this.wrapBlock(r()):this.wrapWithDelimiters("")}toString(){return this.baseToString(()=>this.inlineText,()=>this.blockText)}toReprString(){return this.baseToString(()=>wr(this.inlineNodes),()=>wr(this.blockNodes))}isReady(){return!1}evaluate(e,r,s,n=!1){let o=r(this.key),l=s.length-1,u=o.getOptions().capture,i=(y,v)=>y.evaluate(e,r,[...s,v]),a=!u&&!n,c=u&&!n;a&&this.innerNodes.splice(0,this.innerNodes.length,...this.innerNodes.flatMap(i));let m=this.innerNodes.reduce(Bt,!0);this.inlineOptics=o.getOptions().inlineOptics,this.blockOptics=o.getOptions().blockOptics;let h={path:s,depth:l,ready:m,isCapture:c},d=o.execute(this,h),f;switch(d.status){case 0:f=typeof d.result=="string"?[new le(d.result)]:d.result;break;case 1:f=c?this.innerNodes:[this];break;case 2:f=e.rawParse(d.result).flatMap(i);break;case 3:f=e.rawParse(d.result);break}return c?(this.internalNodes=f,this.evaluate(e,r,s,!0)):f}},De=class{isReady(){return!0}evaluate(){return[this]}toReprString(){var e;return(e=this.toString())!=null?e:""}},le=class extends De{constructor(r){super();this.text=r}toString(){return this.text}},Ze=class extends De{constructor(r){super();this.escaped=r}toString(){return this.escaped.length===1?this.escaped:this.escaped.slice(1)}toReprString(){return this.escaped}},et=class extends De{toString(){return null}};var Be=ze(Pt());var X=/^((?:[a-zA-Z_/]|%\w)+)(\d*)(?::(\d+))?$/u,Er=(t,e)=>{var s;let r=((s=t.get(e))!=null?s:-1)+1;return t.set(e,r),r},$t=class{constructor(){this.tagCounter=null;this.tagCounterFull=null;this.delimiters=null}increment(e,r){return[Er(this.tagCounterFull,e),Er(this.tagCounter,r)]}build(e,r,s,n=[],o=!1){let l=e.match(X);if(!l)throw new Error("Could not match key. This should never happen.");let u=l[1],i=l[2].length>0?Number(l[2]):null,[a,c]=this.increment(e,u);return new Qe(e,u,i,a,c,this.delimiters,r,s,n,o)}push(e,r){this.tagCounterFull=e[0],this.tagCounter=e[1],this.delimiters=r}},Te=new $t;function ue(t){return t[0]}var Pn=t=>({Lexer:t,ParserRules:[{name:"start",symbols:["content"],postprocess:ue},{name:"content$ebnf$1",symbols:[]},{name:"content$ebnf$1",symbols:["content$ebnf$1","node"],postprocess:r=>r[0].concat([r[1]])},{name:"content",symbols:["content$ebnf$1"],postprocess:ue},{name:"node",symbols:["text"],postprocess:ue},{name:"node",symbols:["inlinetag"],postprocess:ue},{name:"node",symbols:["blocktag"],postprocess:ue},{name:"text",symbols:[t.has("text")?{type:"text"}:text],postprocess:([r])=>new le(r.value)},{name:"text",symbols:[t.has("escapeseq")?{type:"escapeseq"}:escapeseq],postprocess:([r])=>new Ze(r.value)},{name:"inlinetag",symbols:[t.has("inlineopen")?{type:"inlineopen"}:inlineopen,"inline"],postprocess:([,[r,s,n]])=>Te.build(r.value,s,n)},{name:"blocktag",symbols:[t.has("blockopen")?{type:"blockopen"}:blockopen,"inline","content","blockclose"],postprocess:([,[r,s,n],o,l],u,i)=>!l||r.value===l.value?Te.build(r.value,s,n,o,!0):i},{name:"inline$ebnf$1$subexpression$1",symbols:[t.has("sep")?{type:"sep"}:sep,"content"]},{name:"inline$ebnf$1",symbols:["inline$ebnf$1$subexpression$1"],postprocess:ue},{name:"inline$ebnf$1",symbols:[],postprocess:()=>null},{name:"inline",symbols:[t.has("keyname")?{type:"keyname"}:keyname,"inline$ebnf$1",t.has("close")?{type:"close"}:close],postprocess:([r,s])=>s?[r,s[1],!0]:[r,[],!1]},{name:"blockclose$ebnf$1",symbols:[t.has("keyname")?{type:"keyname"}:keyname],postprocess:ue},{name:"blockclose$ebnf$1",symbols:[],postprocess:()=>null},{name:"blockclose",symbols:[t.has("blockclose")?{type:"blockclose"}:blockclose,"blockclose$ebnf$1",t.has("close")?{type:"close"}:close],postprocess:([,r])=>r}],ParserStart:"start"}),Ot=Pn;var Mt={open:"[[",sep:"::",close:"]]"};function*Nr(t,e){let r=!0;for(let s of t){r?r=!1:yield e;for(let n of s)yield n}}var Dr=ze(Lt()),Gt=/(?:[a-zA-Z_]|%\w)+\d*/u,Cr=t=>t.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"),_t=t=>{let e=Cr(t.open),r=Cr(t.close),s=new RegExp(`[\\s\\S]+?(?=\\\\|${e}|$)`,"u"),n=new RegExp(`[\\s\\S]+?(?=\\\\|${e}|${r})`,"u"),o=new RegExp(`\\\\(?:${e}|${r})?`,"u"),l={match:t.open,push:"inlinekey"},u={match:`${t.open}#`,push:"blockkey"},i={match:`${t.open}/`,push:"blockclose"},a={match:t.close,pop:1},c={match:t.close,next:"blockmain"},m={match:Gt},h={match:s,lineBreaks:!0},d={match:n,lineBreaks:!0},f={match:o},y=v=>({match:t.sep,next:v});return(0,Dr.states)({main:{blockopen:u,inlineopen:l,escapeseq:f,text:h},blockkey:{keyname:m,sep:y("blocktag"),close:c},inlinekey:{keyname:m,sep:y("inlinetag"),close:a},blocktag:{blockopen:u,inlineopen:l,escapeseq:f,close:c,text:d},inlinetag:{blockopen:u,inlineopen:l,escapeseq:f,close:a,text:d},blockmain:{blockopen:u,blockclose:i,inlineopen:l,escapeseq:f,text:h},blockclose:{keyname:m,close:a}})};var $n=(t,e)=>{let r=new Be.Parser(e);try{return r.feed(t).results}catch(s){return[[new le(t)]]}},Br=(t,e)=>{let r=$n(t,e);return r.length>1,r[0]},On=(t,e)=>[...Nr(t.map(r=>Br(r,e)),new et)];var xe=class{constructor(e){this.tagBuilderSettings=[new Map,new Map];this.delimiters=e!=null?e:Mt,this.lexer=_t(this.delimiters),this.grammar=Be.Grammar.fromCompiled(Ot(this.lexer))}update(e){this.delimiters=Object.assign({},Mt,e),this.lexer=_t(this.delimiters),this.grammar=Be.Grammar.fromCompiled(Ot(this.lexer))}parse(e){return Te.push(this.tagBuilderSettings,this.delimiters),On(e,this.grammar)}rawParse(e){return Te.push(this.tagBuilderSettings,this.delimiters),Br(e,this.grammar)}};var Mn=50,Ln=t=>{let e=[];if(t.length===0)return e;let r="";for(let s of t){let n=s.toString();typeof n=="string"?r+=n:(e.push(r),r="")}return e.push(r),e},ve=class t{constructor(e,r,s){this.textFragments=e,this.parser=new xe(s),this.nodes=r!=null?r:this.parser.parse(e)}static make(e,r){return new t([e],null,r)}static makeFromFragments(e,r){return new t(e,null,r)}render(e,r=()=>{}){let s={template:this,parser:this.parser},n=this.nodes,o=!1;for(let u=0;u<Mn&&!o;u++){let i={iteration:u},a=e.makeAccessor(s,i);n=n.flatMap((c,m)=>c.evaluate(this.parser,a,[m])),o=n.reduce(Bt,!0),e.finishIteration(s,i)}let l=Ln(n);return r(l),e.finishRun(s,{result:l}),l}};var ot={};_(ot,{BrowserTemplate:()=>pe,cleanup:()=>Wt,interspliceChildNodes:()=>nt});var Pr=(t,e,r)=>t<0?r+t+1:e+t,zt=(t,e)=>{var o;if(typeof t=="string")return t;let r=null,s=null,n=null;switch(t.nodeType){case Node.TEXT_NODE:return r=t,(o=r.textContent)!=null?o:"";case Node.ELEMENT_NODE:return s=t,e?s.outerHTML:s.innerHTML;case ce.CHILD_NODE_SPAN:return n=t,n.spanAsStrings().join("");default:return""}},$r=(t,e)=>{if(typeof t=="string")return;let r=null,s=null,n=null,o=null;switch(t.nodeType){case Node.TEXT_NODE:r=t,s=document.createElement("div"),r.parentElement&&(r.parentElement.insertBefore(s,r),r.parentElement.removeChild(r)),s.outerHTML=e;break;case Node.ELEMENT_NODE:n=t,n.innerHTML=e;break;case ce.CHILD_NODE_SPAN:o=t,o.replaceSpan(e);break}},Gn={type:"index",value:0},_n={type:"index",value:-1},st=class st{constructor(e,r=Gn,s=_n){this.nodeType=st.CHILD_NODE_SPAN;var l,u,i,a;this.parentElement=e,this.childNodes=Array.from(this.parentElement.childNodes),this.max=e.childNodes.length-1;let n=this.getFromMethod(r.type),o=this.getToMethod(s.type);this._fromIndex=n.call(this,r.value,(l=r.startAtIndex)!=null?l:0,(u=r.exclusive)!=null?u:!1),this._toIndex=o.call(this,s.value,Math.max((i=s.startAtIndex)!=null?i:0,this.from),(a=s.exclusive)!=null?a:!1)}get from(){return this._fromIndex}get to(){return this._toIndex}getFromMethod(e){return e==="index"?this.fromIndex:e==="node"?this.fromNode:this.fromPredicate}getToMethod(e){return e==="index"?this.toIndex:e==="node"?this.toNode:this.toPredicate}fromSafe(e,r){return e<r||e>this.max?this.max:e}fromIndex(e,r,s){let n=Pr(e,r,this.max)+(s?1:0);return this.fromSafe(n,r)}fromNode(e,r,s){let n=this.childNodes.slice(r).findIndex(o=>o===e)+r+(s?1:0);return this.fromSafe(n,r)}fromPredicate(e,r,s){let n=this.childNodes.slice(r).findIndex(e)+r+(s?1:0);return this.fromSafe(n,r)}toSafe(e,r){return e<r||e>this.max?0:e}toIndex(e,r,s){let n=Pr(e,r,this.max)-(s?1:0);return this.toSafe(n,r)}toNode(e,r,s){let n=this.childNodes.slice(r).findIndex(o=>o===e)+r-(s?1:0);return this.toSafe(n,r)}toPredicate(e,r,s){let n=this.childNodes.slice(r).findIndex(e)+r-(s?1:0);return this.toSafe(n,r)}get valid(){return this._fromIndex<=this._toIndex}get length(){return Math.max(0,this._toIndex-this._fromIndex+1)}getRootNode(){return this.parentElement.getRootNode()}span(){return this.valid?this.childNodes.slice(this._fromIndex,this._toIndex+1):[]}spanAsStrings(){return this.span().map(e=>zt(e,!0))}replaceSpan(e){if(!this.valid)return;let r=document.createElement("div"),s=this.parentElement.childNodes.length;this.parentElement.insertBefore(r,this.parentElement.childNodes[this._fromIndex]);for(let n of this.span())n.parentElement===this.parentElement&&this.parentElement.removeChild(n);r.outerHTML=e,this.childNodes=Array.from(this.parentElement.childNodes),this.max=this.childNodes.length,this._toIndex=this._toIndex+(this.max-s)}};st.CHILD_NODE_SPAN=3353;var ce=st;var Or=(t,e=0)=>[{type:"predicate",value:t.value,startAtIndex:e,exclusive:!1},{type:"predicate",value:n=>!t.value(n),startAtIndex:e,exclusive:!0}],nt=(t,e)=>{let r=[],s=new ce(t,...Or(e));for(;s.valid;)r.push(s),s=new ce(t,...Or(e,s.to+1));return r};var Mr=(t,e)=>{let r=document.createElement("style");return r.type="text/css",r.id=`closet-${t}`,r.textContent=e,r},Lr=(t,e)=>!!t.getElementById(`closet-${e}`),Gr=(t,e)=>{Lr(document,t)||document.head.appendChild(Mr(t,e))},zn=(t,e,r)=>{let s=t.getRootNode();s instanceof Document?Gr(e,r):Lr(s,e)||s.insertBefore(Mr(e,r),s.firstElementChild)},pe=class t extends ve{constructor(r,s,n,o){super(r,s,o);this.inputs=n}static makeFromNode(r,s){return t.makeFromNodes([r],s)}static makeFromNodes(r,s){return new t(r.map(n=>zt(n,!1)),null,r,s)}renderToNodes(r){super.render(r,s=>s.forEach((n,o)=>$r(this.inputs[o],n)))}appendDocumentStyle(r,s){Gr(r,s)}appendStyle(r,s,n){zn(r,s,n)}appendStyleAll(r,s){for(let n of this.inputs)typeof n!="string"&&this.appendStyle(n,r,s)}},Wn="closet-delay",Wt=()=>{for(let t of Array.from(document.getElementsByClassName(Wn)))t.style.visibility="visible"};var it=ze(Pt());var _r=ze(Lt()),N=(0,_r.compile)({text:{match:/[a-zA-Z_]+/u},numDigits:{match:/\d+(?=:|$)/u},digits:{match:/\d+/u},slash:{match:"/"},escapeseq:{match:/%\w/u},multiplierSeq:{match:/\*n\+/u},allStar:{match:/^\*$/u},numStar:{match:/\*(?=:|$)/u},star:{match:"*"},groupOpen:{match:"{"},groupAlternative:{match:","},rangeSpecifier:{match:/-/u},numGroupClose:{match:/\}(?=:|$)/u},groupClose:{match:"}"},occurSep:{match:":"}});function P(t){return t[0]}var Vn={Lexer:N,ParserRules:[{name:"start",symbols:["allStar"],postprocess:P},{name:"start",symbols:["pattern"],postprocess:P},{name:"allStar",symbols:[N.has("allStar")?{type:"allStar"}:allStar],postprocess:()=>()=>!0},{name:"pattern",symbols:["key","num","occur"],postprocess:([t,e,r])=>(s,n,o)=>{if(typeof n=="undefined"){let l=s.match(X);if(!l)return!1;let u=l[1],i=Number(l[2]),a=Number.isNaN(i)?null:i;return t.test(u)&&e(a)&&r(o)}else return t.test(s)&&e(n)&&r(o)}},{name:"key$ebnf$1$subexpression$1",symbols:["keyComps"]},{name:"key$ebnf$1",symbols:["key$ebnf$1$subexpression$1"]},{name:"key$ebnf$1$subexpression$2",symbols:["keyComps"]},{name:"key$ebnf$1",symbols:["key$ebnf$1","key$ebnf$1$subexpression$2"],postprocess:t=>t[0].concat([t[1]])},{name:"key",symbols:["key$ebnf$1"],postprocess:([t])=>new RegExp(`^${t.join("")}$`,"u")},{name:"keyComps",symbols:["mixedText"],postprocess:P},{name:"keyComps",symbols:["escapeseq"],postprocess:P},{name:"keyComps",symbols:["keyGroup"],postprocess:P},{name:"mixedText",symbols:[N.has("text")?{type:"text"}:text],postprocess:([t])=>t.value},{name:"mixedText",symbols:[N.has("star")?{type:"star"}:star],postprocess:()=>".*"},{name:"mixedText",symbols:[N.has("slash")?{type:"slash"}:slash],postprocess:()=>"\\\\"},{name:"escapeseq",symbols:[N.has("escapeseq")?{type:"escapeseq"}:escapeseq],postprocess:([t])=>t.value},{name:"keyGroup",symbols:[N.has("groupOpen")?{type:"groupOpen"}:groupOpen,"keyGroupInner",N.has("groupClose")?{type:"groupClose"}:groupClose],postprocess:([,t])=>t.join("")},{name:"keyGroupInner$ebnf$1",symbols:[]},{name:"keyGroupInner$ebnf$1$subexpression$1",symbols:[N.has("groupAlternative")?{type:"groupAlternative"}:groupAlternative,"keyGroupItem"]},{name:"keyGroupInner$ebnf$1",symbols:["keyGroupInner$ebnf$1","keyGroupInner$ebnf$1$subexpression$1"],postprocess:t=>t[0].concat([t[1]])},{name:"keyGroupInner",symbols:["keyGroupItem","keyGroupInner$ebnf$1"],postprocess:([t,e])=>[t,...e.map(r=>r.value)]},{name:"keyGroupItem$ebnf$1",symbols:[]},{name:"keyGroupItem$ebnf$1$subexpression$1",symbols:["mixedText"]},{name:"keyGroupItem$ebnf$1",symbols:["keyGroupItem$ebnf$1","keyGroupItem$ebnf$1$subexpression$1"],postprocess:t=>t[0].concat([t[1]])},{name:"keyGroupItem",symbols:["keyGroupItem$ebnf$1"],postprocess:([t])=>t.join("")},{name:"num$ebnf$1$subexpression$1",symbols:["numPredicate"]},{name:"num$ebnf$1",symbols:["num$ebnf$1$subexpression$1"],postprocess:P},{name:"num$ebnf$1",symbols:[],postprocess:()=>null},{name:"num",symbols:["num$ebnf$1"],postprocess:([t])=>t?t[0]:e=>e===null},{name:"numPredicate",symbols:["numDigits"],postprocess:P},{name:"numPredicate",symbols:["numStar"],postprocess:P},{name:"numPredicate",symbols:["numGroup"],postprocess:P},{name:"numDigits",symbols:[N.has("numDigits")?{type:"numDigits"}:numDigits],postprocess:([t])=>e=>e===Number(t.value)},{name:"numStar",symbols:[N.has("numStar")?{type:"numStar"}:numStar],postprocess:()=>t=>!0},{name:"numGroup",symbols:[N.has("groupOpen")?{type:"groupOpen"}:groupOpen,"numGroupInner",N.has("numGroupClose")?{type:"numGroupClose"}:numGroupClose],postprocess:([,t])=>e=>t.reduce((r,s)=>r||s(e),!1)},{name:"numGroupInner$ebnf$1",symbols:[]},{name:"numGroupInner$ebnf$1$subexpression$1",symbols:[N.has("groupAlternative")?{type:"groupAlternative"}:groupAlternative,"numGroupItem"]},{name:"numGroupInner$ebnf$1",symbols:["numGroupInner$ebnf$1","numGroupInner$ebnf$1$subexpression$1"],postprocess:t=>t[0].concat([t[1]])},{name:"numGroupInner",symbols:["numGroupItem","numGroupInner$ebnf$1"],postprocess:([t,e])=>[t,...e.map(([,r])=>r)]},{name:"numGroupItem$ebnf$1$subexpression$1",symbols:["numGroupPredicate"]},{name:"numGroupItem$ebnf$1",symbols:["numGroupItem$ebnf$1$subexpression$1"],postprocess:P},{name:"numGroupItem$ebnf$1",symbols:[],postprocess:()=>null},{name:"numGroupItem",symbols:["numGroupItem$ebnf$1"],postprocess:([t])=>t?t[0]:e=>e===null},{name:"numGroupPredicate",symbols:["digits"],postprocess:P},{name:"numGroupPredicate",symbols:["range"],postprocess:P},{name:"numGroupPredicate",symbols:["multiple"],postprocess:P},{name:"digits",symbols:[N.has("digits")?{type:"digits"}:digits],postprocess:([t])=>e=>e===Number(t.value)},{name:"range",symbols:["bounded"],postprocess:P},{name:"range",symbols:["leftBounded"],postprocess:P},{name:"range",symbols:["rightBounded"],postprocess:P},{name:"bounded",symbols:[N.has("digits")?{type:"digits"}:digits,N.has("rangeSpecifier")?{type:"rangeSpecifier"}:rangeSpecifier,N.has("digits")?{type:"digits"}:digits],postprocess:([t,,e])=>r=>typeof r=="number"&&Number(t.value)<=r&&r<=Number(e.value)},{name:"leftBounded",symbols:[N.has("digits")?{type:"digits"}:digits,N.has("rangeSpecifier")?{type:"rangeSpecifier"}:rangeSpecifier],postprocess:([t])=>e=>typeof e=="number"&&Number(t.value)<=e},{name:"rightBounded",symbols:[N.has("rangeSpecifier")?{type:"rangeSpecifier"}:rangeSpecifier,N.has("digits")?{type:"digits"}:digits],postprocess:([,t])=>e=>typeof e=="number"&&e<=Number(t.value)},{name:"multiple",symbols:[N.has("digits")?{type:"digits"}:digits,N.has("multiplierSeq")?{type:"multiplierSeq"}:multiplierSeq,N.has("digits")?{type:"digits"}:digits],postprocess:([t,,e])=>r=>(r-e)%t===0},{name:"occur$ebnf$1$subexpression$1",symbols:[N.has("occurSep")?{type:"occurSep"}:occurSep,"occurPredicate"]},{name:"occur$ebnf$1",symbols:["occur$ebnf$1$subexpression$1"],postprocess:P},{name:"occur$ebnf$1",symbols:[],postprocess:()=>null},{name:"occur",symbols:["occur$ebnf$1"],postprocess:([t])=>t?e=>e===null?!0:t[1](e):()=>!0},{name:"occurPredicate",symbols:["numDigits"],postprocess:P},{name:"occurPredicate",symbols:["numStar"],postprocess:P},{name:"occurPredicate",symbols:["occurGroup"],postprocess:P},{name:"occurGroup",symbols:[N.has("groupOpen")?{type:"groupOpen"}:groupOpen,"occurGroupInner",N.has("groupClose")?{type:"groupClose"}:groupClose],postprocess:([,t])=>e=>t.reduce((r,s)=>s||r(e),!1)},{name:"occurGroupInner$ebnf$1",symbols:[]},{name:"occurGroupInner$ebnf$1$subexpression$1",symbols:[N.has("groupAlternative")?{type:"groupAlternative"}:groupAlternative,"numGroupPredicate"]},{name:"occurGroupInner$ebnf$1",symbols:["occurGroupInner$ebnf$1","occurGroupInner$ebnf$1$subexpression$1"],postprocess:t=>t[0].concat([t[1]])},{name:"occurGroupInner",symbols:["numGroupPredicate","occurGroupInner$ebnf$1"],postprocess:([t,e])=>[t,...e.map(([,r])=>r)]}],ParserStart:"start"},zr=Vn;var Hn=it.Grammar.fromCompiled(zr),Un=t=>{let e=new it.Parser(Hn);try{let r=e.feed(t).results;return r.length>1,r[0]}catch(r){return()=>!1}},Q=class t{constructor(e){this.predicate=Un(e)}static make(e){return new t(e)}check(e,r,s=null){return this.predicate(e,r,s)}checkFullKey(e,r=null){return this.predicate(e,void 0,r)}checkTagIdentifier(e){let r=e.match(X);if(!r)return!1;let s=r[1],n=r[2].length>0?Number(r[2]):null,o=r[3]?Number(r[3]):null;return this.predicate(s,n,o)}};var ut={};_(ut,{ankiLog:()=>H,getQaChildNodes:()=>Ur,init:()=>Ht,initialize:()=>Hr});var H=(...t)=>{if(!globalThis.closetDebug)return!1;let e=Object.assign(document.createElement("div"),{className:"closet-log",innerText:t.map(String).join(`
`)}),r=document.getElementById("qa");return r?(r.appendChild(e),!0):!1};var U="github.com/hgiesel/closet",Vt=class{constructor(){this._isAvailable=!1;try{typeof globalThis.sessionStorage=="object"&&(this._isAvailable=!0)}catch(e){}}clear(){for(let e=0;e<sessionStorage.length;e++){let r=sessionStorage.key(e);r&&r.indexOf(U)===0&&(sessionStorage.removeItem(r),e--)}}setItem(e,r){sessionStorage.setItem(U+e,JSON.stringify(r))}getItem(e){var s;let r=(s=sessionStorage.getItem(U+e))!=null?s:"null";return JSON.parse(r)}removeItem(e){sessionStorage.removeItem(U+e)}isAvailable(){return this._isAvailable}},lt=class{constructor(e){this._isAvailable=!1;this.obj=globalThis[e],typeof this.obj=="object"&&(this._isAvailable=!0,this.obj[U]===void 0&&this.clear())}clear(){this.obj[U]={}}setItem(e,r){this.obj[U][e]=r}getItem(e){return this.obj[U][e]==null?null:this.obj[U][e]}removeItem(e){delete this.obj[U][e]}isAvailable(){return this._isAvailable}},qn=()=>{let t;if(t=new Vt,t.isAvailable())return H("Used Persistence sessionStorage implementation"),t;if(t=new lt("py"),t.isAvailable())return H("Used Persistence windowKey py implementation"),t;let e=location.toString().indexOf("title"),r=location.toString().indexOf("main",e);return e>0&&r>0&&r-e<10?(H("Used Persistence windowKey qt implementation"),new lt("qt")):(H("Defaulted to Persistence windowKey implementation"),t)},jn=t=>{let e=0,r,s;for(r=0;r<t.length;r++)s=t.charCodeAt(r),e=(e<<5)-e+s,e|=0;return e},at=qn(),Wr=(t,e)=>r=>{var i;let s=(i=globalThis.closetCardHash)!=null?i:null,o=(()=>{if(!at.isAvailable())return new Map;if(t==="front"){let c=jn(e);if(c!==s)return globalThis.closetCardHash=c,new Map}let a=at.getItem(r);return new Map(a)})();return{key:r,map:o,writeBack:()=>{if(at.isAvailable()){let a=Array.from(o.entries());at.setItem(r,a)}}}};var Xn=t=>{switch(t){case 1:return"You have set the variable globalThis.closetImmediately.";case 2:return"Closet executes while MathJax is still rendering. You are on AnkiDesktop. The action will be pushed onto onShownHook.";case 3:return"Closet executes while MathJax is still rendering. You are on AnkiMobile. The action will be enqueued on MathJax.Hub.Queue.";case 4:return"Closet executes after MathJax finished rendering. The action will be executed immediatley.";case 5:return"You are on AnkiWeb, which does not have MathJax. Alternatively, you are on platform with MathJax 3. The action will be executed immediatley.";default:return"No Description found. This should never happen."}},Pe={raw:t=>t(),viaShownHook:t=>globalThis.onShownHook.push(t),viaMathJaxQueue:t=>globalThis.MathJax.Hub.Queue(t)},Kn=()=>globalThis.MathJax.Hub.queue,Jn=()=>{let t=Kn(),e=Object.assign({},t);return e.queue=e.queue.map(String),e},Yn=()=>{if(globalThis.closetImmediately)return[Pe.raw,1,[]];try{let t=globalThis._updatingQA,e=Jn();if(t){let r=globalThis.onShownHook;return r?[Pe.viaShownHook,2,[JSON.stringify(r.map(String)),JSON.stringify(e)]]:[Pe.viaMathJaxQueue,3,[JSON.stringify(e)]]}else return[Pe.raw,4,[JSON.stringify(e)]]}catch(t){return[Pe.raw,5,[t]]}},Vr=t=>{let[e,r,s]=Yn();H(`Init mode ${r}`,Xn(r),...s),e(t)};var Qn=t=>Number(t.match(/[0-9]*$/)),Zn=(t,e,r)=>({card:t,cardNumber:Qn(t),tagsFull:e,tags:e.length===0?[]:e.split(" "),side:r}),eo=(t,e,r,s)=>{let n=window.performance.now();return pe.makeFromNodes(t,s==null?void 0:s.delimiters).renderToNodes(r),e.writeBack(),window.performance.now()-n},Ht=(t,e,r,s,n)=>{var u,i;let o=Zn(r,s,n),l=Wr(n,(i=(u=document.getElementById("qa"))==null?void 0:u.innerHTML)!=null?i:"");return e(t,o,l).map(a=>eo(...a))},to=(t,e,r,s,n)=>{try{`${Ht(t,e,r,s,n).map(l=>l.toFixed(3))}`}catch(o){H("An error occured while executing Closet",o)}finally{Wt()}},Hr=(t,e,r,s,n)=>(Vr(()=>to(t,e,r,s,n)),t);var ro=t=>t.nodeType===Node.ELEMENT_NODE,so=t=>t.tagName==="STYLE",no=t=>t.tagName==="SCRIPT",oo=t=>no(t)&&(t.type.length===0||t.type.endsWith("javascript")),io=t=>t.id==="anki-am",ao=t=>ro(t)&&(so(t)||oo(t)||io(t)),Ur=()=>{if(!globalThis.document)return null;let t=globalThis.document.getElementById("qa");return t?nt(t,{type:"predicate",value:e=>!ao(e)}):null};var er={};_(er,{activate:()=>Xr,apply:()=>os,constantGet:()=>me,deactivate:()=>Kr,debug:()=>ds,define:()=>hs,delimiter:()=>gs,generateInteger:()=>ps,generateReal:()=>ms,order:()=>us,pick:()=>rs,pickCardNumber:()=>ns,pickIndex:()=>ss,process:()=>is,setList:()=>Yr,setNumber:()=>qr,shuffle:()=>ls,style:()=>as});var $e=E({sep:";"}),Oe=E({sep:"=",trim:!0,max:2}),Se=class{constructor(e){this.defaultValue=e,this.selectors=[]}set(e,r){this.selectors.unshift([Q.make(e),r])}get(e,r,s){let n=this.selectors.find(([o])=>o.check(e,r,s));return n?n[1]:this.defaultValue}},ct=t=>(e,r,s)=>(n,{cache:o})=>(n.values.forEach(u=>{o.over(e,s(...u),new t(r))}),{ready:!0});var qt=class extends Se{setNumber(e,r){this.set(e,Number.isNaN(r)?0:r)}},lo=ct(qt),qr=({tagname:t="set",storeId:e="numerical",separator:r=$e,assignmentSeparator:s=Oe}={})=>n=>n.register(t,lo(e,0,(o,l)=>u=>u.setNumber(o,Number(l))),{optics:[r,G(),s]});var jt=class extends Se{on(e){this.set(e,!0)}off(e){this.set(e,!1)}},jr=ct(jt),Xr=({tagname:t="on",storeId:e="active",optic:r=$e}={})=>s=>s.register(t,jr(e,!1,n=>o=>{o.on(n)}),{separators:[r,G(),Oe]}),Kr=({tagname:t="off",storeId:e="active",optic:r=$e}={})=>s=>s.register(t,jr(e,!1,n=>o=>o.off(n)),{separators:[r,G(),Oe]});var me=t=>({get:()=>t});var pt=class extends j{},Jr=t=>(e,r)=>(s,n)=>{var l;return{ready:!0,result:(l=n.cache.over(e,r(s,n),new t(new Map)))!=null?l:""}};var Xt=class extends pt{setList(e,r){this.set(e,r)}overwriteList(e,r,s=0){let n=this.getList(e);for(let o=0;o<r.length;o++)n[s+o]=r[o];this.setList(e,n)}getList(e){return this.get(e,[])}},mt=Jr(Xt);var uo=(t,e)=>(r,s)=>"",co=(t,e)=>(r,s)=>n=>{let[o,l]=r.values.length===2?r.values:[["default"],r.values[0]],u=o[0],i=n.getList(u),a=t(n,u,l)(r,s);return e(a,i)(r,s)},po=t=>({tagname:e="setl",storeId:r="lists",postprocess:s=uo,optics:n=[E({sep:"::"}),G(),E({sep:"||"})]}={})=>o=>o.register(e,mt(r,co(t,s)),{optics:n}),mo=(t,e,r)=>(s,n)=>(s.num===null?t.setList(e,r):t.overwriteList(e,r,s.num),""),Yr=po(mo);var dt=function*(t,e,r=[],s=()=>!1){let n=[],o=0;for(;!s(r)&&o<1e3;){let l=t();!r.includes(l)&&!n.includes(l)&&(e&&n.push(l),yield l),o++}return n},ht=(t,e)=>()=>t+Math.floor(Math.random()*(e-t)),Qr=(t,e)=>String(t*e),Zr=(t,e)=>r=>r.length>=e-t,es=(t,e)=>()=>t+Math.random()*(e-t),ts=(t,e)=>t.toFixed(e);var ho=(t,e)=>(r,s)=>t,go=(t,e)=>(r,s)=>n=>{let o=r.values||"default",l=n.getList(o),u=t(l,o)(r,s);return e(u,l)(r,s)},Kt=t=>({tagname:e="pick",storeId:r="lists",postprocess:s=ho}={})=>n=>n.register(e,mt(r,go(t,s))),fo=(t,e)=>(r,{memory:s})=>{let n=`pick:picked:${r.fullKey}:${r.occur}`,o=s.lazy(n,()=>{let l=ht(0,t.length),u=Zr(0,t.length),i=!!r.num,a=`pick:uniqList:${r.fullKey}`,c=i?s.over(a,y=>(Object.prototype.hasOwnProperty.call(y,e)||(y[e]=[]),y),{})[e]:[],m=Array.from(t).reduce((y,v,x)=>(v===void 0&&y.push(x),y),[]),h=c.concat(m),f=dt(l,i,h,u).next();if(!f.done)return c.push(f.value),f.value});return Number.isInteger(o)?t[o]:""},yo=(t,e)=>(r,s)=>t[Number(r.num)||0],bo=(t,e)=>(r,s)=>{var l;let n=t[s.preset.cardNumber];return(l=n!=null?n:t[0])!=null?l:""},rs=Kt(fo),ss=Kt(yo),ns=Kt(bo);var L=class t{constructor(e,r,s){this.separator=e,this.mapper=r,this.processor=s}static make({separator:e="",mapper:r=$,processor:s=$}={}){return new t(e,r,s)}toStylizer({separator:e=this.separator,mapper:r=this.mapper,processor:s=this.processor}={}){return new t(e,r,s)}stylize(e,...r){return this.processor(e.flatMap((s,n,o)=>this.mapper(s,n,...r.map(l=>l[n]),o)).join(this.separator))}stylizeFull(e,r=[],s=[]){return this.processor(e.flatMap((n,o,l)=>this.mapper(n,o,...r.map(u=>u[o]),l)).join(this.separator),...s)}};var Me=t=>({tagname:e="s"}={})=>r=>{r.register(e,t)},Jt=t=>e=>t(e.values),os=({tagname:t="s",apply:e=Jt($),optics:r=[]}={})=>s=>{s.register(t,e,{optics:r})},is=({tagname:t="s",processor:e=$,optics:r=[]}={})=>s=>{s.register(t,Jt(e),{optics:r})},as=({tagname:t="s",stylizer:e=L.make(),optics:r=[E("::")]}={})=>s=>{s.register(t,Jt(e.stylize.bind(e)),{optics:r})};var Qt={};_(Qt,{acrossCustom:()=>Eo,acrossNumberedCustom:()=>No,acrossNumberedTag:()=>Yt,acrossTag:()=>Le,withinCustom:()=>Ro,withinTag:()=>wo});var To=(t,e,r,s)=>(n,o)=>{let l=`${t}:apply`,u=`${t}:length`,i=`${e}:waitingSet`,a=`${e}:shuffle`;if(o.cache.get(l,!1)){if(o.cache.get(i,new Set).size>0)return;let h=[],d=o.cache.get(a,[]),f=o.cache.get(u,0);for(let y=0;y<f;y++){let v=d.shift();v&&h.push(v)}return h}if(!o.ready){o.cache.over(i,m=>m.add(t),new Set);return}let c=s(n,o);if(c.length===0)return c;o.cache.fold(a,m=>m.concat(c),[]),o.cache.set(u,c.length),o.deferred.registerIfNotExists(l,()=>{o.cache.set(l,!0),o.cache.over(i,m=>m.delete(t),new Set)},{priority:65}),o.deferred.registerIfNotExists(a,()=>{o.cache.over(i,m=>m.size>0,new Set)||o.cache.fold(a,m=>{let h=o.memory.fold(a,d=>r(d,o.cache.get(a,[]).length),[]);return Ke(m,h)},[])})},ke=t=>(e,r)=>(s,n)=>{let o="sequences",[l,u]=t(s,n);return n.cache.over(o,i=>{i.includes(u)||i.push(u)},[]),To(l,u,r,e)(s,n)},xo=({fullKey:t,fullOccur:e},r)=>[`${t}:${e}`,`${t}:${e}`],vo=({fullKey:t,fullOccur:e},r)=>[`${t}:${e}`,t],So=({fullKey:t,fullOccur:e,num:r},s)=>[`${t}:${e}`,r?t:`${t}:${e}`],ko=t=>({fullKey:e,fullOccur:r,num:s},n)=>[`${e}:${r}`,`${t}${s}:${r}`],Ao=t=>({fullKey:e,fullOccur:r,num:s},n)=>[`${e}:${r}`,`${t}${s}`],Fo=t=>({fullKey:e,fullOccur:r,num:s},n)=>{let o=`${t}${s}`;return[`${e}:${r}`,s?o:`${o}:${r}`]},wo=ke(xo),Le=ke(vo),Yt=ke(So),Ro=t=>ke(ko(t)),Eo=t=>ke(Ao(t)),No=t=>ke(Fo(t));var Zt={};_(Zt,{mixIn:()=>Io,topUp:()=>K});var K=(t,e)=>{if(t.length>=e)return t;let r=Sr(Array.from(new Array(e-t.length),(n,o)=>o+t.length));return[...t,...r]},Io=(t,e)=>{if(t.length>=e)return t;let r=Array.from(new Array(e-t.length),(n,o)=>o+t.length),s=[...t];return r.forEach(n=>s.splice(Math.floor(Math.random()*(s.length+1)),0,n)),s};var Co=L.make({processor:t=>`<span class="closet-shuffle">${t}</span>`,mapper:t=>`<span class="closet-shuffle__item">${t}</span>`,separator:'<span class="closet-shuffle__separator"></span>'}),Do=(t,e)=>()=>t.stylize(e),Bo=[E({sep:"||"})],ls=({tagname:t="mix",stylizer:e=Co,evaluate:r=Do,sortInStrategy:s=K,sequencer:n=Yt,optics:o=Bo}={})=>l=>{let u=(i,a)=>{let h=n(({values:d})=>d!=null?d:[],s)(i,a);if(h)return r(e,h)(i,a)};l.register(t,u,{optics:o})};var Po={priority:35,persistent:!0},$o=[E("::"),G(),E(",")],us=({tagname:t="ord",optics:e=$o,sortInStrategy:r=K}={})=>s=>{let n=(o,{deferred:l,cache:u,memory:i})=>{let a="sequences",c=new Set(u.get(a,[]));for(let[m,h]of o.values.entries()){let d=h.map(Q.make),f=`${o.key}:${o.fullOccur}:ord:${m}`,y=()=>{let x=Array.from(c).filter(C=>d.some(I=>I.checkTagIdentifier(C))?(c.delete(C),!0):!1),R=x.map(C=>`${C}:shuffle`);for(let[C,I]of x.entries()){let O=R[C],D=`${I}:waitingSet`;if(l.block(O),u.get(D,new Set).size!==0)continue;let Fe=R.reduce((g,b)=>{let T=i.get(b,[]);return g.length<T.length?T:g},[]),te=u.get(O,[]),p=r(u.get(f,Fe),te.length);u.fold(O,g=>Ke(g,p),[]),u.set(f,p),i.set(O,p)}c.size===0&&l.unregister(f)};l.register(f,y,Po)}return{ready:!0}};s.register(t,n,{optics:e})};var Oo=[E({sep:","})],cs=(t,e,r)=>({tagname:s="gen",uniqueConstraintId:n="uniq",optics:o=Oo}={})=>l=>{let u=`gen:${n}`,i=({values:a,fullOccur:c,num:m},{memory:h})=>{let[d=1,f=100,y=r]=a.length===1?[1,Number(a[0]),r]:a.map(Number),v=Number.isInteger(m)?`${u}:${m}`:u,x=`gen:${s}:${c}`;return{ready:!0,result:h.lazy(x,()=>{let I=dt(t(d,f),!0,Number.isInteger(m)?h.get(v,[]):[]).next();return I.done?"":e(I.value,y)})}};l.register(s,i,{optics:o})},ps=cs(ht,Qr,1),ms=cs(es,ts,2);var ds=()=>t=>{let e=(r,{path:s})=>s.join(":");t.register("tagpath",e),t.register("never",()=>{}),t.register("empty",()=>""),t.register("key",({key:r})=>r),t.register("stopIteration",({values:r},{filters:s})=>{let n=Number(r),o=s.getOrDefault("base");return s.register("base",(l,u)=>{var i;return u.iteration>=n?(i=l.text)!=null?i:"":o(l,u)}),{ready:!0}}),t.register("memorytest",(r,{memory:s})=>{let n="base:memorytest";return String(s.fold(n,o=>++o,0))})};var Mo=/%(.)/gu,Lo={optics:[E({sep:"::",max:2})],capture:!0},Go=t=>(e,r)=>{var n;let s=null;switch(r){case"%":return r;case"n":return typeof t.num=="number"?String(t.num):"";case"k":return t.key;case"f":return t.fullKey;default:return s=Number(r),Number.isNaN(s)?e:(n=t.values[s])!=null?n:""}},hs=(t={})=>e=>{let{tagname:r="def"}=t,s={optics:[E({sep:"::"})]},n=o=>{let[l,u]=o.values,i=a=>({result:u.replace(Mo,Go(a)),parse:!0});return e.register(l,i,s),{ready:!0}};e.register(r,n,Lo)};var _o={inlineOptics:[E({sep:"::",max:2})],capture:!0},gs=(t={})=>e=>{let{tagname:r="delim"}=t,s=(n,{template:o,isCapture:l})=>{if(l){let[u,i]=n.inlineValues;return o.parser.update({open:u,close:i}),{result:n.blockText,parse:!0}}return o.parser.update(),{result:n.innerNodes}};e.register(r,s,_o)};var lr={};_(lr,{behaviors:()=>nr,deciders:()=>gt,recipes:()=>gi});var gt={};_(gt,{isActive:()=>zo,isActiveAll:()=>tr,isActiveGetRange:()=>ys,isActiveOverwritten:()=>bs,isActiveWithinRange:()=>fs,isBack:()=>Ts,isBackAll:()=>rr});var fs=(t,e,r,s)=>t-r<=e&&e<=t+s,zo=({num:t},{preset:e})=>{switch(t){case null:return!1;case 0:return!0;default:return Object.prototype.hasOwnProperty.call(e,"cardNumber")?t===e.cardNumber:!1}},ys=({key:t,num:e,fullOccur:r},{preset:s,cache:n})=>{let o="flashcardActiveBottom",l="flashcardActiveTop",u=me(0),i=null,a=null;switch(e){case null:return!1;case 0:return!0;default:return typeof s.cardNumber!="number"?!1:(i=n.get(o,u).get(t,s.cardNumber,r),a=n.get(l,u).get(t,s.cardNumber,r),fs(s.cardNumber,e,i,a))}},bs=(t,e)=>{let r="flashcardActive";return e.cache.get(r,me(!1)).get(t.key,t.num,t.fullOccur)},tr=(t,e)=>bs(t,e)||ys(t,e),Ts=(t,{preset:e})=>e.side==="back",rr=Ts;var J=t=>Object.prototype.hasOwnProperty.call(t,"tagname")?[t.tagname]:[],Y=(t,e)=>ie(oe({},t),{tagname:e[0]}),xs="wrapped",sr=t=>(e,{wrapId:r,getTagnames:s,setTagnames:n}={wrapId:xs,getTagnames:J,setTagnames:Y})=>(o={})=>l=>{let u=s(o),i=h=>`${h}:${r}:internal`,a=new Map,c=u.map(h=>{let d=i(h);return a.set(h,d),d});e(n(o,c))(l);let m=(h,d)=>{let f=a.get(h.key);return t(Object.assign({},h,{keyInternal:f}),d),d.filters.getOrDefault(f)(h,d)};for(let h of u)l.register(h,m,l.getOptions(i(h)))},vs=t=>(e,r,s={},n={wrapId:xs,getTagnames:J,setTagnames:Y})=>sr((o,l)=>{t(l).registerIfNotExists(o.keyInternal,r,s)})(e,n),Ss=vs(t=>t.deferred),ks=vs(t=>t.aftermath);var ft=(t,e,r,{wrapId:s,setTagnames:n}={wrapId:"sum",getTagnames:J,setTagnames:Y})=>({tagname:o="sum",optionsFalse:l={},optionsTrue:u={}}={})=>i=>{let a=`${o}:${s}:false`,c=`${o}:${s}:true`;t(n(l,[a]))(i),e(n(u,[c]))(i);let m=(h,d)=>r(h,d)?d.filters.getOrDefault(c)(h,d):d.filters.getOrDefault(a)(h,d);i.register(o,m,i.getOptions(c))},yt=(t,e,r,s,n,o,{wrapId:l,setTagnames:u}={wrapId:"sumFour",getTagnames:J,setTagnames:Y})=>({tagname:i="sum",optionsZero:a={},optionsOne:c={},optionsTwo:m={},optionsThree:h={}}={})=>d=>{let f=`${i}:${l}:zero`,y=`${i}:${l}:two`;ft(t,e,n)({tagname:f,optionsFalse:u(a,[f]),optionsTrue:u(c,[f])})(d),ft(r,s,n)({tagname:y,optionsFalse:u(m,[y]),optionsTrue:u(h,[y])})(d);let v=(x,R)=>o(x,R)?R.filters.getOrDefault(y)(x,R):R.filters.getOrDefault(f)(x,R);d.register(i,v)};var bt=t=>e=>r=>{let s=e!=null?e:{};for(let[n,o={}]of t){let{setTagnames:l=Y,getTagnames:u=J}=o;n(l(s,u(s)))(r)}};var As=me(!1),Tt=me(0),Wo=t=>(e,r)=>(s,n)=>t(e,r)(s,n),Vo=t=>e=>(r,s)=>(n,o)=>{let l="flashcardShow",u="flashcardHide";return o.cache.get(l,As).get(n.key,n.num,n.fullOccur)?r(n,o):o.cache.get(u,As).get(n.key,n.num,n.fullOccur)?s(n,o):t(e)(r,s)(n,o)},Ho=t=>e=>(r,s)=>(n,o)=>{if(!Object.prototype.hasOwnProperty.call(o.preset,"cardNumber"))return t(e)(r,s)(n,o);let[l,u,i,a]=Uo(n,o),c=o.preset.cardNumber;return!c||!n.num?e(r,s)(n,o):c-l<=n.num&&n.num<=c+u?r(n,o):c-i<=n.num&&n.num<=c+a?s(n,o):t(e)(r,s)(n,o)},Uo=(t,{cache:e,preset:r})=>{let s="flashcardShowBottom",n="flashcardShowTop";if(!r.cardNumber)return[0,0,0,0];let o=e.get(s,Tt).get(t.key,r.cardNumber,t.fullOccur),l=e.get(n,Tt).get(t.key,r.cardNumber,t.fullOccur),u="flashcardHideBottom",i="flashcardHideTop",a=e.get(u,Tt).get(t.key,r.cardNumber,t.fullOccur),c=e.get(i,Tt).get(t.key,r.cardNumber,t.fullOccur);return[o,l,a,c]},Fs=Vo(Ho(Wo));var q=(t=tr,e=rr,r=Fs)=>(s,n)=>(o,l,u,i,a,c={})=>m=>{let h=`${o}:internal`;yt(Me(r(s)(i,a)),Me(l),Me(r(n)(i,a)),Me(u),t,e)({tagname:h})(m);let f=(y,v)=>v.filters.getOrDefault(h)(y,v);m.register(o,f,c)},dc=ye("[...]"),nr=(s=>(s.Show="show",s.Hide="hide",s.Reveal="reveal",s))(nr||{}),z=t=>{let e=t($,$),r=t(Xe,Xe),s=t(Xe,$),[n,o,l]=[["show","s"],["hide","h"],["reveal","r"]].map(([i,a])=>({getTagnames:c=>{var m,h;return[((m=c.defaultBehavior)!=null?m:"show")===i?c.tagname:(h=c.tagnameShow)!=null?h:`${c.tagname}${a}`]}})),u=bt([[r,o],[e,n],[s,l]]);return u.show=e,u.hide=r,u.reveal=s,u};var ws=t=>Array.isArray(t[0])?t[0].map((e,r)=>t.map(s=>s[r])):[t],Z=(t,e)=>(r,s)=>s.ready?t.stylize(...ws(e(r,s))):{ready:!1},ee=(t,e)=>(r,s)=>{if(!s.ready)return{ready:!1};let n=e(r,s);return n?t.stylize(...ws(n)):{ready:!1}};var qo=ye('<span class="closet-cloze is-inactive"><span class="closet-cloze__ellipsis"></span></span>'),Rs=t=>e=>`<span class="closet-cloze is-active is-${t}">${e}</span>`,jo=L.make({processor:Rs("front")}),Xo=L.make({processor:Rs("back")}),Ko=(t,e)=>{var r;return[`<span class="closet-cloze__hint">${(r=t.values[1])!=null?r:""}</span>`]},Es=t=>`<span class="closet-cloze__answer">${t.values[0]}</span>`,Jo=(t,{ready:e})=>({ready:e,result:`<span  class="closet-cloze is-inactive">${Es(t)}</span>`}),Yo=t=>[Es(t)],Qo=(t,e)=>(r={})=>{let{tagname:s="c",inactiveEllipser:n=qo,frontStylizer:o=jo,frontEllipser:l=Ko,backStylizer:u=Xo,backEllipser:i=Yo,optics:a=[E({sep:"::",max:2})],flashcardTemplate:c=q()}=r,m=Z(o,l),h=Z(u,i),d={optics:a};return c(t,e)(s,m,h,Jo,n,d)},Ns=z(Qo);var Zo=ye('<span class="closet-multiple-choice is-inactive"><span class="closet-multiple-choice__ellipsis"></span></span>'),ei=t=>t.values?t.values.flatMap((e,r)=>e.map(s=>[s,r])):[],ti=t=>t.values[0],or='<span class="closet-multiple-choice__separator"></span>',ri=L.make({processor:t=>`<span class="closet-multiple-choice is-inactive">${t}</span>`,mapper:t=>`<span class="closet-multiple-choice__item">${t}</span>`,separator:or}),Is=t=>e=>`<span class="closet-multiple-choice is-active is-${t}">${e}</span>`,si=L.make({processor:Is("front"),mapper:t=>`<span class="closet-multiple-choice__item closet-multiple-choice__option">${t}</span>`,separator:or}),ni=L.make({processor:Is("back"),mapper:(t,e,r)=>`<span class="closet-multiple-choice__item closet-multiple-choice__${r===0?"correct":"wrong"}">${t}</span>`,separator:or}),oi=[E({sep:"::"}),G(),E({sep:"||",keepEmpty:!1})],ii=(t,e)=>(r={})=>{let{tagname:s="mc",frontStylizer:n=si,backStylizer:o=ni,inactiveStylizer:l=ri,contexter:u=ti,ellipser:i=Zo,getValues:a=ei,sequence:c=Le,sortInStrategy:m=K,optics:h=oi,flashcardTemplate:d=q()}=r,f=c(a,m),y=ee(n,f),v=ee(o,f),x=d(t,e),R=Z(l,u);return x(s,y,v,R,i,{optics:h})},Cs=z(ii);var ir=t=>({result:t.values,parse:!0}),ai=()=>"",li=(t,e)=>(r={})=>{let{tagname:s="spec",flashcardTemplate:n=q()}=r,o={capture:!0};return n(t,e)(s,ir,ir,ir,ai,o)},Ds=z(li);var ui=(t,e)=>t.values,Bs=t=>e=>`<span class="closet-${t}__item">${e}</span>`,Ps=t=>`<span class="closet-${t}__separator"></span>`,ci=t=>()=>`<span class="closet-${t} is-inactive"><span class="closet-${t}__ellipsis"></span></span>`,pi=t=>L.make({processor:e=>`<span class="closet-${t} is-inactive">${e}</span>`,mapper:Bs(t),separator:Ps(t)}),mi=t=>L.make({processor:e=>`<span class="closet-${t} is-active">${e}</span>`,mapper:Bs(t),separator:Ps(t)}),di=t=>t.values?t.values:[],$s=(t,e)=>Z(t,ui),hi=[E({sep:"::"})],ar=(t,e,r)=>(s,n)=>(o={})=>{let{tagname:l="shuf",activeStylizer:u=mi(t),inactiveStylizer:i=pi(t),contexter:a=di,ellipser:c=ci(t),sequence:m=Le,sortInStrategy:h=K,optics:d=hi,flashcardTemplate:f=q()}=o,y={optics:d},v=m(a,h),x=e(u,v),R=r(u,v),C=Z(i,a);return f(s,n)(l,x,R,C,c,y)},Os=z(ar("mingle",ee,ee)),Ms=z(ar("sort",ee,$s)),Ls=z(ar("jumble",$s,ee));var gi={cloze:Ns,multipleChoice:Cs,specification:Ds,mingle:Os,sort:Ms,jumble:Ls};var hr={};_(hr,{recipes:()=>zi});var ur={};_(ur,{key:()=>Gt,keySeparation:()=>X,unicodeAlphanumericPattern:()=>bi,unicodeLetterPattern:()=>fi,unicodeNumberPattern:()=>yi});var Gs="A-Za-z\\xAA\\xB5\\xBA\\xC0-\\xD6\\xD8-\\xF6\\xF8-\\u02C1\\u02C6-\\u02D1\\u02E0-\\u02E4\\u02EC\\u02EE\\u0370-\\u0374\\u0376\\u0377\\u037A-\\u037D\\u037F\\u0386\\u0388-\\u038A\\u038C\\u038E-\\u03A1\\u03A3-\\u03F5\\u03F7-\\u0481\\u048A-\\u052F\\u0531-\\u0556\\u0559\\u0561-\\u0587\\u05D0-\\u05EA\\u05F0-\\u05F2\\u0620-\\u064A\\u066E\\u066F\\u0671-\\u06D3\\u06D5\\u06E5\\u06E6\\u06EE\\u06EF\\u06FA-\\u06FC\\u06FF\\u0710\\u0712-\\u072F\\u074D-\\u07A5\\u07B1\\u07CA-\\u07EA\\u07F4\\u07F5\\u07FA\\u0800-\\u0815\\u081A\\u0824\\u0828\\u0840-\\u0858\\u08A0-\\u08B4\\u08B6-\\u08BD\\u0904-\\u0939\\u093D\\u0950\\u0958-\\u0961\\u0971-\\u0980\\u0985-\\u098C\\u098F\\u0990\\u0993-\\u09A8\\u09AA-\\u09B0\\u09B2\\u09B6-\\u09B9\\u09BD\\u09CE\\u09DC\\u09DD\\u09DF-\\u09E1\\u09F0\\u09F1\\u0A05-\\u0A0A\\u0A0F\\u0A10\\u0A13-\\u0A28\\u0A2A-\\u0A30\\u0A32\\u0A33\\u0A35\\u0A36\\u0A38\\u0A39\\u0A59-\\u0A5C\\u0A5E\\u0A72-\\u0A74\\u0A85-\\u0A8D\\u0A8F-\\u0A91\\u0A93-\\u0AA8\\u0AAA-\\u0AB0\\u0AB2\\u0AB3\\u0AB5-\\u0AB9\\u0ABD\\u0AD0\\u0AE0\\u0AE1\\u0AF9\\u0B05-\\u0B0C\\u0B0F\\u0B10\\u0B13-\\u0B28\\u0B2A-\\u0B30\\u0B32\\u0B33\\u0B35-\\u0B39\\u0B3D\\u0B5C\\u0B5D\\u0B5F-\\u0B61\\u0B71\\u0B83\\u0B85-\\u0B8A\\u0B8E-\\u0B90\\u0B92-\\u0B95\\u0B99\\u0B9A\\u0B9C\\u0B9E\\u0B9F\\u0BA3\\u0BA4\\u0BA8-\\u0BAA\\u0BAE-\\u0BB9\\u0BD0\\u0C05-\\u0C0C\\u0C0E-\\u0C10\\u0C12-\\u0C28\\u0C2A-\\u0C39\\u0C3D\\u0C58-\\u0C5A\\u0C60\\u0C61\\u0C80\\u0C85-\\u0C8C\\u0C8E-\\u0C90\\u0C92-\\u0CA8\\u0CAA-\\u0CB3\\u0CB5-\\u0CB9\\u0CBD\\u0CDE\\u0CE0\\u0CE1\\u0CF1\\u0CF2\\u0D05-\\u0D0C\\u0D0E-\\u0D10\\u0D12-\\u0D3A\\u0D3D\\u0D4E\\u0D54-\\u0D56\\u0D5F-\\u0D61\\u0D7A-\\u0D7F\\u0D85-\\u0D96\\u0D9A-\\u0DB1\\u0DB3-\\u0DBB\\u0DBD\\u0DC0-\\u0DC6\\u0E01-\\u0E30\\u0E32\\u0E33\\u0E40-\\u0E46\\u0E81\\u0E82\\u0E84\\u0E87\\u0E88\\u0E8A\\u0E8D\\u0E94-\\u0E97\\u0E99-\\u0E9F\\u0EA1-\\u0EA3\\u0EA5\\u0EA7\\u0EAA\\u0EAB\\u0EAD-\\u0EB0\\u0EB2\\u0EB3\\u0EBD\\u0EC0-\\u0EC4\\u0EC6\\u0EDC-\\u0EDF\\u0F00\\u0F40-\\u0F47\\u0F49-\\u0F6C\\u0F88-\\u0F8C\\u1000-\\u102A\\u103F\\u1050-\\u1055\\u105A-\\u105D\\u1061\\u1065\\u1066\\u106E-\\u1070\\u1075-\\u1081\\u108E\\u10A0-\\u10C5\\u10C7\\u10CD\\u10D0-\\u10FA\\u10FC-\\u1248\\u124A-\\u124D\\u1250-\\u1256\\u1258\\u125A-\\u125D\\u1260-\\u1288\\u128A-\\u128D\\u1290-\\u12B0\\u12B2-\\u12B5\\u12B8-\\u12BE\\u12C0\\u12C2-\\u12C5\\u12C8-\\u12D6\\u12D8-\\u1310\\u1312-\\u1315\\u1318-\\u135A\\u1380-\\u138F\\u13A0-\\u13F5\\u13F8-\\u13FD\\u1401-\\u166C\\u166F-\\u167F\\u1681-\\u169A\\u16A0-\\u16EA\\u16F1-\\u16F8\\u1700-\\u170C\\u170E-\\u1711\\u1720-\\u1731\\u1740-\\u1751\\u1760-\\u176C\\u176E-\\u1770\\u1780-\\u17B3\\u17D7\\u17DC\\u1820-\\u1877\\u1880-\\u1884\\u1887-\\u18A8\\u18AA\\u18B0-\\u18F5\\u1900-\\u191E\\u1950-\\u196D\\u1970-\\u1974\\u1980-\\u19AB\\u19B0-\\u19C9\\u1A00-\\u1A16\\u1A20-\\u1A54\\u1AA7\\u1B05-\\u1B33\\u1B45-\\u1B4B\\u1B83-\\u1BA0\\u1BAE\\u1BAF\\u1BBA-\\u1BE5\\u1C00-\\u1C23\\u1C4D-\\u1C4F\\u1C5A-\\u1C7D\\u1C80-\\u1C88\\u1CE9-\\u1CEC\\u1CEE-\\u1CF1\\u1CF5\\u1CF6\\u1D00-\\u1DBF\\u1E00-\\u1F15\\u1F18-\\u1F1D\\u1F20-\\u1F45\\u1F48-\\u1F4D\\u1F50-\\u1F57\\u1F59\\u1F5B\\u1F5D\\u1F5F-\\u1F7D\\u1F80-\\u1FB4\\u1FB6-\\u1FBC\\u1FBE\\u1FC2-\\u1FC4\\u1FC6-\\u1FCC\\u1FD0-\\u1FD3\\u1FD6-\\u1FDB\\u1FE0-\\u1FEC\\u1FF2-\\u1FF4\\u1FF6-\\u1FFC\\u2071\\u207F\\u2090-\\u209C\\u2102\\u2107\\u210A-\\u2113\\u2115\\u2119-\\u211D\\u2124\\u2126\\u2128\\u212A-\\u212D\\u212F-\\u2139\\u213C-\\u213F\\u2145-\\u2149\\u214E\\u2183\\u2184\\u2C00-\\u2C2E\\u2C30-\\u2C5E\\u2C60-\\u2CE4\\u2CEB-\\u2CEE\\u2CF2\\u2CF3\\u2D00-\\u2D25\\u2D27\\u2D2D\\u2D30-\\u2D67\\u2D6F\\u2D80-\\u2D96\\u2DA0-\\u2DA6\\u2DA8-\\u2DAE\\u2DB0-\\u2DB6\\u2DB8-\\u2DBE\\u2DC0-\\u2DC6\\u2DC8-\\u2DCE\\u2DD0-\\u2DD6\\u2DD8-\\u2DDE\\u2E2F\\u3005\\u3006\\u3031-\\u3035\\u303B\\u303C\\u3041-\\u3096\\u309D-\\u309F\\u30A1-\\u30FA\\u30FC-\\u30FF\\u3105-\\u312D\\u3131-\\u318E\\u31A0-\\u31BA\\u31F0-\\u31FF\\u3400-\\u4DB5\\u4E00-\\u9FD5\\uA000-\\uA48C\\uA4D0-\\uA4FD\\uA500-\\uA60C\\uA610-\\uA61F\\uA62A\\uA62B\\uA640-\\uA66E\\uA67F-\\uA69D\\uA6A0-\\uA6E5\\uA717-\\uA71F\\uA722-\\uA788\\uA78B-\\uA7AE\\uA7B0-\\uA7B7\\uA7F7-\\uA801\\uA803-\\uA805\\uA807-\\uA80A\\uA80C-\\uA822\\uA840-\\uA873\\uA882-\\uA8B3\\uA8F2-\\uA8F7\\uA8FB\\uA8FD\\uA90A-\\uA925\\uA930-\\uA946\\uA960-\\uA97C\\uA984-\\uA9B2\\uA9CF\\uA9E0-\\uA9E4\\uA9E6-\\uA9EF\\uA9FA-\\uA9FE\\uAA00-\\uAA28\\uAA40-\\uAA42\\uAA44-\\uAA4B\\uAA60-\\uAA76\\uAA7A\\uAA7E-\\uAAAF\\uAAB1\\uAAB5\\uAAB6\\uAAB9-\\uAABD\\uAAC0\\uAAC2\\uAADB-\\uAADD\\uAAE0-\\uAAEA\\uAAF2-\\uAAF4\\uAB01-\\uAB06\\uAB09-\\uAB0E\\uAB11-\\uAB16\\uAB20-\\uAB26\\uAB28-\\uAB2E\\uAB30-\\uAB5A\\uAB5C-\\uAB65\\uAB70-\\uABE2\\uAC00-\\uD7A3\\uD7B0-\\uD7C6\\uD7CB-\\uD7FB\\uF900-\\uFA6D\\uFA70-\\uFAD9\\uFB00-\\uFB06\\uFB13-\\uFB17\\uFB1D\\uFB1F-\\uFB28\\uFB2A-\\uFB36\\uFB38-\\uFB3C\\uFB3E\\uFB40\\uFB41\\uFB43\\uFB44\\uFB46-\\uFBB1\\uFBD3-\\uFD3D\\uFD50-\\uFD8F\\uFD92-\\uFDC7\\uFDF0-\\uFDFB\\uFE70-\\uFE74\\uFE76-\\uFEFC\\uFF21-\\uFF3A\\uFF41-\\uFF5A\\uFF66-\\uFFBE\\uFFC2-\\uFFC7\\uFFCA-\\uFFCF\\uFFD2-\\uFFD7\\uFFDA-\\uFFDC",_s="0-9\\xB2\\xB3\\xB9\\xBC-\\xBE\\u0660-\\u0669\\u06F0-\\u06F9\\u07C0-\\u07C9\\u0966-\\u096F\\u09E6-\\u09EF\\u09F4-\\u09F9\\u0A66-\\u0A6F\\u0AE6-\\u0AEF\\u0B66-\\u0B6F\\u0B72-\\u0B77\\u0BE6-\\u0BF2\\u0C66-\\u0C6F\\u0C78-\\u0C7E\\u0CE6-\\u0CEF\\u0D58-\\u0D5E\\u0D66-\\u0D78\\u0DE6-\\u0DEF\\u0E50-\\u0E59\\u0ED0-\\u0ED9\\u0F20-\\u0F33\\u1040-\\u1049\\u1090-\\u1099\\u1369-\\u137C\\u16EE-\\u16F0\\u17E0-\\u17E9\\u17F0-\\u17F9\\u1810-\\u1819\\u1946-\\u194F\\u19D0-\\u19DA\\u1A80-\\u1A89\\u1A90-\\u1A99\\u1B50-\\u1B59\\u1BB0-\\u1BB9\\u1C40-\\u1C49\\u1C50-\\u1C59\\u2070\\u2074-\\u2079\\u2080-\\u2089\\u2150-\\u2182\\u2185-\\u2189\\u2460-\\u249B\\u24EA-\\u24FF\\u2776-\\u2793\\u2CFD\\u3007\\u3021-\\u3029\\u3038-\\u303A\\u3192-\\u3195\\u3220-\\u3229\\u3248-\\u324F\\u3251-\\u325F\\u3280-\\u3289\\u32B1-\\u32BF\\uA620-\\uA629\\uA6E6-\\uA6EF\\uA830-\\uA835\\uA8D0-\\uA8D9\\uA900-\\uA909\\uA9D0-\\uA9D9\\uA9F0-\\uA9F9\\uAA50-\\uAA59\\uABF0-\\uABF9\\uFF10-\\uFF19",fi=new RegExp(`[${Gs}]`,"gu"),yi=new RegExp(`[${_s}]`,"gu"),bi=new RegExp(`[${Gs}${_s}]`,"gu");var Ti=/<img[^>]*?src="(.+?)"[^>]*>/g,xi=(t,e)=>{let r=[],s;do s=Ti.exec(t),s&&r.push([s[1],e]);while(s);return r},xt=t=>{let e=([r,s])=>typeof s=="string"?[]:xi(r,s.getRootNode());return t.textFragments.map((r,s)=>[r,t.inputs[s]]).flatMap(e)},de=t=>{if(navigator.userAgent.search("Chrome")>=0)return[t.offsetX,t.offsetY];{let e=t.currentTarget,r=e.getBoundingClientRect(),s=e.parentElement.getBoundingClientRect(),n=t.layerX-(s.left-r.left),o=t.layerY-(s.top-r.top);return[n,o]}},vt=(t,e,r)=>{let s=e.querySelector(t);s&&(s.complete?r({target:s}):s.addEventListener("load",r))},zs=t=>{let e=0;for(let r of t){let s=r.match(X);if(!s)continue;let n=Number(s[2]);Number.isNaN(n)||(e=Math.max(e,n))}return e},St="occlusionSvgCss",kt=`
img {
  max-width: 100% !important;
}

.closet-occlusion-container {
  display: inline-block;
  position: relative;
}

.closet-occlusion-container > * {
  display: block;

  margin-left: auto;
  margin-right: auto;
}

.closet-occlusion-container > svg {
  position: absolute;
  top: 0;
}

.closet-shape > text {
  text-anchor: middle;
  dominant-baseline: central;
  pointer-events: none;
}`;var At="http://www.w3.org/2000/svg",Ae=class t{constructor(e,r,s){this.scaleFactorX=1;this.scaleFactorY=1;this.maxOcclusions=500;this.elements=[];this.container=e,this.image=r,this.svg=s,this.resizer=new globalThis.ResizeObserver(()=>this.resize()),this.resizer.observe(r),this.setScaleFactors()}setScaleFactors(){this.scaleFactorX=this.image.width/this.image.naturalWidth,this.scaleFactorY=this.image.height/this.image.naturalHeight}static wrapImage(e){let r=document.createElement("div");e.parentNode&&e.parentNode.replaceChild(r,e),r.appendChild(e);let s=document.createElementNS(At,"svg");s.setAttributeNS(null,"width","100%"),s.setAttributeNS(null,"height","100%");let n=window.getComputedStyle(e);return s.style.zoom=n.getPropertyValue("zoom"),s.style.transform=n.getPropertyValue("transform"),r.appendChild(s),r.classList.add("closet-occlusion-container"),new t(r,e,s)}get scaleFactors(){return[this.scaleFactorX,this.scaleFactorY]}resize(){if(this.setScaleFactors(),this.scaleFactors.includes(0)){this.resizer.disconnect();return}for(let e of this.elements)e.resize(this)}append(e){this.elements.push(e);for(let r of e.getElements())this.svg.appendChild(r)}getElements(){return this.elements}getLabels(){return this.getElements().map(e=>e.getLabel())}remove(e){this.elements.find((r,s)=>{if(r.getAnchorElement()===e.getAnchorElement()){for(let n of e.getElements())n.remove();return this.elements.splice(s,1),!0}})}setMaxOcclusions(e){this.maxOcclusions=e}getNextNum(e){let r=e.altKey?0:1,s=Math.max(1,zs(this.getLabels())+r);return s>this.maxOcclusions?0:s}cleanup(){let e=this.container.removeChild(this.image);this.container.replaceWith(e)}},he=class t{constructor(e,r,s,n,o){this.scaleFactorX=1;this.scaleFactorY=1;this.container=e,this.rect=r,this.label=s,this.setScaleFactors(n,o)}static make(e){let r=document.createElementNS(At,"svg"),s=document.createElementNS(At,"rect"),n=document.createElementNS(At,"text");r.appendChild(s),r.appendChild(n),r.classList.add("closet-rect"),r.classList.add("closet-shape"),r.tabIndex=-1;let[o,l]=e?e.scaleFactors:[1,1];return new t(r,s,n,o,l)}static wrap(e,r){let[s,n]=r?r.scaleFactors:[1,1];return new t(e.parentElement,e,e.nextSibling,s,n)}remove(){this.container.remove()}getElements(){return[this.container]}getAnchorElement(){return this.rect}getLabel(){return this.labelText}setScaleFactors(e,r){this.scaleFactorX=e,this.scaleFactorY=r}readjust(e){let r=e?e.scaleFactors:[1,1],s=this.scaleFactorX,n=this.scaleFactorY;return this.setScaleFactors(r[0],r[1]),[s,n]}resize(e){let r=this.pos;this.readjust(e),this.pos=r}toDefinition(){return["rect",void 0,this.labelText,this.x,this.y,this.width,this.height,{}]}toText(e){return`${e.open}${this.labelText}${e.sep}${this.x.toFixed()},${this.y.toFixed()},${this.width.toFixed()},${this.height.toFixed()}${e.close}`}fontSizeUpdate(){let[e,r]=this.readjust(),s=Math.max(.1,Math.min(32,.4*((this.width+this.height)/2-2*this.strokeWidth)));this.fontSize=s,this.setScaleFactors(e,r)}get pos(){return[this.x,this.y,this.width,this.height]}set pos([e,r,s,n]){this.width=s,this.height=n,this.x=e,this.y=r}get scaled(){return[Number(this.rect.getAttributeNS(null,"x")),Number(this.rect.getAttributeNS(null,"y")),Number(this.rect.getAttributeNS(null,"width")),Number(this.rect.getAttributeNS(null,"height"))]}get x(){return Number(this.rect.getAttributeNS(null,"x"))/this.scaleFactorX}set x(e){let r=e*this.scaleFactorX,s=(e+this.width/2)*this.scaleFactorX;this.rect.setAttributeNS(null,"x",String(r)),this.label.setAttributeNS(null,"x",String(s))}get y(){return Number(this.rect.getAttributeNS(null,"y"))/this.scaleFactorY}set y(e){let r=e*this.scaleFactorY,s=(e+this.height/2)*this.scaleFactorY;this.rect.setAttributeNS(null,"y",String(r)),this.label.setAttributeNS(null,"y",String(s))}get width(){return Number(this.rect.getAttributeNS(null,"width"))/this.scaleFactorX}set width(e){let r=String(Math.max(10,e)*this.scaleFactorX);this.rect.setAttributeNS(null,"width",r),this.label.setAttributeNS(null,"width",r),this.fontSizeUpdate()}get height(){return Number(this.rect.getAttributeNS(null,"height"))/this.scaleFactorY}set height(e){let r=String(Math.max(10,e)*this.scaleFactorY);this.rect.setAttributeNS(null,"height",r),this.label.setAttributeNS(null,"height",r),this.fontSizeUpdate()}props(e){for(let r in e){let s=r;this.prop(s,e[s])}}prop(e,r){this[e]=r}set containerClasses(e){e.split(" ").forEach(r=>this.container.classList.add(r))}get containerClasses(){return Array.from(this.container.className).join(" ")}set rx(e){this.rect.setAttributeNS(null,"rx",String(e))}get rx(){return Number(this.rect.getAttributeNS(null,"rx"))}set ry(e){this.rect.setAttributeNS(null,"ry",String(e))}get ry(){return Number(this.rect.getAttributeNS(null,"ry"))}set fill(e){this.rect.setAttributeNS(null,"fill",e)}get fill(){var e;return(e=this.rect.getAttributeNS(null,"fill"))!=null?e:""}set fillOpacity(e){this.rect.setAttributeNS(null,"fill-opacity",String(e))}get fillOpacity(){return Number(this.rect.getAttributeNS(null,"fill-opacity"))}set stroke(e){this.rect.setAttributeNS(null,"stroke",e)}get stroke(){var e;return(e=this.rect.getAttributeNS(null,"stroke"))!=null?e:""}set strokeOpacity(e){this.rect.setAttributeNS(null,"stroke-opacity",String(e))}get strokeOpacity(){return Number(this.rect.getAttributeNS(null,"stroke-opacity"))}set strokeWidth(e){this.rect.setAttributeNS(null,"stroke-width",String(e))}get strokeWidth(){return Number(this.rect.getAttributeNS(null,"stroke-width"))}set classes(e){e.split(" ").forEach(r=>this.rect.classList.add(r))}get classes(){return Array.from(this.rect.classList).join(" ")}set labelText(e){this.label.innerHTML=e}get labelText(){return this.label.innerHTML}set fontSize(e){this.label.setAttributeNS(null,"font-size",String(e))}get fontSize(){return Number(this.label.getAttributeNS(null,"font-size"))}set labelClasses(e){e.split(" ").forEach(r=>this.label.classList.add(r))}get labelClasses(){return Array.from(this.label.classList).join(" ")}};var cr=(t,e,r,s,n,o,l,u)=>i=>{let[a,c]=t(de(i));r&&a<l?(e.x=a,e.width=l-a):s&&(e.x=l,e.width=a-l),n&&c<u?(e.y=c,e.height=u-c):o&&(e.y=u,e.height=c-u)},Ws=(t,e,r,s,n,o)=>l=>{let[u,i]=t(de(l)),a=r+(u-n),c=s+(i-o);e.x=a,e.y=c},Vs=(t,e,r,s,n,o,l,u,i)=>(a,c,m)=>{let[d,f,y,v]=a.scaled,x=c-d,R=d+y-c,C=m-f,I=f+v-m;return x<=5?C<=5?t(a):I<=5?e(a):r(a):R<=5?C<=5?s(a):I<=5?n(a):o(a):C<=5?l(a):I<=5?u(a):i(a)},Hs=Vs(t=>[!0,!1,!0,!1,t.x+t.width,t.y+t.height],t=>[!0,!1,!1,!0,t.x+t.width,t.y],t=>[!0,!1,!1,!1,t.x+t.width,0],t=>[!1,!0,!0,!1,t.x,t.y+t.height],t=>[!1,!0,!1,!0,t.x,t.y],t=>[!1,!0,!1,!1,t.x,0],t=>[!1,!1,!0,!1,0,t.y+t.height],t=>[!1,!1,!1,!0,0,t.y],()=>[!1,!1,!1,!1,0,0]),vi=Vs(()=>"nwse-resize",()=>"nesw-resize",()=>"ew-resize",()=>"nesw-resize",()=>"nwse-resize",()=>"ew-resize",()=>"ns-resize",()=>"ns-resize",()=>"move"),Us=(t,e)=>r=>{if(r.shiftKey)e.rect.style.cursor="no-drop";else{let[s,n]=t(de(r)),o=vi(e,s,n);e.rect.style.cursor=o}};var Si=t=>([e,r])=>{let s=t.getPropertyValue("zoom"),n=Number(s);return Number.isNaN(n)||n<=0?[e,r]:[e/n,r/n]},Ft=t=>([e,r])=>Si(t)([e,r]);var ki=t=>{let e=document.createElement("li"),r=document.createElement("a");return t.html?r.innerHTML=t.label:r.innerText=t.label,r.id=t.itemId,r.classList.add("context-menu-item"),t.clickEvent&&r.addEventListener("click",t.clickEvent),e.appendChild(r),t.sub&&t.sub.length>0&&e.appendChild(qs(t.sub)),e},qs=t=>{let e=document.createElement("ul"),r=t.map(ki);for(let s of r)e.appendChild(s);return e},js=(t,e)=>{let r=document.createElement("nav");return r.classList.add("context-menu"),r.id=t,r.appendChild(qs(e)),r};var Xs=`
:root {
  --cm-niceblue: #3f8cf1;
  --cm-nicegray: #444;
  --cm-backgray: #ececec;
  --cm-boxgray: #cfcfcf;
}

nav.context-menu {
  position: absolute;
  z-index: 9999;
  display: none;
}

nav.context-menu--active {
  display: block;
}

/******************** UL */

nav.context-menu ul {
  position: absolute;

  padding: 0.2rem 0;
  width: 10rem;

  white-space: nowrap;
  list-style: none;

  background-color: var(--cm-backgray);
  border: solid 1px var(--cm-boxgray);
  box-shadow: 1px 1px 2px var(--cm-boxgray);
}

/******************** LI */

nav.context-menu li {
  margin-bottom: 2px;
}

nav.context-menu li.context-menu--hover {
  background-color: var(--cm-niceblue);
}

nav.context-menu li:last-child {
  margin-bottom: 0;
}

nav.context-menu li ul {
  display: none;
  margin-left: 2rem;
}

nav.context-menu li.context-menu--hover ul {
  display: block;
}

nav.context-menu li li ul {
  display: none;
  margin-left: 4rem;
}

nav.context-menu li li.context-menu--hover ul {
  display: block;
}

/******************** A */

nav.context-menu a {
  display: block;
  padding: 0.3rem 1rem;
  user-select: none;

  color: var(--cm-nicegray);
}

nav.context-menu li.context-menu--hover a {
  color: white;
}
`,Ks=t=>()=>{t.classList.remove("context-menu--active")},Ai=(t,e,r)=>{t.style.left=`${e}px`,t.style.top=`${r}px`},Fi=t=>{t.addEventListener("click",e=>{e.stopPropagation()}),t.querySelectorAll("li").forEach(e=>{e.addEventListener("mouseenter",()=>{e.classList.add("context-menu--hover")}),e.addEventListener("mouseleave",()=>{e.classList.remove("context-menu--hover")}),e.addEventListener("click",()=>{Ks(t)()})})},pr=(t,e)=>{let r=Ks(t);e.addEventListener("contextmenu",s=>{s.preventDefault(),s.stopPropagation(),document.querySelectorAll(".context-menu--active").forEach(n=>n.classList.remove("context-menu--active")),t.classList.add("context-menu--active"),window.addEventListener("click",r,{once:!0}),Ai(t,s.pageX,s.pageY)})},mr=(t,e)=>{let r=js(t,e);return document.body.insertAdjacentElement("beforeend",r),Fi(r),r};var Rt="occlusionRenderRect",wi=(t,{template:e,cache:r})=>{let s=xt(e),n=r.get(t.keyword,[]),o=s[0];o&&vt(`img[src="${o[0]}"]`,o[1],l=>{e.appendStyle(l.target,St,kt);let i=Ae.wrapImage(l.target);for(let[,a,,c,m,h,d,f]of n){if(!a)continue;let y=he.make(i);`${c}${m}${h}${d}`,y.pos=[c,m,h,d];for(let v in f){let x=v;y.prop(x,f[x])}i.append(y)}})},Ri=(t,e={})=>{let r={};return t.map(s=>s.split("=")).forEach(([s,n])=>r[s]=n),Object.assign(r,e)},wt=t=>(e,r)=>{let[s=0,n=0,o=50,l=o,...u]=e.values,i=typeof t=="function"?t(e,r):t;return r.cache.over(Rt,a=>a.push(["rect",!0,e.fullKey,Number(s),Number(n),Number(o),Number(l),Ri(u,i)]),[]),r.aftermath.registerIfNotExists(Rt,wi),{ready:!0}},dr={classes:"closet-rect__rect",labelClasses:"closet-rect__label"},Ei={classes:"closet-rect__ellipsis",labelClasses:"closet-rect__ellipsis"},Ni="is-active is-front",Ii="is-active is-back",Js="is-inactive",Ci=(t,e)=>(r={})=>{let{tagname:s="rect",front:n=wt,back:o=wt,optics:l=[E({sep:","})],flashcardTemplate:u=q(),frontProperties:i=ie(oe({},dr),{containerClasses:Ni}),backProperties:a=ie(oe({},dr),{containerClasses:Ii}),ellipseProperties:c=ie(oe({},Ei),{containerClasses:Js}),contextProperties:m=ie(oe({},dr),{containerClasses:Js})}=r,h={optics:l};return u(t,e)(s,n(i),o(a),wt(c),wt(m),h)},Ys=z(Ci);var Di=(t,e)=>{let r=he.wrap(e.target);if(e.shiftKey){t.remove(r);return}let s=Ft(window.getComputedStyle(t.image)),[n,o]=s(de(e)),l=Hs(r,n,o),u=l.includes(!0)?cr(s,r,...l):Ws(s,r,r.x,r.y,n,o);t.svg.addEventListener("mousemove",u),t.svg.addEventListener("mouseup",i=>{i.preventDefault(),t.svg.removeEventListener("mousemove",u)},{once:!0})},Zs=(t,e)=>{let r=Ft(window.getComputedStyle(t.image));e.rect.addEventListener("mousemove",Us(r,e));let s=mr("occlusion-shape-menu",[{label:"Change Label",itemId:"change-label",clickEvent:()=>{let n=prompt("Specify the new label",e.labelText);typeof n=="string"&&(e.labelText=n)}},{label:"Close Menu",itemId:"close-occlusion-menu"}]);pr(s,e.rect),t.append(e)},en=(t,e,r,s,n)=>{let o=he.make();return o.pos=[t,e,r,s],o.labelText=n,o.classes="closet-rect__rect",o.labelClasses="closet-rect__label",o},Bi=(t,e)=>{let r=null,s=null,n=null,o=null,l=null,u=null,[i,,...a]=e;switch(i){case"rect":[r,s,n,o,l]=a,u=en(s,n,o,l,r),Zs(t,u);break;default:}},Pi=(t,e)=>{let r=Ft(window.getComputedStyle(t.image)),[s,n]=r(de(e)),o=t.getNextNum(e),l=en(s,n,0,0,`rect${o}`);Zs(t,l);let u=cr(r,l,!0,!0,!0,!0,s,n);t.svg.addEventListener("mousemove",u),t.svg.addEventListener("mouseup",()=>{t.svg.removeEventListener("mousemove",u),l.readjust(t)})},$i=(t,e)=>{e.preventDefault(),(e.target.nodeName!=="svg"?Di:Pi)(t,e)},Oi=(t,e)=>{let s=e([{label:"Accept occlusions",itemId:"occlusion-accept",clickEvent:n=>{n.preventDefault(),t.dispatchEvent(new Event("accept"))}},{label:"Close Menu",itemId:"close-occlusion-menu"}]);return mr("occlusion-menu",s)},Mi=(t,e)=>{let r=s=>{s.button===0&&$i(t,s)};t.svg.addEventListener("mousedown",r),pr(e,t.svg)},Li=(t,e)=>r=>{navigator.clipboard.writeText(r.map(s=>s.toText(e.template.parser.delimiters)).join(`
`)).catch(()=>console.log("Window needs active focus for copying to clipboard"))},Gi=()=>(t,e)=>e.cleanup(),_i=`
.closet-occlusion-container {
  outline: 3px dotted hotpink;
  outline-offset: -3px;
}`,Qs="occlusionMakerCss",tn=(t={})=>e=>{let r="makeOcclusions",s=new EventTarget,{tagname:n=r,maxOcclusions:o=500,acceptHandler:l=Li,rejectHandler:u=Gi,setupOcclusionMenu:i=$,existingShapesFilter:a=()=>$,shapeKeywords:c=[Rt]}=t,m=(h,d)=>{let f=d.template,y=xt(f);return d.aftermath.registerIfNotExists(r,(v,x)=>{let R=[];for(let I of c){let O=x.cache.get(I,[]);R.push(...O),x.aftermath.block(I)}let C=I=>{let O=I.target,D=x.template;D.appendDocumentStyle(Qs,Xs),D.appendStyle(O,Qs,_i),D.appendStyle(O,St,kt);let W=Ae.wrapImage(O);W.setMaxOcclusions(o),a(v,x)(R,W).forEach(g=>Bi(W,g));let Fe=()=>{l(v,x)(W.getElements(),W)},te=()=>{u(v,x)(W.getElements(),W)};s.addEventListener("accept",Fe),s.addEventListener("reject",te);let p=Oi(s,i);Mi(W,p)};for(let[I,O]of y)vt(`img[src="${I}"]`,O,C)},{priority:100}),{ready:!0}};return e.register(n,m),s};var zi={occlusionEditor:tn,rect:Ys};var gr={};_(gr,{aftermath:()=>ks,collection:()=>bt,deferred:()=>Ss,product:()=>rn,sum:()=>ft,sumFour:()=>yt,wrap:()=>sr});var rn=(t,e,r=()=>()=>({ready:!0}),{wrapId:s,setTagnames:n}={wrapId:"product",getTagnames:J,setTagnames:Y})=>({tagname:o="prod",optionsFirst:l={},optionsSecond:u={}}={})=>i=>{let a=`${o}:${s}:fst`,c=`${o}:${s}:snd`;t(n(l,[a]))(i),e(n(u,[c]))(i);let m=(h,d)=>r(d.filters.getOrDefault(a)(h,d),d.filters.getOrDefault(c)(h,d))(h,d);i.register(o,m,i.getOptions(a))};export{vr as FilterManager,L as Stylizer,hr as browser,lr as flashcard,ur as patterns,er as recipes,Qt as sequencers,Zt as sortInStrategies,Ut as template,gr as wrappers};
